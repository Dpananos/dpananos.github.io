<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Demetri Pananos">
<meta name="dcterms.date" content="2022-11-16">

<title>Demetri Pananos Ph.D - Bootstrapping in SQL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Demetri Pananos Ph.D - Bootstrapping in SQL">
<meta property="og:description" content="Remember the “Double Down” from KFC? It was bacon and cheese sandwiched between two deep fried pieces of chicken.">
<meta property="og:site-name" content="Demetri Pananos Ph.D">
<meta name="twitter:title" content="Demetri Pananos Ph.D - Bootstrapping in SQL">
<meta name="twitter:description" content="Remember the “Double Down” from KFC? It was bacon and cheese sandwiched between two deep fried pieces of chicken.">
<meta name="twitter:creator" content="@PhDemetri">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Demetri Pananos Ph.D</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../consulting/index.html">
 <span class="menu-text">Consulting</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Dpananos"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/PhDemetri"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bootstrapping in SQL</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Statistics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Demetri Pananos </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 16, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Sections</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#bootstrapping-in-sql.-no-really." id="toc-bootstrapping-in-sql.-no-really." class="nav-link" data-scroll-target="#bootstrapping-in-sql.-no-really.">Bootstrapping in SQL. No, Really.</a>
  <ul class="collapse">
  <li><a href="#query-to-make-strap_id" id="toc-query-to-make-strap_id" class="nav-link" data-scroll-target="#query-to-make-strap_id">Query To Make <code>strap_id</code></a></li>
  <li><a href="#query-to-make-original_data_rownum" id="toc-query-to-make-original_data_rownum" class="nav-link" data-scroll-target="#query-to-make-original_data_rownum">Query To Make <code>original_data_rownum</code></a></li>
  <li><a href="#query-to-make-bootstrap_rownum" id="toc-query-to-make-bootstrap_rownum" class="nav-link" data-scroll-target="#query-to-make-bootstrap_rownum">Query To Make <code>bootstrap_rownum</code></a></li>
  </ul></li>
  <li><a href="#actually-doing-the-bootstrapping-its-just-a-left-join" id="toc-actually-doing-the-bootstrapping-its-just-a-left-join" class="nav-link" data-scroll-target="#actually-doing-the-bootstrapping-its-just-a-left-join">Actually Doing The Bootstrapping: Its Just A Left Join!</a></li>
  <li><a href="#but-does-it-work" id="toc-but-does-it-work" class="nav-link" data-scroll-target="#but-does-it-work">But Does It Work</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Dpananos/dpananos.github.io/edit/main/posts/2022-11-16-bootstrapping-in-sql/index.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/Dpananos/dpananos.github.io/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Remember the <a href="https://en.wikipedia.org/wiki/Double_Down_(sandwich)">“Double Down”</a> from KFC? It was bacon and cheese sandwiched between two deep fried pieces of chicken. I’m willing to bet we all conceived of it independently (as in “LOL wouldn’t it be crazy if…”), realistically could have made it ourselves, but were smart enough not to because “sure we could but… why?”.</p>
<p>This blog post is the Double Down of Statistics.</p>
</section>
<section id="bootstrapping-in-sql.-no-really." class="level2">
<h2 class="anchored" data-anchor-id="bootstrapping-in-sql.-no-really.">Bootstrapping in SQL. No, Really.</h2>
<p>Two things which have made my stats like easier:</p>
<ul>
<li>Bootstrapping, and</li>
<li>Tidy data</li>
</ul>
<p>R’s <code>rsample::bootstraps</code> seems to do one in terms of the other. Take a look at the output of that function. We have, in essence, one bootstrapped dataset per row.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample )</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>rsample<span class="sc">::</span><span class="fu">bootstraps</span>(cars)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Bootstrap sampling 
# A tibble: 25 × 2
   splits          id         
   &lt;list&gt;          &lt;chr&gt;      
 1 &lt;split [50/18]&gt; Bootstrap01
 2 &lt;split [50/16]&gt; Bootstrap02
 3 &lt;split [50/16]&gt; Bootstrap03
 4 &lt;split [50/18]&gt; Bootstrap04
 5 &lt;split [50/21]&gt; Bootstrap05
 6 &lt;split [50/19]&gt; Bootstrap06
 7 &lt;split [50/20]&gt; Bootstrap07
 8 &lt;split [50/18]&gt; Bootstrap08
 9 &lt;split [50/20]&gt; Bootstrap09
10 &lt;split [50/19]&gt; Bootstrap10
# … with 15 more rows</code></pre>
</div>
</div>
<p>In theory, I could unnest this and have one observation from each bootstrap per row, with <code>id</code> serving as an indicator to tell me to which resample the observation belongs to. Which means…I could theoretically bootstrap in SQL.</p>
<p>So, let’s do that. I’m going to use duckdb because its SQL-like and has some stats functions (whereas SQLite does not).</p>
<p>Let’s sample some pairs <span class="math inline">\((x_i, y_i)\)</span> from the relationship <span class="math inline">\(y_i = 2x_i + 1 + \varepsilon_i\)</span>, where the <span class="math inline">\(\varepsilon\)</span> are iid draws from a standard Gaussian Let’s stick that in a dataframe along with a row number column into our database. The data are shown in <a href="#tbl-original-data">Table&nbsp;1</a>.</p>
<div class="cell">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-original-data" class="anchored">

<table class="table table-striped" style="margin-left: auto; margin-right: auto;"><caption>Table&nbsp;1:  My Data </caption>
 <thead>
  <tr>
   <th style="text-align:center;"> original_rownum </th>
   <th style="text-align:center;"> x </th>
   <th style="text-align:center;"> y </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 1 </td>
   <td style="text-align:center;"> 2.09 </td>
   <td style="text-align:center;"> 5.73 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 2 </td>
   <td style="text-align:center;"> 0.97 </td>
   <td style="text-align:center;"> 3.58 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 3 </td>
   <td style="text-align:center;"> 0.70 </td>
   <td style="text-align:center;"> 1.37 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 4 </td>
   <td style="text-align:center;"> 1.44 </td>
   <td style="text-align:center;"> 4.84 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 5 </td>
   <td style="text-align:center;"> 2.07 </td>
   <td style="text-align:center;"> 4.14 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 6 </td>
   <td style="text-align:center;"> 1.67 </td>
   <td style="text-align:center;"> 3.09 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>To bootstrap in SQL, we need to emulate what the unnested results of <code>rsample::bootstraps</code> would look like. We need rows of (<code>strap_id</code>, <code>original_data_rownum</code>, and <code>bootstrap_rownum</code>). Let’s discuss the interpretation and purpose of each column.</p>
<ul>
<li><p><code>strap_id</code> plays the part of <code>id</code> in <code>rsample::bootstraps</code>. We’re just going to group by this column and aggregate the resampled data later.</p></li>
<li><p><code>original_data_rownum</code> doesn’t really serve a purpose. It contains integers 1 through <span class="math inline">\(N\)</span> (where <span class="math inline">\(N\)</span> is our original sample size). We can do a cross join to get pairs (<code>strap_id</code>, <code>original_data_rownum</code>). This means there will be <span class="math inline">\(N\)</span> copies of <code>strap_id</code>, meaning we can get <span class="math inline">\(N\)</span> resamples of our data for each <code>strap_id</code>.</p></li>
<li><p><code>bootstrap_rownum</code> is a random integer between 1 and <span class="math inline">\(N\)</span>. This column DOES serve a purpose, its basically the sampling with replacement bit for the bootstrap. Now, duckdb doesn’t have a function to sample random integers. To do this, I basically sample random numbers on the unit interval do some arithmetic to turn those into integers.</p></li>
</ul>
<p>Let’s set that up now. The hardest part really is creating a sequence of numbers, but duckdb makes that pretty easy.</p>
<section id="query-to-make-strap_id" class="level3">
<h3 class="anchored" data-anchor-id="query-to-make-strap_id">Query To Make <code>strap_id</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Set up strap_ids in a table</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">TABLE</span> strap_ids(strap_id <span class="dt">INTEGER</span>);</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- Do 1000 bootstraps</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> strap_ids(strap_id) <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> <span class="kw">range</span>(<span class="dv">1</span>, <span class="dv">1001</span>, <span class="dv">1</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output.var="tbl1">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-strap-ids" class="anchored">

<table class="table table-striped" style="margin-left: auto; margin-right: auto;"><caption>Table&nbsp;2:  Contents of strap_ids. These play the role of id in the rsample output. </caption>
 <thead>
  <tr>
   <th style="text-align:center;"> strap_id </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 2 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 3 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 4 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 5 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="query-to-make-original_data_rownum" class="level3">
<h3 class="anchored" data-anchor-id="query-to-make-original_data_rownum">Query To Make <code>original_data_rownum</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- Set up original_data_rownum in a table</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">OR</span> <span class="kw">REPLACE</span> <span class="kw">TABLE</span> original_data_rownum(original_rownum <span class="dt">INTEGER</span>);</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">-- I have 2500 observations in my data</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> original_data_rownum(original_rownum) <span class="kw">select</span> <span class="op">*</span> <span class="kw">from</span> <span class="kw">range</span>(<span class="dv">1</span>, <span class="dv">2500</span><span class="op">+</span><span class="dv">1</span>, <span class="dv">1</span>);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output.var="tbl2">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-original-data-rownum" class="anchored">

<table class="table table-striped" style="margin-left: auto; margin-right: auto;"><caption>Table&nbsp;3:  Contents of original_data_rownum. These play the role of id in the rsample output. </caption>
 <thead>
  <tr>
   <th style="text-align:center;"> original_rownum </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 1 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 2 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 3 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 4 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 5 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Ok, now we have the two tables <code>strap_ids</code> and <code>original_data_rownum</code>. All we need to do now is cross join then, and do the random number magic. That’s shown below in table <a href="#tbl-resample-template">Table&nbsp;4</a>.</p>
</section>
<section id="query-to-make-bootstrap_rownum" class="level3">
<h3 class="anchored" data-anchor-id="query-to-make-bootstrap_rownum">Query To Make <code>bootstrap_rownum</code></h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">or</span> <span class="kw">replace</span> <span class="kw">table</span> resample_template <span class="kw">as</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  strap_ids.strap_id,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  original_data_rownum.original_rownum,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- I have 2500 observations in my data</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>( <span class="op">-</span><span class="fl">0.5</span> <span class="op">+</span> <span class="dv">2501</span><span class="op">*</span><span class="kw">random</span>()) <span class="kw">as</span> bootstrap_rownum,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  strap_ids</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">cross</span> <span class="kw">join</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  original_data_rownum;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-output.var="tbl3">

</div>
<div class="cell">
<div class="cell-output-display">
<div id="tbl-resample-template" class="anchored">

<table class="table table-striped" style="margin-left: auto; margin-right: auto;"><caption>Table&nbsp;4:  A sample from the table resampel_template. </caption>
 <thead>
  <tr>
   <th style="text-align:center;"> strap_id </th>
   <th style="text-align:center;"> original_rownum </th>
   <th style="text-align:center;"> bootstrap_rownum </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:center;"> 573 </td>
   <td style="text-align:center;"> 2216 </td>
   <td style="text-align:center;"> 4 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 312 </td>
   <td style="text-align:center;"> 2227 </td>
   <td style="text-align:center;"> 1792 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 2 </td>
   <td style="text-align:center;"> 554 </td>
   <td style="text-align:center;"> 1577 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 440 </td>
   <td style="text-align:center;"> 381 </td>
   <td style="text-align:center;"> 688 </td>
  </tr>
  <tr>
   <td style="text-align:center;"> 969 </td>
   <td style="text-align:center;"> 1352 </td>
   <td style="text-align:center;"> 1840 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="actually-doing-the-bootstrapping-its-just-a-left-join" class="level2">
<h2 class="anchored" data-anchor-id="actually-doing-the-bootstrapping-its-just-a-left-join">Actually Doing The Bootstrapping: Its Just A Left Join!</h2>
<p>Now all we have to do is join the original data onto <code>resample_template</code>. The join is going to happen <code>on original_data.original_rownum = resample_template.bootstrap_rownum</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">or</span> <span class="kw">replace</span> <span class="kw">table</span> resampled_data <span class="kw">as</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  resample_template.strap_id,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  resample_template.bootstrap_rownum,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  original_data.x,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  original_data.y</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  resample_template</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">left</span> <span class="kw">join</span> </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  original_data <span class="kw">on</span> original_data.original_rownum <span class="op">=</span> resample_template.bootstrap_rownum;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And congratulations, you have what is in essence an unnested <code>rsample::bootstraps</code> output. This happens shockingly fast in duckdb (actually, a bit faster than <code>rsample</code> does it, but that is anecdote I didn’t actually time them). The hard part now is the aggregation function. Obviously, you can’t do very complex statsitical aggregations in duckdb (or any other SQL dialect), but there are a few you can do. For example, let’s bootstrap the mean of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, as well as the estimated regression coefficient.</p>
<div class="cell" data-output.var="bsr">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">select</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Bootstrap'</span> <span class="op">||</span> <span class="fu">lpad</span>(strap_id,<span class="dv">4</span>,<span class="dv">0</span>) <span class="kw">as</span> <span class="kw">id</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'SQL'</span> <span class="kw">as</span> <span class="kw">method</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">avg</span>(x) <span class="kw">as</span> mean_x,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">avg</span>(y) <span class="kw">as</span> mean_y,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">corr</span>(y, x) <span class="op">*</span> <span class="fu">stddev</span>(y) <span class="op">/</span> <span class="fu">stddev</span>(x) <span class="kw">as</span> beta</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">from</span> resampled_data</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">group</span> <span class="kw">by</span> <span class="dv">1</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">order</span> <span class="kw">by</span> <span class="dv">1</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can easily compare the distributions obtained via the SQL bootstrap with distributions obtained from <code>rsample::bootstrap</code></p>
<div class="cell">

</div>
</section>
<section id="but-does-it-work" class="level2">
<h2 class="anchored" data-anchor-id="but-does-it-work">But Does It Work</h2>
<p>Yes…I think. The averages for <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> look really good, but the SQL bootstrap tails for the regression coefficient are a little thin.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This is pretty silly, and probably inefficient. I’m no data engineer, I’m just a guy with a Ph.D in stats and a lot of time on the weekend. I should get a hobby or something.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>