<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Demetri Pananos Ph.D</title>
<link>https://dpananos.github.io/</link>
<atom:link href="https://dpananos.github.io/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.4.549</generator>
<lastBuildDate>Fri, 20 Feb 2026 05:00:00 GMT</lastBuildDate>
<item>
  <title>How Long To Run an A/B Test as a Bayesian</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2026-02-20-time/</link>
  <description><![CDATA[ 





<p><strong>Disclaimer</strong>: This blog post is inspired, almost entirely, by Tyler Buffington’s <em>excellent</em> statistics reading group presentation today at Datadog on the value of information in A/B testing. The ideas presented here are mainly his, I’ve just gone ahead and done a little more math (but not much more).</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this post, I discuss decision criteria for Bayesian A/B testing and a way to think about experiment run times for Bayesian A/B tests. I’ll also present some analytic results that can help us avoid doing simulations in practice at the cost of some mild assumptions.</p>
<p>First, I’ll discuss a little background on some straightforward ways to analyze A/B tests as a Bayesian and discuss a few options for ship/no-ship decision rules for A/B tests. Then, I’ll introduce a way to think about expected impact as a Bayesian, and finally share some analytic results.</p>
</section>
<section id="bayesian-approaches-to-ab-testing" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-approaches-to-ab-testing">Bayesian Approaches to A/B Testing</h2>
<p>Most A/B tests target the lift in a metric, defined as</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Clambda%20=%20%5Cdfrac%7BE%5BY(1)%5D%7D%7BE%5BY(0)%5D%7D%20-%201%20%5C%3E.%20"></p>
<p>We can obtain an estimate of the lift, <img src="https://latex.codecogs.com/png.latex?%5Chat%20%5Clambda">, via the plug in principle and the associated standard error, <img src="https://latex.codecogs.com/png.latex?s_%5Clambda"> via the delta method. Assuming <img src="https://latex.codecogs.com/png.latex?%5Chat%20%5Clambda"> is drawn from a normal distribution (I’ve talked about this before <a href="../../posts/2025-11-21-kuethe/index.html">here</a>), and that <img src="https://latex.codecogs.com/png.latex?s_%5Clambda"> is known exactly, we can use a conjugate normal-normal model to obtain the posterior distribution. Assuming the prior mean and variance is <img src="https://latex.codecogs.com/png.latex?%5Cmu"> and <img src="https://latex.codecogs.com/png.latex?%5Ctau%5E2"> respectively, the posterior variance and mean, <img src="https://latex.codecogs.com/png.latex?V"> and <img src="https://latex.codecogs.com/png.latex?M">, are</p>
<p><img src="https://latex.codecogs.com/png.latex?%20V%5E%7B-1%7D%20=%20%5Cdfrac%7B1%7D%7Bs%5E2_%5Clambda%7D%20+%20%5Cdfrac%7B1%7D%7B%5Ctau%5E2%7D%20%5C%3E,%20"> <img src="https://latex.codecogs.com/png.latex?%20M%20=%20V%20%5Ctimes%20%5Cleft(%5Cdfrac%7B%5Chat%20%5Clambda%7D%7Bs%5E2_%5Clambda%7D%20+%20%5Cdfrac%7B%5Cmu%7D%7B%5Ctau%5E2%7D%5Cright)%20%5C%3E.%20"></p>
<p>Whereas a Frequentist would make their ship/no-ship decision based on statistical significance, a Bayesian has a few options. Assuming increases to the metric are favorable, many of the decision rules are based on inequalities of the posterior mean. Here are just three I have seen in the wild:</p>
<ul>
<li>Ship if <img src="https://latex.codecogs.com/png.latex?c%20%5Clt%20%5CPr(%5Clambda%20%5Cgt%200%20%5Cmid%20%5Chat%20%5Clambda)">, which is equivalent to <img src="https://latex.codecogs.com/png.latex?%5Csqrt%7BV%7D%20%5CPhi%5E%7B-1%7D(c)%20%5Clt%20M">, where <img src="https://latex.codecogs.com/png.latex?%5CPhi"> is the standard normal CDF. This is sometimes called “Probability to beat control”.</li>
<li>Ship if <img src="https://latex.codecogs.com/png.latex?z_%7B1-%5Calpha/2%7D%5Csqrt%7BV%7D%20%5Clt%20M">. This is like a Bayesian p-value being less than <img src="https://latex.codecogs.com/png.latex?%5Calpha">.</li>
<li>Ship if <img src="https://latex.codecogs.com/png.latex?0%20%5Clt%20M">. Ship whenever the posterior mean is positive.</li>
</ul>
<p>Now, these are just a few ways to make decisions (they are certainly not exhaustive). Prior to Tyler’s talk, I didn’t really have a great way to answer how long an A/B test should take (save some ramblings about EVSI <a href="../../posts/2024-09-01-ab-length/index.html">here</a>) were you to use a Bayesian analysis method. However, with these details, I think I can now give an answer.</p>
</section>
<section id="how-long-to-run-an-ab-test-as-a-bayesian" class="level2">
<h2 class="anchored" data-anchor-id="how-long-to-run-an-ab-test-as-a-bayesian">How Long To Run an A/B Test as a Bayesian</h2>
<p>The question of how long to run an A/B test is really a question of sample size. Assuming you accrue some number subjects per week, you can do some back of the napkin math to say how long the test should run to sufficiently power the experiment given an MDE and some information on the metric. Often, we flip the script and present MDEs as a function of time (e.g.&nbsp;if you want a 3% MDE, run this experiment for 2 weeks. Want a smaller MDE? Run it longer). Run length is now a knob one can tune.</p>
<p>This is do-able as a Frequentist because we have a very clear relationship between power, MDE, and sample size (which is a function of time). Although there are Bayesian conceptions of power (e.g.&nbsp;conditional power, unconditional power, etc etc), the formulae for these don’t so straightforwardly relate time and desired effect sizes. This is further complicated by the prior – if your prior says a 5% lift is not probable, you probably shouldn’t design experiments to detect 5% lifts.</p>
<p>Rather than seek a formula right now, we can first draw random numbers to see what happens under different scenarios. Consider the following algorithm:</p>
<ul>
<li>Draw a true lift from your prior, <img src="https://latex.codecogs.com/png.latex?%5Clambda">.</li>
<li>Draw a control group mean from the implied sampling distribution (you need the control mean and standard error to do this, but you should know this if you were going to do a power calculation anyway).</li>
<li>Draw a treatment group mean from the implied sampling distribution.<br>
</li>
<li>Compute <img src="https://latex.codecogs.com/png.latex?%5Chat%20%5Clambda"> and <img src="https://latex.codecogs.com/png.latex?s_%5Clambda"></li>
<li>Compute <img src="https://latex.codecogs.com/png.latex?M"> and <img src="https://latex.codecogs.com/png.latex?V">.</li>
<li>Apply your decision rule. If you reach ship criteria, then return the true lift, else return 0.</li>
<li>Repeat a few thousand times.</li>
</ul>
<p>Here, time affects the sampling distributions of treatment and control. The longer the experiment runs, the more samples we accrue, the larger the precision in the group means will be. This procedure is shown for 4 scenarios below. The histograms show the distribution of true impacts to the product under the decision rule. The large spike at 0 indicates those A/B tests which resulted in no ship decisions, and the remainder are the impacts from shipping.</p>
<p>Note a few things. First, while difficult to see, there are some cases (especially in small sample sizes) where we ship harm to the product! This makes sense, when we have noisy measurements sometimes we can make type <img src="https://latex.codecogs.com/png.latex?S"> errors. As the sample size increases, the probability we make these errors decreases as does the proportion of no-ship decisions (the height of the spike decreases). Second, the mean of this distribution is the “average impact to the product”. This mean changes <em>slightly</em> due to my first point, and eventually the distribution of these impacts stabilizes to some limiting distribution (Tyler referred to this as the <em>Clairvoyant distribution</em>, essentially the distribution of impacts were you to know the true lift perfectly). Hence, there is some upper bound to the mean.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Distribution of shipped lifts under the probability to beat control decision rule (<img src="https://latex.codecogs.com/png.latex?c%20=%200.95">) for increasing sample sizes. Prior is <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BNormal%7D(0,%200.05%5E2)">, <img src="https://latex.codecogs.com/png.latex?%5Csigma%20=%200.5">, and equal allocation (<img src="https://latex.codecogs.com/png.latex?p%20=%200.5">). At small <img src="https://latex.codecogs.com/png.latex?N">, most simulations result in no-ship (the spike at 0). As <img src="https://latex.codecogs.com/png.latex?N"> grows, the posterior tightens and more true positives are shipped.</figcaption>
<p><img src="https://dpananos.github.io/posts/2026-02-20-time/index_files/figure-html/example-procedure-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Below is a plot of the mean of this distribution as a function of sample size, and you can see this limiting behavior quite clearly. The proposal is to base your run time on the expectation of the Clairvoyant distribution. From the plot, running A/B tests too short means the impact is going to be very small on average, but running longer means that (under the prior) you will impact the product more. There comes a point where running the test longer is not helpful because you encounter diminishing returns. This is a nice way to think about run time in my opinion! You know what your average impact would be were you to have perfect information, and you can collect enough samples so that you are sufficiently close to this without wasting time obtaining additional samples. I think that is pretty elegant!</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Average impact to the product as a function of sample size under the probability to beat control rule (<img src="https://latex.codecogs.com/png.latex?c%20=%200.95">). The curve flattens as <img src="https://latex.codecogs.com/png.latex?N"> grows, reflecting diminishing returns from longer experiments. Each dot is based on 100,000 simulations at each sample size.</figcaption>
<p><img src="https://dpananos.github.io/posts/2026-02-20-time/index_files/figure-html/example-mde-curve-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Note that I’ve just shown simulations for probability to beat, but the simulation approach is sufficiently flexible to accommodate any decision rule (expected loss, Bayesian p values, or whatever you can cook up). If you’re an analyst, you can do this fairly readily on your computer. What if you wanted to make this a product many people can use, and use with reproducible results? Simulating is fine in my opinion, generating random numbers and counting should be pretty cheap, but it would be cool to have a formula for the expected value of this distribution as a function of the total sample size.</p>
</section>
<section id="an-analytic-solution" class="level2">
<h2 class="anchored" data-anchor-id="an-analytic-solution">An Analytic Solution</h2>
<p>Simulation is great to get some intuition for what is happening, but we can actually recover these curves analytically with a little effort. First, note that all three of the decision rules are of the form</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Csqrt%7BV%7D%5CPhi%5E%7B-1%7D(p)%20%5Clt%20M%20%5C%3E.%20"></p>
<p>For the three decision rules I’ve listed above, <img src="https://latex.codecogs.com/png.latex?p%20=%20c">, <img src="https://latex.codecogs.com/png.latex?p=1-%5Calpha/2">, and <img src="https://latex.codecogs.com/png.latex?p=0.5">.</p>
<p>Now, let’s talk about our prior. The literature and discourse on A/B testing is consistent on two claims: 1) Most A/B tests do not have impact, and 2) when there is an impact then it is usually modest (that is to say, we do not routinely see large hurt/help to the product, usually because the low hanging fruit have been picked). This allows us to assume that <img src="https://latex.codecogs.com/png.latex?%5Cmu%20%5Capprox%200"> and <img src="https://latex.codecogs.com/png.latex?%5Cleft%5Clvert%20%5Chat%20%5Clambda%20%5Cright%5Crvert%20%5Capprox%200">. Given this, we can simplify the inequality a little. When <img src="https://latex.codecogs.com/png.latex?%5Cmu%20=%200"> the posterior mean reduces to <img src="https://latex.codecogs.com/png.latex?M%20=%20V%5Chat%20%5Clambda%20/%20s%5E2_%5Clambda">, and</p>
<p><img src="https://latex.codecogs.com/png.latex?%20s%5E2_%5Clambda%20%5Capprox%20%5Cleft(%20%5Cdfrac%7Bs%5E2_t%20+%20s%5E2_c%7D%7B%5Cbar%7By%7D%5E2_c%7D%5Cright)%20"></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?s%5E2"> is the sampling variance of the treatment or control group (indicated by the subscript) and <img src="https://latex.codecogs.com/png.latex?%5Cbar%20y%20_c"> is the average from the control group. Note there is an implicit reliance on <img src="https://latex.codecogs.com/png.latex?N"> here since <img src="https://latex.codecogs.com/png.latex?s%5E2%20%5Cpropto%201/N">. I’m going to indicate reliance on <img src="https://latex.codecogs.com/png.latex?N"> going forward to make this discussion a little easier. We can re-write the inequality based only on <img src="https://latex.codecogs.com/png.latex?%5Chat%20%5Clambda"> as</p>
<p><img src="https://latex.codecogs.com/png.latex?%20S(N)%20=%20%5CPhi%5E%7B-1%7D(p)%20%5Ccdot%20s%5E2_%5Clambda%20%5Ccdot%20%5Csqrt%7B%5Cdfrac%7B1%7D%7Bs%5E2_%5Clambda%7D%20+%20%5Cdfrac%7B1%7D%7B%5Ctau%5E2%7D%7D%20%5Clt%20%5Chat%20%5Clambda%20"></p>
<p>With this inequality in hand, we can recover the expectation of the Clairvoyant distribution and obtain a closed form expression for the expected impact as a function of <img src="https://latex.codecogs.com/png.latex?N">. We want to know</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Ctext%7Bimpact%7D%20%5Cmid%20N%5D%0A=%0AE%5C!%5Cleft%5B%5Clambda%20%5C,%5Cmathbf%201%5C%7B%5Chat%5Clambda%20%3E%20S(N)%5C%7D%5Cright%5D.%0A"></p>
<p>Under the normal–normal model we have</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Clambda%20%5Csim%20%5Cmathcal%20N(%5Cmu,%5Ctau%5E2),%0A%5Cqquad%0A%5Chat%5Clambda%20%5Cmid%20%5Clambda%0A%5Csim%0A%5Cmathcal%20N(%5Clambda,%20s_%5Clambda%5E2).%0A"></p>
<p>Since everything is Gaussian, we can rewrite the shipping event as</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%5Clambda%20%3E%20S(N)%0A%5C;%5C;%5CLongleftrightarrow%5C;%5C;%0A%5Clambda%20-%20Y%20%3E%200,%0A"></p>
<p>where</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY%20%5Csim%20%5Cmathcal%20N(S(N),%20s_%5Clambda%5E2),%0A%5Cqquad%0AY%20%5Cperp%20%5Clambda.%0A"></p>
<p>Define</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AD%20=%20%5Clambda%20-%20Y.%0A"></p>
<p>Then</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AD%20%5Csim%20%5Cmathcal%20N(%5Cmu%20-%20S(N),%5C,%20%5Comega%5E2),%0A%5Cqquad%0A%5Comega%5E2%20=%20%5Ctau%5E2%20+%20s_%5Clambda%5E2.%0A"></p>
<p>So the expected impact becomes</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Clambda%20%5Cmathbf%201(D%3E0)%5D.%0A"></p>
<p>This is a standard bivariate normal moment. Using linear projection geometry,</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Clambda%20%5Cmathbf%201(D%3E0)%5D%0A=%0A%5Cmu%20%5CPhi(a)%0A+%0A%5Cfrac%7B%5Ctau%5E2%7D%7B%5Comega%7D%5Cphi(a),%0A"></p>
<p>where</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Aa%0A=%0A%5Cfrac%7B%5Cmu%20-%20S(N)%7D%7B%5Comega%7D,%0A%5Cqquad%0A%5Comega%5E2=%5Ctau%5E2+s_%5Clambda%5E2.%0A"></p>
<p>Because we assumed <img src="https://latex.codecogs.com/png.latex?%5Cmu%20%5Capprox%200">, this simplifies to</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Ctext%7Bimpact%7D%20%5Cmid%20N%5D%0A=%0A%5Cfrac%7B%5Ctau%5E2%7D%7B%5Comega%7D%0A%5Cphi%5C!%5Cleft(%0A%5Cfrac%7B-S(N)%7D%7B%5Comega%7D%0A%5Cright).%0A"></p>
<p>Substituting the decision threshold</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AS(N)%0A=%0A%5CPhi%5E%7B-1%7D(p)%5C,%20s_%5Clambda%5E2%0A%5Csqrt%7B%5Cfrac%7B1%7D%7Bs_%5Clambda%5E2%7D+%5Cfrac%7B1%7D%7B%5Ctau%5E2%7D%7D,%0A"></p>
<p>gives a fully analytic expression for expected impact as a function of <img src="https://latex.codecogs.com/png.latex?N"> (through <img src="https://latex.codecogs.com/png.latex?s_%5Clambda%5E2%20%5Cpropto%201/N">).</p>
<p>Thus, for any of the three decision rules, the entire curve of expected impact versus sample size collapses to</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Ctext%7Bimpact%7D%20%5Cmid%20N%5D%0A=%0A%5Cmu%20%5CPhi(a)%0A+%0A%5Cfrac%7B%5Ctau%5E2%7D%7B%5Csqrt%7B%5Ctau%5E2+s_%5Clambda%5E2%7D%7D%0A%5Cphi(a),%0A%5Cqquad%0Aa=%0A%5Cfrac%7B%5Cmu-S(N)%7D%7B%5Csqrt%7B%5Ctau%5E2+s_%5Clambda%5E2%7D%7D.%0A"></p>
<p>The only difference across rules is the constant <img src="https://latex.codecogs.com/png.latex?p"> embedded inside <img src="https://latex.codecogs.com/png.latex?S(N)">. As a corollary, we can obtain the expectation of the Clairvoyant distribution by noting that <img src="https://latex.codecogs.com/png.latex?S(N)%20%5Cto%200"> as <img src="https://latex.codecogs.com/png.latex?N%20%5Cto%20%5Cinfty">, so <img src="https://latex.codecogs.com/png.latex?%5Comega%20%5Cto%20%5Ctau"> and <img src="https://latex.codecogs.com/png.latex?a%20%5Cto%20%5Cmu/%5Ctau">. Hence the expected impact with perfect information is</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AE%5B%5Ctext%7BClairvoyant%20impact%7D%5D%0A=%0A%5Cmu%20%5CPhi%5C!%5Cleft(%5Cfrac%7B%5Cmu%7D%7B%5Ctau%7D%5Cright)%0A+%0A%5Ctau%5C,%5Cphi%5C!%5Cleft(%5Cfrac%7B%5Cmu%7D%7B%5Ctau%7D%5Cright).%0A"></p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Simulated (open markers) and closed-form analytic (black lines) expected impact for all three decision rules. The red horizontal line is the Clairvoyant upper bound. Prior is <img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BNormal%7D(0,%200.05%5E2)">, <img src="https://latex.codecogs.com/png.latex?%5Csigma%20=%200.5">, equal allocation.</figcaption>
<p><img src="https://dpananos.github.io/posts/2026-02-20-time/index_files/figure-html/final-comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2026-02-20-time/</guid>
  <pubDate>Fri, 20 Feb 2026 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Things I Believe According to Claude</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2026-02-14-principles/</link>
  <description><![CDATA[ 





<p>I asked claude code to read through all the posts I’ve made in this blog in order to pull out some of my principles. Here is what claude thinks I believe</p>
<section id="empathy-first-math-second" class="level2">
<h2 class="anchored" data-anchor-id="empathy-first-math-second">Empathy First, Math Second</h2>
<p><a href="../../posts/2023-05-14-ab-brain-dump/index.html">I think this is largely true, as evidenced by a previous post</a>. I’ve said, multiple times in the past week, that “experimentation is not a math problem, it is a people problem”. I think this also explains why I like talking to customers and doing user research.</p>
</section>
<section id="trade-precision-for-usefulness" class="level2">
<h2 class="anchored" data-anchor-id="trade-precision-for-usefulness">Trade Precision for Usefulness</h2>
<p>I absolutely believe this, perhaps to a fault. There is little alpha to be gained in being pedantic, much in the same way a data scientist is required to give “good enough” solution to a well posed problem and not a perfect solution to the wrong problem. Either end of the precision-usefulness tradeoff is too extreme, and the art is finding the middle ground.</p>
</section>
<section id="process-over-tools" class="level2">
<h2 class="anchored" data-anchor-id="process-over-tools">Process Over Tools</h2>
<p>Do I beleive this? I don’t know. I think claude went off the rails here, writing about me scaling experimentation by improving other people around me. I’m not sure I would agree with this being a principle.</p>
</section>
<section id="understand-why-not-just-how" class="level2">
<h2 class="anchored" data-anchor-id="understand-why-not-just-how">Understand Why, Not Just How</h2>
<p>Yes, this is absolutely a principle of mine. I see this in other areas of life too, not just work. Generally, things like “tradition” don’t land on me because “we’ve always done this” sounds like “I have not critically thought about why this practice is valuable”.</p>
</section>
<section id="simple-over-complex" class="level2">
<h2 class="anchored" data-anchor-id="simple-over-complex">Simple Over Complex</h2>
<p>I think most reasonable people would think this, but claude seems to be pulling on threads related to me prefering Frequentist solutions over Bayesian ones because most people are comfortable with Frequentism. Not sure that applies.</p>
</section>
<section id="someone-smarter-already-solved-it" class="level2">
<h2 class="anchored" data-anchor-id="someone-smarter-already-solved-it">Someone Smarter Already Solved It</h2>
<p>I really thought this early on in my PhD. To some extent, I still think this. Perhaps I should lean on this more.</p>
</section>
<section id="simulate-everything" class="level2">
<h2 class="anchored" data-anchor-id="simulate-everything">Simulate Everything</h2>
<p>LOL yes. However, there is a lot of benefit to trying things pen and paper too!</p>
</section>
<section id="be-honest-about-limitations" class="level2">
<h2 class="anchored" data-anchor-id="be-honest-about-limitations">Be Honest About Limitations</h2>
<p>Yes, maybe not honest enough. I have found myself pumping out sub par analyses because it was easier than explaining to a clinician (for the hundredth time) that dichotmization is bad and you should not do it. I used to tell myself “I can lose this battle in order to win the war”, but if I am always losing battles then how can I ever win? Maybe I need to be more hoenst.</p>
</section>
<section id="speed-matters" class="level2">
<h2 class="anchored" data-anchor-id="speed-matters">Speed Matters</h2>
<p>Yawn, this seems trite.</p>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2026-02-14-principles/</guid>
  <pubDate>Sat, 14 Feb 2026 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Cleaning Data Patterns</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2026-02-09-cleaning/</link>
  <description><![CDATA[ 





<p>I still clean data from time to time, and I find myself writing patterns that looks like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">raw_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb1-3">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">smoking =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_lower</span>(smoking),</span>
<span id="cb1-4">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb1-5">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>,</span>
<span id="cb1-6">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span></span>
<span id="cb1-7">    ),</span>
<span id="cb1-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hypertension =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_lower</span>(hypertension),</span>
<span id="cb1-9">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb1-10">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>,</span>
<span id="cb1-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span></span>
<span id="cb1-12">    ),</span>
<span id="cb1-13">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">diabetes =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_lower</span>(diabetes),</span>
<span id="cb1-14">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb1-15">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>,</span>
<span id="cb1-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>)</span>
<span id="cb1-17">  )</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
      id smoking hypertension diabetes
   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;        &lt;chr&gt;   
 1     1 Y       Y            N       
 2     2 N       Y            Y       
 3     3 Y       N            Y       
 4     4 N       N            N       
 5     5 N       N            N       
 6     6 N       N            N       
 7     7 N       Y            Y       
 8     8 Y       N            N       
 9     9 N       N            N       
10    10 N       N            N       </code></pre>
</div>
</div>
<p>I know the aphorism is “If you write a piece of code 3 times, write a function” so I could do</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">clean_yn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x){</span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_match</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_to_lower</span>(x), </span>
<span id="cb3-3">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>,</span>
<span id="cb3-4">        <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>,</span>
<span id="cb3-5">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.default =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span></span>
<span id="cb3-6">             )</span>
<span id="cb3-7">}</span>
<span id="cb3-8"></span>
<span id="cb3-9">raw_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb3-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb3-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(</span>
<span id="cb3-12">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"smoking"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hypertension"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"diabetes"</span>)),</span>
<span id="cb3-13">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clean_yn</span>(.x)</span>
<span id="cb3-14">    ))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
      id smoking hypertension diabetes
   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;        &lt;chr&gt;   
 1     1 Y       Y            N       
 2     2 N       Y            Y       
 3     3 Y       N            Y       
 4     4 N       N            N       
 5     5 N       N            N       
 6     6 N       N            N       
 7     7 N       Y            Y       
 8     8 Y       N            N       
 9     9 N       N            N       
10    10 N       N            N       </code></pre>
</div>
</div>
<p>But I usually have to edit the name of the column too because often <code>smoking</code> is actually <code>Smoking (Yes or No)</code> (and while <code>{janitor}</code> helps it still leaves some cruft on the end of column names). This makes the first pattern more attractive, despite the repetition.</p>
<p>I asked gemini how it might handle this problem, and I was shown a neat little pattern I want to share. The mutate-across pattern us actually pretty useful, so let’s abstract that into a function and tack on a rename like so</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">apply_cleaners <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, clean_func, rename_map){</span>
<span id="cb5-2">  data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-3">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb5-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">across</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unname</span>(rename_map)), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">clean_func</span>(.x))</span>
<span id="cb5-5">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb5-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rename</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all_of</span>(rename_map))</span>
<span id="cb5-7">}</span></code></pre></div>
</div>
<p>Now, I can specify a list of columns I want to clean with the same function, and the new names I want to use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">cleaning_tasks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rename_map =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smoking_cleaned'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smoking'</span>, </span>
<span id="cb6-3">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hypertension_cleaned'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hypertension'</span>,</span>
<span id="cb6-4">                 <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diabetes_cleaned'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diabetes'</span>),</span>
<span id="cb6-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func =</span> clean_yn</span>
<span id="cb6-6">)</span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply_cleaners</span>(raw_data, cleaning_tasks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>func, cleaning_tasks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rename_map)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
      id smoking_cleaned hypertension_cleaned diabetes_cleaned
   &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;                &lt;chr&gt;           
 1     1 Y               Y                    N               
 2     2 N               Y                    Y               
 3     3 Y               N                    Y               
 4     4 N               N                    N               
 5     5 N               N                    N               
 6     6 N               N                    N               
 7     7 N               Y                    Y               
 8     8 Y               N                    N               
 9     9 N               N                    N               
10    10 N               N                    N               </code></pre>
</div>
</div>
<p>which doesn’t seem that cool, unless you realize that what is returned is a tibble, which can be passed through <code>apply_cleaners</code> again. Hence, <code>reduce</code> seems like a good tool here</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Needs to be a list of lists </span></span>
<span id="cb8-2">cleaning_tasks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb8-3">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"yn_cleaning_tasks"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb8-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rename_map =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smoking_cleaned'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'smoking'</span>, </span>
<span id="cb8-5">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hypertension_cleaned'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'hypertension'</span>,</span>
<span id="cb8-6">                   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diabetes_cleaned'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'diabetes'</span>),</span>
<span id="cb8-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func =</span> clean_yn</span>
<span id="cb8-8">  )</span>
<span id="cb8-9">)</span>
<span id="cb8-10"></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">reduce</span>(cleaning_tasks, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(data, task) {</span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply_cleaners</span>(data, task<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>func, task<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rename_map)</span>
<span id="cb8-14">}, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.init=</span>raw_data)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
      id smoking_cleaned hypertension_cleaned diabetes_cleaned
   &lt;int&gt; &lt;chr&gt;           &lt;chr&gt;                &lt;chr&gt;           
 1     1 Y               Y                    N               
 2     2 N               Y                    Y               
 3     3 Y               N                    Y               
 4     4 N               N                    N               
 5     5 N               N                    N               
 6     6 N               N                    N               
 7     7 N               Y                    Y               
 8     8 Y               N                    N               
 9     9 N               N                    N               
10    10 N               N                    N               </code></pre>
</div>
</div>
<p>This is overkill for many cleaning tasks, but when you’re cleaning dozens of columns, I think this is nice! It is very targets-y, which I like.</p>



 ]]></description>
  <guid>https://dpananos.github.io/posts/2026-02-09-cleaning/</guid>
  <pubDate>Mon, 09 Feb 2026 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Kuethe’s Criterion and A/B Tests</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-11-21-kuethe/</link>
  <description><![CDATA[ 





<section id="on-the-validity-of-a-normal-approximation-to-the-ratio-of-means" class="level2">
<h2 class="anchored" data-anchor-id="on-the-validity-of-a-normal-approximation-to-the-ratio-of-means">On The Validity of a Normal Approximation to The Ratio of Means</h2>
<p>A/B tests often target the “lift” in the metric as an estimand. As a reminder, the lift is</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Clambda%20=%20%5Cdfrac%7BE%5BY(1)%5D%20-%20E%5BY(0)%5D%7D%7BE%5BY(0)%5D%7D%20"> and is interpreted as the percent improvement treatment had over control. Clearly, the lift can be problematic when <img src="https://latex.codecogs.com/png.latex?E%5BY(0)%5D"> – the expected value of the outcome under no treatment – is too close to 0. This is not a revolutionary insight and has been a popular critique of the estimand.</p>
<p>Eppo (By Datadog) is familiar with the problem with lift, and as a consequence will not show the lift and associated confidence intervals when the control group’s average outcome is within 10 standard errors of 0.</p>
<p>But why 10 standard errors? Ten is a nice number, but feels somewhat arbitrary. That decision came from a paper entitled <a href="https://www.researchgate.net/profile/F-Rubio/publication/257406150_On_the_existence_of_a_normal_approximation_to_the_distribution_of_the_ratio_of_two_independent_normal_random_variables/links/53d7a18a0cf2e38c632ddabc/On-the-existence-of-a-normal-approximation-to-the-distribution-of-the-ratio-of-two-independent-normal-random-variables.pdf">“On the existence of a normal approximation to the distribution of the ratio of two independent normal random variables”</a> by Eloisa Diaz-Frances and Francisco J. Rubio. I’ll give you the short version of the justification and leave you to read the paper if you like.</p>
<p>In brief, Diaz-Frances and Rubio study the sampling distribution of the ratio of two normals with positive means. Note, that is is related to A/B testing because a) the lift is a shifted version of such a random variable, and b) the CLT gives us good justification for treating the sample means as Gaussian random variables <sup>1</sup>. Diaz-Frances and Rubio reference a paper by Kuethe and colleagues called <a href="https://pubmed.ncbi.nlm.nih.gov/10846046/">“Imaging obstructed ventilation with NMR using inert fluorinated gases”</a> who also studied normal approximations such random variables and concluded that when the denominator’s coefficient of variation is smaller than 0.1 (or, when the mean is 10 standard deviations away from 0) then there is a really small probability of observing a negative value from the normal approximation to the true sampling distribution. This is what we call “Kuethe’s criterion”. In A/B testing, the denominator’s standard deviation is the standard error, and this is where our 10 standard error rule came from. In short, we consider the normal approximation to the lift’s sampling distribution valid only when Kuethe’s criterion is met.</p>
<p>Kuethe and colleagues report that the probability of observing a negative value from the normal approximation is something on the order of <img src="https://latex.codecogs.com/png.latex?10%5E-24"> which seems excessively small. Also, I don’t care about the probability of a negative value, I care much more about the coverage of my resulting confidence interval. How does coverage change when Kuethe’s criterion is not met?</p>
</section>
<section id="a-very-short-simulation-of-coverage" class="level2">
<h2 class="anchored" data-anchor-id="a-very-short-simulation-of-coverage">A Very Short Simulation of Coverage</h2>
<p>It should be straight forward to determine the impact of beign <img src="https://latex.codecogs.com/png.latex?M"> standard errors away from the mean. Consider a random variable <img src="https://latex.codecogs.com/png.latex?y"> such that</p>
<p><img src="https://latex.codecogs.com/png.latex?%20y%20%5Csim%20%5Cmathcal%7BN%7D(M,%201%5E2%20)%5C%3E.%20"></p>
<p>Note that the coefficient of variation for <img src="https://latex.codecogs.com/png.latex?y"> is <img src="https://latex.codecogs.com/png.latex?1/M"> and so when <img src="https://latex.codecogs.com/png.latex?M%5Cgeq10">, then Kuethe’s criterion is satisfied. To simulate what happens to coverage, I just need to simulate a bunch of these random variables for treatment and control, compute the standard error via the delta method, and determine coverage. The simulation is actually pretty short.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">between <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, low, hi) (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span>hi) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> (low <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> x)</span>
<span id="cb1-2"></span>
<span id="cb1-3">sim_coverage <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(Mc){</span>
<span id="cb1-4">  </span>
<span id="cb1-5">  actual_lift <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb1-6">  Mt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Mc <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (actual_lift<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-7">  </span>
<span id="cb1-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># With this many simulations, I can be certain about the first 2 decimal places</span></span>
<span id="cb1-9">  Nsims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span></span>
<span id="cb1-10">  </span>
<span id="cb1-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The following random variables are guarenteed to have a coefficient of variation &lt;= 0.1</span></span>
<span id="cb1-12">  yc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(Nsims, Mc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-13">  yt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(Nsims, Mt, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-14">  lift <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>yc<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span></span>
<span id="cb1-15">  </span>
<span id="cb1-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Because we know their standard deviation, we can apply the delta method for the lift</span></span>
<span id="cb1-17">  se <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>((Mt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Mc)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Mc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Mt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb1-18">  </span>
<span id="cb1-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now, we can determine coverage</span></span>
<span id="cb1-20">  conf_lower <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lift <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>se</span>
<span id="cb1-21">  conf_upper <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> lift <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>se</span>
<span id="cb1-22">  coverage <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">between</span>(actual_lift, conf_lower, conf_upper))</span>
<span id="cb1-23">  </span>
<span id="cb1-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(coverage)</span>
<span id="cb1-25">}</span>
<span id="cb1-26"></span>
<span id="cb1-27"></span>
<span id="cb1-28">M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb1-29"></span>
<span id="cb1-30">coverage <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(M, sim_coverage)</span>
<span id="cb1-31">f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loess</span>(coverage <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> M)</span>
<span id="cb1-32"></span>
<span id="cb1-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># First plot normally</span></span>
<span id="cb1-34"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(M, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(f), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>,</span>
<span id="cb1-35">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Standard Deviations Away From 0"</span>,</span>
<span id="cb1-36">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Coverage of 95% CI"</span>)</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shade vertical region where M &gt;= 10</span></span>
<span id="cb1-39">usr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">par</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"usr"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># xmin, xmax, ymin, ymax</span></span>
<span id="cb1-40"></span>
<span id="cb1-41"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rect</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xleft =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb1-42">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ybottom =</span> usr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>],</span>
<span id="cb1-43">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xright =</span> usr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb1-44">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ytop =</span> usr[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>],</span>
<span id="cb1-45">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">adjustcolor</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lightgray"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha.f =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>),</span>
<span id="cb1-46">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb1-47"></span>
<span id="cb1-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Redraw the line so it appears on top</span></span>
<span id="cb1-49"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(M, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(f), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)</span>
<span id="cb1-50"></span>
<span id="cb1-51"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kuethe's Criterion</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Met"</span>)</span>
<span id="cb1-52"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">text</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kuethe's Criterion</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Not Met"</span>)</span>
<span id="cb1-53"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grid</span>()</span>
<span id="cb1-54"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-11-21-kuethe/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Assuming we have enough data that this is a good assumption. Berry-Esseen theorem applies here, but that is another blog post altogether.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://dpananos.github.io/posts/2025-11-21-kuethe/</guid>
  <pubDate>Fri, 21 Nov 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>How to Fit a Generalized Linear Model with Fixed Effects (Pt 1)</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-11-12-glmfe/</link>
  <description><![CDATA[ 





<p><em>To the Economists, I am sorry</em>.</p>
<section id="what-is-a-fixed-effect-model" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-fixed-effect-model">What is a Fixed Effect Model?</h2>
<p>A model with fixed effects is the following</p>
<p><img src="https://latex.codecogs.com/png.latex?%20y_%7Bi,%20t%7D%20=%20%5Cbeta_0%20+%20%5Calpha_i%20+%20%5Cbeta%20%5Cmathbf%7Bx%7D_%7Bi,%20t%7D%20+%20u_%7Bi,%20t%7D%20%20%5C%3E.%20"></p>
<p>Subjects (indexed by <img src="https://latex.codecogs.com/png.latex?i">) are followed over time (indexed by <img src="https://latex.codecogs.com/png.latex?t">) and outcomes <img src="https://latex.codecogs.com/png.latex?y"> are recorded. Covariates <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D"> are also recorded and we fit the model using OLS. Each subject has an “idiosyncratic” effect <img src="https://latex.codecogs.com/png.latex?%5Calpha_i"> and there are shared coefficients <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, Now, we don’t need to follow subjects over time to use a fixed effect model, this is just a typical use case.</p>
<p>If you’re a statistician, you probably see this and think “they just added dummy variables to their regression can called it something new” and you would be right. Don’t believe me? I’ll show you.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(fixest)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(modelsummary)</span>
<span id="cb1-4"></span>
<span id="cb1-5">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">na.omit</span>(palmerpenguins<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>penguins)</span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regular old OLS fit</span></span>
<span id="cb1-7">fit_wout <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> species,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data)</span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fancy new fixed effets fit</span></span>
<span id="cb1-9">fit_w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">feols</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> species,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">vcov =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'iid'</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11">mods <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Without Fixed Effects'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fit_wout, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'With Fixed Effects'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fit_w)</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">modelsummary</span>(mods, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gof_map =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span></code></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_wqvgoe0t82wrydfm8hk6(i, j, css_id) {
          var table = document.getElementById("tinytable_wqvgoe0t82wrydfm8hk6");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_wqvgoe0t82wrydfm8hk6(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_wqvgoe0t82wrydfm8hk6");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '10', j: 1 }, { i: '10', j: 2 },  ], css_id: 'tinytable_css_h5hxbf3n5jzh8etfpqmb',}, 
          { positions: [ { i: '1', j: 1 }, { i: '2', j: 1 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '3', j: 1 }, { i: '8', j: 1 }, { i: '9', j: 1 }, { i: '3', j: 2 }, { i: '7', j: 1 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '7', j: 2 }, { i: '4', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '8', j: 2 }, { i: '9', j: 2 },  ], css_id: 'tinytable_css_0bxcjuok0t9rtg8vemv7',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_6iu9nq08vouysaih8zfk',}, 
          { positions: [ { i: '10', j: 0 },  ], css_id: 'tinytable_css_xicwdx0lhgbk55t4yiv8',}, 
          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '7', j: 0 }, { i: '8', j: 0 }, { i: '9', j: 0 },  ], css_id: 'tinytable_css_tla0j6pnv87cbcbife2p',}, 
          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_3b72djize0xml6h8avcu',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_wqvgoe0t82wrydfm8hk6(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_h5hxbf3n5jzh8etfpqmb, .table th.tinytable_css_h5hxbf3n5jzh8etfpqmb { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_0bxcjuok0t9rtg8vemv7, .table th.tinytable_css_0bxcjuok0t9rtg8vemv7 { text-align: center; }
      .table td.tinytable_css_6iu9nq08vouysaih8zfk, .table th.tinytable_css_6iu9nq08vouysaih8zfk { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_xicwdx0lhgbk55t4yiv8, .table th.tinytable_css_xicwdx0lhgbk55t4yiv8 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_tla0j6pnv87cbcbife2p, .table th.tinytable_css_tla0j6pnv87cbcbife2p { text-align: left; }
      .table td.tinytable_css_3b72djize0xml6h8avcu, .table th.tinytable_css_3b72djize0xml6h8avcu { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_wqvgoe0t82wrydfm8hk6" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0"> </th>
                <th scope="col" data-row="0" data-col="1">Without Fixed Effects</th>
                <th scope="col" data-row="0" data-col="2">With Fixed Effects</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">(Intercept)</td>
                  <td data-row="1" data-col="1">2169.270</td>
                  <td data-row="1" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0"></td>
                  <td data-row="2" data-col="1">(271.753)</td>
                  <td data-row="2" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">sexmale</td>
                  <td data-row="3" data-col="1">547.367</td>
                  <td data-row="3" data-col="2">547.367</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0"></td>
                  <td data-row="4" data-col="1">(43.206)</td>
                  <td data-row="4" data-col="2">(43.206)</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">bill_length_mm</td>
                  <td data-row="5" data-col="1">32.537</td>
                  <td data-row="5" data-col="2">32.537</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0"></td>
                  <td data-row="6" data-col="1">(7.303)</td>
                  <td data-row="6" data-col="2">(7.303)</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">speciesChinstrap</td>
                  <td data-row="7" data-col="1">-298.766</td>
                  <td data-row="7" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0"></td>
                  <td data-row="8" data-col="1">(85.947)</td>
                  <td data-row="8" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">speciesGentoo</td>
                  <td data-row="9" data-col="1">1094.867</td>
                  <td data-row="9" data-col="2"></td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0"></td>
                  <td data-row="10" data-col="1">(74.029)</td>
                  <td data-row="10" data-col="2"></td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>In the fixed effect model, the coefficients and standard errors for <code>sexmale</code> and <code>bill_length_mm</code> are the same as the regular model with dummies, but the species indicators are missing. Why is that and why should I use a fixed effect model?</p>
<p>Fixed effects models are great for when you need to account for those dummies but don’t want to carry them around. Think about adjusting for ZIP code (probably hundreds) in a regression in which you just care about some other variable.</p>
<p>But why should the coefficients be the same? For that, we need to go back to ol’ reliable</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-11-12-glmfe/reliable.jpeg" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></p>
</figure>
</div>
</section>
<section id="fwl-theorem" class="level2">
<h2 class="anchored" data-anchor-id="fwl-theorem">FWL Theorem</h2>
<p>FWL states that the estimate of <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> from the model <img src="https://latex.codecogs.com/png.latex?Y=X%5Cbeta%20+%20D%5Cgamma%20+%20u"> will be the same as the estimate obtained from <img src="https://latex.codecogs.com/png.latex?MY%20=%20MD%5Cgamma%20+%20Mu"> , where</p>
<p><img src="https://latex.codecogs.com/png.latex?%20M%20=%20(I-X(X%5E%5Ctop%20X)%5E%7B-1%7DX%5E%5Ctop)%20=%20I-H%20"> Note that <img src="https://latex.codecogs.com/png.latex?H"> is the “hat” matrix because it “puts the hat on <img src="https://latex.codecogs.com/png.latex?Y">” in regression. <img src="https://latex.codecogs.com/png.latex?H"> is also a projection matrix – meaning that <img src="https://latex.codecogs.com/png.latex?%5Chat%20Y%20=%20HY"> is the projection of <img src="https://latex.codecogs.com/png.latex?Y"> onto the column space of <img src="https://latex.codecogs.com/png.latex?X">, <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BC%7D%20(X)"> . Makes sense, since the prediction from the linear model is, literally, a linear combination of the columns of <img src="https://latex.codecogs.com/png.latex?X">.</p>
<p>This also means <img src="https://latex.codecogs.com/png.latex?I-H"> is a projection matrix, but left multiplication by this matrix projects the vector onto <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BC%7D(X)%5E%5Cperp">, the orthogonal compliment of the column space of <img src="https://latex.codecogs.com/png.latex?X">. Note that <img src="https://latex.codecogs.com/png.latex?(I-H)X%20=%20%5Cmathbf%7B0%7D"> for this reason. We’ll come back to this after a brief interlude of algebra.</p>
</section>
<section id="why-is-gamma-left-unchanged" class="level2">
<h2 class="anchored" data-anchor-id="why-is-gamma-left-unchanged">Why is <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> Left Unchanged?</h2>
<p>It would first behoove us to understand what the estimate of <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> is under each model. Under the second model</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Chat%20%5Cgamma%20=%20((MD)%5E%5Ctop%20MD)%5E%7B-1%7D%20(MD)%5E%5Ctop%20MY%20%5C%3E."> Since <img src="https://latex.codecogs.com/png.latex?M"> is a projection matrix it is idempotent and symmetric, and so this expression simplifies to</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Chat%20%5Cgamma%20=%20(D%5E%5Ctop%20M%20D)%5E%7B-1%7D%20D%5E%5Ctop%20M%20Y%20%5C%3E."> Under the first model, the estimate of <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> is more involved. First, concatenate <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?D"> column-wise so that <img src="https://latex.codecogs.com/png.latex?Z%20=%20%5Cbegin%7Bbmatrix%7D%20X%20&amp;%20D%20%5Cend%7Bbmatrix%7D">. We can then express the estimates of <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> and <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> in terms of inverses of block matrices</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Bbmatrix%7D%20%5Cbeta%20%5C%5C%20%5Cgamma%20%5Cend%7Bbmatrix%7D%20=%20(Z%5E%5Ctop%20Z)%5E%7B-1%7D%20Z%5E%5Ctop%20Y%20"> Note that <img src="https://latex.codecogs.com/png.latex?Z%5E%5Ctop%20Z"> is a block matrix with the following form, so</p>
<p><img src="https://latex.codecogs.com/png.latex?%20Z%5E%5Ctop%20Z%20=%20%5Cbegin%7Bbmatrix%7D%20X%5E%5Ctop%20X%20&amp;%20X%5E%5Ctop%20D%20%5C%5C%20D%5E%5Ctop%20X%20%20&amp;%20D%5E%5Ctop%20D%5Cend%7Bbmatrix%7D%20"> and therefore <img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Bbmatrix%7D%20%5Cbeta%20%5C%5C%20%5Cgamma%20%5Cend%7Bbmatrix%7D%20=%20%5Cbegin%7Bbmatrix%7D%20X%5E%5Ctop%20X%20&amp;%20X%5E%5Ctop%20D%20%5C%5C%20D%5E%5Ctop%20X%20%20&amp;%20D%5E%5Ctop%20D%5Cend%7Bbmatrix%7D%5E%7B-1%7D%20%5Cbegin%7Bbmatrix%7D%20X%5E%5Ctop%20Y%20%5C%5C%20D%5E%5Ctop%20Y%20%5Cend%7Bbmatrix%7D%20%5C%3E."></p>
<p>From this form, we can see we need the bottom row. The inverse of a 2x2 block matrix is a fucking hairy thing, here it is</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbf%7BP%7D%5E%7B-1%7D%20=%20%5Cbegin%7Bbmatrix%7D%0A%5Cmathbf%7BA%7D%20&amp;%20%5Cmathbf%7BB%7D%20%5C%5C%0A%5Cmathbf%7BC%7D%20&amp;%20%5Cmathbf%7BF%7D%0A%5Cend%7Bbmatrix%7D%5E%7B-1%7D%20=%20%5Cbegin%7Bbmatrix%7D%0A(%5Cmathbf%7BA%7D%20-%20%5Cmathbf%7BB%7D%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5Cmathbf%7BC%7D)%5E%7B-1%7D%20&amp;%20-%20(%5Cmathbf%7BA%7D%20-%20%5Cmathbf%7BB%7D%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5Cmathbf%7BC%7D)%5E%7B-1%7D%20%5Cmathbf%7BB%7D%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5C%5C%0A-%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5Cmathbf%7BC%7D%20(%5Cmathbf%7BA%7D%20-%20%5Cmathbf%7BB%7D%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5Cmathbf%7BC%7D)%5E%7B-1%7D%20&amp;%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20+%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5Cmathbf%7BC%7D%20(%5Cmathbf%7BA%7D%20-%20%5Cmathbf%7BB%7D%20%5Cmathbf%7BF%7D%5E%7B-1%7D%20%5Cmathbf%7BC%7D)%5E%7B-1%7D%20%5Cmathbf%7BB%7D%20%5Cmathbf%7BF%7D%5E%7B-1%7D%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p>and so the inverse of our block matrix is</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Bbmatrix%7D%20X%5E%5Ctop%20X%20&amp;%20X%5E%5Ctop%20D%20%5C%5C%20D%5E%5Ctop%20X%20&amp;%20D%5E%5Ctop%20D%20%5Cend%7Bbmatrix%7D%5E%7B-1%7D%20=%0A%5Cbegin%7Bbmatrix%7D%0A(X%5E%5Ctop%20X)%5E%7B-1%7D%20+%20(X%5E%5Ctop%20X)%5E%7B-1%7D%20X%5E%5Ctop%20D%20%5CDelta%5E%7B-1%7D%20D%5E%5Ctop%20X%20(X%5E%5Ctop%20X)%5E%7B-1%7D%20&amp;%20-(X%5E%5Ctop%20X)%5E%7B-1%7D%20X%5E%5Ctop%20D%20%5CDelta%5E%7B-1%7D%20%5C%5C%0A-%5CDelta%5E%7B-1%7D%20D%5E%5Ctop%20X%20(X%5E%5Ctop%20X)%5E%7B-1%7D%20&amp;%20%5CDelta%5E%7B-1%7D%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Ctext%7Bwhere%20%7D%20%5CDelta%20=%20D%5E%5Ctop%20D%20-%20D%5E%5Ctop%20X%20(X%5E%5Ctop%20X)%5E%7B-1%7D%20X%5E%5Ctop%20D%20"> The estimate for <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> is then</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Chat%20%5Cgamma%20%20=%20-%5CDelta%5E%7B-1%7DD%5E%5Ctop%20X(X%5E%5Ctop%20X)%5E%7B-1%7DX%5E%5Ctop%20Y%20+%20%5CDelta%5E%7B-1%7DD%5E%5Ctop%20Y%20"> Note that the hat matrix appears in <img src="https://latex.codecogs.com/png.latex?%5CDelta"> and <img src="https://latex.codecogs.com/png.latex?%5Chat%20%5Cgamma">. After some elbow grease, it can be shown</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A%5Chat%20%5Cgamma%20&amp;=%20%5CDelta%5E%7B-1%7D%5Cbigl(D%5E%5Ctop%20Y%20-%20D%5E%5Ctop%20X%20(X%5E%5Ctop%20X)%5E%7B-1%7D%20X%5E%5Ctop%20Y%5Cbigr)%5C%5C%0A&amp;=%20%5CDelta%5E%7B-1%7D%20D%5E%5Ctop%20(I%20-%20X%20(X%5E%5Ctop%20X)%5E%7B-1%7D%20X%5E%5Ctop)%20Y%5C%5C%0A&amp;=%20(D%5E%5Ctop%20M%20D)%5E%7B-1%7D%20D%5E%5Ctop%20M%20Y%0A%5Cend%7Balign%7D%0A"></p>
<p>This proves that the application of the FWL theorem provides the same coefficients as a regression on the full matrix <img src="https://latex.codecogs.com/png.latex?Z">.</p>
</section>
<section id="quit-the-mumbo-jumbo-what-does-it-mean" class="level2">
<h2 class="anchored" data-anchor-id="quit-the-mumbo-jumbo-what-does-it-mean">Quit the Mumbo Jumbo, What Does it Mean?</h2>
<p>Focusing on the modified regression, <img src="https://latex.codecogs.com/png.latex?MY%20=%20MD%5Cgamma%20+%20Mu"> will be most helpful. Recall that <img src="https://latex.codecogs.com/png.latex?M"> is a projection matrix which projects the right multiplied vector onto <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BC%7D(X)%5E%5Cperp">. So that means that <img src="https://latex.codecogs.com/png.latex?MY"> is the part of <img src="https://latex.codecogs.com/png.latex?Y"> which is uncorrelated with the columns of <img src="https://latex.codecogs.com/png.latex?X">, and likewise <img src="https://latex.codecogs.com/png.latex?MD"> is the part of <img src="https://latex.codecogs.com/png.latex?D"> which us uncorrelated with <img src="https://latex.codecogs.com/png.latex?X">. Then, when we perform the regression of <img src="https://latex.codecogs.com/png.latex?MY"> onto <img src="https://latex.codecogs.com/png.latex?MD">, we get the effect of <img src="https://latex.codecogs.com/png.latex?D"> on <img src="https://latex.codecogs.com/png.latex?Y"> independent of <img src="https://latex.codecogs.com/png.latex?X">. That sounds a hell of a lot like <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> to me!</p>
</section>
<section id="what-happens-of-x-is-a-bunch-of-indicators" class="level2">
<h2 class="anchored" data-anchor-id="what-happens-of-x-is-a-bunch-of-indicators">What Happens of <img src="https://latex.codecogs.com/png.latex?X"> is a Bunch of Indicators?</h2>
<p>Ok, so we have established that we can use the FWL theorem to get the same estimates from a modified regression, and we have a less mathematical understanding for why this happens.</p>
<p>Let’s connect the FWL theorem back to fixed effects estimation. Suppose that <img src="https://latex.codecogs.com/png.latex?X"> is our matrix of indicators in <img src="https://latex.codecogs.com/png.latex?Y%20=%20X%20%5Cbeta%20+%20D%20%5Cgamma%20+u">. We’re interested more in <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> than in <img src="https://latex.codecogs.com/png.latex?%5Cbeta">, so we’re going to partial out <img src="https://latex.codecogs.com/png.latex?X"> using FWL. In this case, <img src="https://latex.codecogs.com/png.latex?X"> a matrix of dummies, which means:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?X%5E%5Ctop%20X%20=%20%5Coperatorname%7Bdiag%7D(n_1,%20n_2,%20%5Ccdots,%20n_k)"> is a diagonal matrix in which the each entry is the count of observations within each fixed effect group</li>
<li><img src="https://latex.codecogs.com/png.latex?(X%5E%5Ctop%20X)%5E%7B-1%7D%20=%20%5Coperatorname%7Bdiag%7D(n%5E%7B-1%7D_1,%20n%5E%7B-1%7D_2,%20%5Ccdots,%20n%5E%7B-1%7D_k)"></li>
<li><img src="https://latex.codecogs.com/png.latex?H%20=%20X(X%5E%5Ctop%20X)%5E%7B-1%7DX%5E%5Ctop"> is a block-diagonal matrix where the <img src="https://latex.codecogs.com/png.latex?j">-th block is an <img src="https://latex.codecogs.com/png.latex?n_j%20%5Ctimes%20n_j"> matrix of ones scaled by <img src="https://latex.codecogs.com/png.latex?1/n_j">. Assuming the data is sorted by group, it looks like this:<img src="https://latex.codecogs.com/png.latex?H%20=%20%5Cbegin%7Bbmatrix%7D%0A%5Cfrac%7B1%7D%7Bn_1%7D%20%5Cmathbf%7BJ%7D_%7Bn_1%7D%20&amp;%20%5Cmathbf%7B0%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cmathbf%7B0%7D%20%5C%5C%0A%5Cmathbf%7B0%7D%20&amp;%20%5Cfrac%7B1%7D%7Bn_2%7D%20%5Cmathbf%7BJ%7D_%7Bn_2%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cmathbf%7B0%7D%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0A%5Cmathbf%7B0%7D%20&amp;%20%5Cmathbf%7B0%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cfrac%7B1%7D%7Bn_k%7D%20%5Cmathbf%7BJ%7D_%7Bn_k%7D%0A%5Cend%7Bbmatrix%7D">Where <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BJ%7D_%7Bn_j%7D"> is an <img src="https://latex.codecogs.com/png.latex?n_j%20%5Ctimes%20n_j"> matrix of all ones. Consequently, when this matrix <img src="https://latex.codecogs.com/png.latex?H"> is multiplied by <img src="https://latex.codecogs.com/png.latex?Y">, it produces a vector where every observation <img src="https://latex.codecogs.com/png.latex?y_%7Bij%7D"> is replaced by its group mean <img src="https://latex.codecogs.com/png.latex?%5Cbar%7By%7D_j">.</li>
</ul>
<p>So in the case where <img src="https://latex.codecogs.com/png.latex?X"> is a column of dummies <em>multiplication by <img src="https://latex.codecogs.com/png.latex?I-H"> will subtract the group level mean defined by fixed effects</em>. This is sometimes known as the “within-transform”.</p>
<p>This is a nice little insight. Rather than do all the linear algebra (which sure is fun!) we can just subtract means before doing our regression. In R, that might look like</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(modelsummary)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Within transform manually</span></span>
<span id="cb2-5">augmented_d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(body_mass_g, sex, bill_length_mm, species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sexmale =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"male"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(species) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate_at</span>(</span>
<span id="cb2-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vars</span>(body_mass_g, sexmale, bill_length_mm),</span>
<span id="cb2-11">    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(.x)</span>
<span id="cb2-12">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb2-14"></span>
<span id="cb2-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit on demeaned data (no intercept)</span></span>
<span id="cb2-16">fit_within <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(body_mass_g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sexmale <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bill_length_mm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> augmented_d)</span>
<span id="cb2-17"></span>
<span id="cb2-18"></span>
<span id="cb2-19">mods <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb2-20">  mods, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Within Transform"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fit_within)</span>
<span id="cb2-21">)</span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">modelsummary</span>(mods, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gof_map =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span></code></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_d8v8szf06wltao3ljq8s(i, j, css_id) {
          var table = document.getElementById("tinytable_d8v8szf06wltao3ljq8s");
          var cell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function spanCell_d8v8szf06wltao3ljq8s(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_d8v8szf06wltao3ljq8s");
        const targetCell = table.querySelector(`[data-row="${i}"][data-col="${j}"]`);
        if (!targetCell) {
          console.warn(`Cell at (${i}, ${j}) not found.`);
        }

        // Get all cells that need to be removed
        const cellsToRemove = [];
        for (let r = 0; r < rowspan; r++) {
          for (let c = 0; c < colspan; c++) {
            if (r === 0 && c === 0) continue; // Skip the target cell
            const cell = table.querySelector(`[data-row="${i + r}"][data-col="${j + c}"]`);
            if (cell) {
              cellsToRemove.push(cell);
            }
          }
        }

        // Remove all cells
        cellsToRemove.forEach(cell => cell.remove());

        // Set rowspan and colspan of the target cell if it exists
        if (targetCell) {
          targetCell.rowSpan = rowspan;
          targetCell.colSpan = colspan;
        }
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '10', j: 2 }, { i: '10', j: 1 }, { i: '10', j: 3 },  ], css_id: 'tinytable_css_wu9pvk479py23alr34lu',}, 
          { positions: [ { i: '2', j: 1 }, { i: '4', j: 1 }, { i: '1', j: 1 }, { i: '6', j: 1 }, { i: '3', j: 1 }, { i: '8', j: 1 }, { i: '5', j: 1 }, { i: '1', j: 3 }, { i: '7', j: 1 }, { i: '1', j: 2 }, { i: '2', j: 2 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '8', j: 2 }, { i: '9', j: 2 }, { i: '3', j: 3 }, { i: '9', j: 1 }, { i: '5', j: 3 }, { i: '2', j: 3 }, { i: '7', j: 3 }, { i: '4', j: 3 }, { i: '9', j: 3 }, { i: '6', j: 3 }, { i: '8', j: 3 },  ], css_id: 'tinytable_css_sjidxcxkqzwjyjcnolbu',}, 
          { positions: [ { i: '0', j: 1 }, { i: '0', j: 3 }, { i: '0', j: 2 },  ], css_id: 'tinytable_css_r21vis8yx134a3e0bfdy',}, 
          { positions: [ { i: '10', j: 0 },  ], css_id: 'tinytable_css_hroimhewdfmnkb5e7gu3',}, 
          { positions: [ { i: '1', j: 0 }, { i: '2', j: 0 }, { i: '3', j: 0 }, { i: '4', j: 0 }, { i: '5', j: 0 }, { i: '6', j: 0 }, { i: '7', j: 0 }, { i: '8', j: 0 }, { i: '9', j: 0 },  ], css_id: 'tinytable_css_0s1ux2ejyzh3nrivjkbk',}, 
          { positions: [ { i: '0', j: 0 },  ], css_id: 'tinytable_css_d073mbfo1cmf2hbamgi7',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_d8v8szf06wltao3ljq8s(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_wu9pvk479py23alr34lu, .table th.tinytable_css_wu9pvk479py23alr34lu { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_sjidxcxkqzwjyjcnolbu, .table th.tinytable_css_sjidxcxkqzwjyjcnolbu { text-align: center; }
      .table td.tinytable_css_r21vis8yx134a3e0bfdy, .table th.tinytable_css_r21vis8yx134a3e0bfdy { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_hroimhewdfmnkb5e7gu3, .table th.tinytable_css_hroimhewdfmnkb5e7gu3 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_0s1ux2ejyzh3nrivjkbk, .table th.tinytable_css_0s1ux2ejyzh3nrivjkbk { text-align: left; }
      .table td.tinytable_css_d073mbfo1cmf2hbamgi7, .table th.tinytable_css_d073mbfo1cmf2hbamgi7 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_d8v8szf06wltao3ljq8s" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col" data-row="0" data-col="0"> </th>
                <th scope="col" data-row="0" data-col="1">Without Fixed Effects</th>
                <th scope="col" data-row="0" data-col="2">With Fixed Effects</th>
                <th scope="col" data-row="0" data-col="3">Within Transform</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td data-row="1" data-col="0">(Intercept)</td>
                  <td data-row="1" data-col="1">2169.270</td>
                  <td data-row="1" data-col="2"></td>
                  <td data-row="1" data-col="3"></td>
                </tr>
                <tr>
                  <td data-row="2" data-col="0"></td>
                  <td data-row="2" data-col="1">(271.753)</td>
                  <td data-row="2" data-col="2"></td>
                  <td data-row="2" data-col="3"></td>
                </tr>
                <tr>
                  <td data-row="3" data-col="0">sexmale</td>
                  <td data-row="3" data-col="1">547.367</td>
                  <td data-row="3" data-col="2">547.367</td>
                  <td data-row="3" data-col="3">547.367</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="0"></td>
                  <td data-row="4" data-col="1">(43.206)</td>
                  <td data-row="4" data-col="2">(43.206)</td>
                  <td data-row="4" data-col="3">(43.010)</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="0">bill_length_mm</td>
                  <td data-row="5" data-col="1">32.537</td>
                  <td data-row="5" data-col="2">32.537</td>
                  <td data-row="5" data-col="3">32.537</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="0"></td>
                  <td data-row="6" data-col="1">(7.303)</td>
                  <td data-row="6" data-col="2">(7.303)</td>
                  <td data-row="6" data-col="3">(7.269)</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="0">speciesChinstrap</td>
                  <td data-row="7" data-col="1">-298.766</td>
                  <td data-row="7" data-col="2"></td>
                  <td data-row="7" data-col="3"></td>
                </tr>
                <tr>
                  <td data-row="8" data-col="0"></td>
                  <td data-row="8" data-col="1">(85.947)</td>
                  <td data-row="8" data-col="2"></td>
                  <td data-row="8" data-col="3"></td>
                </tr>
                <tr>
                  <td data-row="9" data-col="0">speciesGentoo</td>
                  <td data-row="9" data-col="1">1094.867</td>
                  <td data-row="9" data-col="2"></td>
                  <td data-row="9" data-col="3"></td>
                </tr>
                <tr>
                  <td data-row="10" data-col="0"></td>
                  <td data-row="10" data-col="1">(74.029)</td>
                  <td data-row="10" data-col="2"></td>
                  <td data-row="10" data-col="3"></td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>Here, the standard errors disagree because I”ve not adjusted for the excess degrees of freedom from the fixed effects.</p>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2025-11-12-glmfe/</guid>
  <pubDate>Thu, 13 Nov 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>On Climbing Hills</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-10-15-hills/</link>
  <description><![CDATA[ 





<p>I’ve been climbing this hill for what feels like a long time. I can look back and see how high I’ve climbed, the rocks I’ve had to overcome, and the gullies I nearly was trapped in. But as I look forward, all I see is more hill.</p>
<p>A lot of people are on this hill with me. Some are climbing with me, some are on other paths and we are just meeting either by accident or because this climb was more interesting to them. Some people don’t appreciate how far we’ve climbed, how much effort we had to give to get here.</p>
<p>I’m a little tired of climbing. I’d like to set up camp on this part of the hill, but I have wound up coupling my livelihood to climbing. I pay bills by climbing, and sometimes I need to climb hills I don’t really like, or am not qualified to climb. That really drains my energy for the main climb, making me want to rest even more.</p>
<p>The inability (or perhaps, desire to avoid) rest has made me irritable. When people ask me questions about climbing, I get short with them. I think I know a lot about climbing and am unable to be humble when someone shows me they are slightly higher on the hill than I am.</p>
<p>Some days, I don’t climb at all. But I think to myself, if I am not a climber then who am I?</p>
<p>I’ve learned a lot from climbing, but the remainder of the hill (should it ever end) is steeper. It might be time to find another hill, and bring the experience I’ve made on this one to a new path. New rocks, new gullies. Not sure when, but hopefully soon.</p>



 ]]></description>
  <guid>https://dpananos.github.io/posts/2025-10-15-hills/</guid>
  <pubDate>Wed, 15 Oct 2025 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Pre Randomized Experiment Differences Don’t Mean DiD is Needed</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-08-16-pre/</link>
  <description><![CDATA[ 





<p><a href="https://stats.stackexchange.com/a/669596/111259">Take a look at this interaction</a> I had with user jginestet on Cross Validated. In short, jginestet suggests that a randomized experiment assessing percent changes in tumor volume should adjust for pre-experiment differences (at this point, I’m nodding yes) and therefore the most appropriate method is DiD – difference in differences – (at this point, I’m shaking my head no).</p>
<p>User jginestet is right, pre-experiment differences should be adjusted for, but he is wrong when he suggests DiD is the way to do it. Let me explain</p>
<section id="point-1-before-intervention-treatment-and-control-are-samples-from-the-same-population" class="level2">
<h2 class="anchored" data-anchor-id="point-1-before-intervention-treatment-and-control-are-samples-from-the-same-population">Point 1: Before Intervention, Treatment and Control are Samples From The Same Population</h2>
<p>By virtue of this point, the two groups have the same pre-experiment mean outcome <em>in expectation</em>. The sample means are going to differ because of sampling variability. If <img src="https://latex.codecogs.com/png.latex?%5Cbar%7BY%7D_i"> is the sample mean in group <img src="https://latex.codecogs.com/png.latex?i%20%5Cin%20%5Cleft%5C%7Bt,%20c%5Cright%5C%7D">, then mathematically this means that <em>before intervention</em> <img src="https://latex.codecogs.com/png.latex?E%5B%5Cbar%7BY%7D_t%5D%20=%20E%5B%5Cbar%7BY%7D_c%5D%20=%20E%5BY%5D">. The same can’t be said for post intervention, and that is why we run the experiment. What does this mean for DiD?</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?%5Cbar%7BY%7D_%7Bi,%20j%7D"> indicate sample mean for group <img src="https://latex.codecogs.com/png.latex?i%20%5Cin%20%5Cleft%5C%7B%20t,%20c%20%5Cright%5C%7D"> in time period <img src="https://latex.codecogs.com/png.latex?j%20%5Cin%20%5Cleft%5C%7B%200,%201%20%5Cright%5C%7D"> (here 0 means before intervention, 1 means after intervention). DiD estimates the following quantity</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cwidehat%7B%5CDelta%7D%20=%20(%5Cbar%7BY%7D_%7Bt,%201%7D%20-%20%5Cbar%7BY%7D_%7Bt,%200%7D)%20-%20(%5Cbar%7BY%7D_%7Bc,%201%7D%20-%20%5Cbar%7BY%7D_%7Bc,%200%7D)%20%20"> If the treatment assignment is randomized, something nice happens now. Taking expectations</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0AE%5B%5Cwidehat%7B%5CDelta%7D%5D%20&amp;=%20E%5B(%5Cbar%7BY%7D_%7Bt,%201%7D%20-%20%5Cbar%7BY%7D_%7Bt,%200%7D)%20-%20(%5Cbar%7BY%7D_%7Bc,%201%7D%20-%20%5Cbar%7BY%7D_%7Bc,%200%7D)%5D%20%5C%5C%0A&amp;=%20E%5B%5Cbar%7BY%7D_%7Bt,%201%7D%5D%20-%20E%5B%5Cbar%7BY%7D_%7Bt,%200%7D%5D%20-%20E%5B%5Cbar%7BY%7D_%7Bc,%201%7D%5D%20+%20E%5B%5Cbar%7BY%7D_%7Bc,%200%7D%5D%20%5C%5C%0A&amp;=%20E%5B%5Cbar%7BY%7D_%7Bt,%201%7D%5D%20-%20E%5B%5Cbar%7BY%7D_%7B0%7D%5D%20-%20E%5B%5Cbar%7BY%7D_%7Bc,%201%7D%5D%20+%20E%5B%5Cbar%7BY%7D_%7B0%7D%5D%5C%5C%0A&amp;=%20E%5B%5Cbar%7BY%7D_%7Bt,%201%7D%5D%20-%20%5Ccancel%7BE%5B%5Cbar%7BY%7D_%7B0%7D%5D%7D%20-%20E%5B%5Cbar%7BY%7D_%7Bc,%201%7D%5D%20+%20%5Ccancel%7BE%5B%5Cbar%7BY%7D_%7B0%7D%5D%7D%20%5C%5C%0A&amp;=%20E%5B%5Cbar%7BY%7D_%7Bt,%201%7D%5D%20-%20E%5B%5Cbar%7BY%7D_%7Bc,%201%7D%5D%0A%5Cend%7Balign%7D"></p>
<p>Which is the difference in means after the intervention. DiD is not needed in randomized experiments because the pre-treatment difference is 0 in expectation. We don’t need to adjust for pre-experiment systematic differences because there are none. Both treatment and control are samples from the same population. They therefore share population parameters. This is unlike most applications of DiD where groups do not share population parameters.</p>
</section>
<section id="point-2-if-you-have-pre-experiment-data-you-should-condition-on-it" class="level2">
<h2 class="anchored" data-anchor-id="point-2-if-you-have-pre-experiment-data-you-should-condition-on-it">Point 2: If You Have Pre Experiment Data, You Should Condition On It!</h2>
<p>That being said, there is value to adjusting for pre-experiment data, just not with DiD. Consider the following simulation:</p>
<ul>
<li>I simulate a randomized experiment.</li>
<li>I have a highly correlated, pre-experiment outcome (e.g.&nbsp;could be weight in an intervention intended to help people lose weight). This is important since if the pre-experiment outcome was not correlated with post experiment outcome, the whole point of using, or even checking, pre-experiment outcomes would be moot.<br>
</li>
<li>I fit a model using treatment indication with and without the pre-experiment data.</li>
<li>I compare coverage of the confidence intervals, hoping that they would have nominal coverage.</li>
</ul>
<p>And, if you run this simulation, you find they do indeed have nominal coverage. But something interesting happens when you examine coverage as a function of the pre experiment differences. See the plot below.</p>
<p>This plot shows the coverage of the 95% confidence interval for the treatment effect within deciles of the standardized pre-experiment difference (essentially the absolute value of the z score for the difference). Note that for ANCOVA, the coverage is always at the nominal level, regardless of how big the pre-experiment differences are. But the difference in means has larger than expected coverage when pre-experiment differences are “small”, and wildly low coverage in cases where pre experiment differences are big. Despite this, <em>each method maintains nominal coverage across all simulated experiments</em>.</p>
<p>Why does this matter? This plot is telling me that, so long as the outcomes are highly correlated, then pre-experiment differences should be adjusted for … with ANCOVA. These points are nicely summarized at a higher level in the section titled “Balance of prognostic factors is necessary for valid inference” from Senn’s <a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.5713">“Seven myths of randomization in clinical trials”</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"></span>
<span id="cb1-3">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb1-4">  </span>
<span id="cb1-5">  n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-6">  treatment <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb1-7">  Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> MASS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mvrnorm</span>(n, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.85</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb1-8">  </span>
<span id="cb1-9">  y_post <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Y[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-10">  y_pre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Y[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-11">  </span>
<span id="cb1-12">  pre_experiment_z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t.test</span>(y_pre <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> treatment)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>statistic</span>
<span id="cb1-13">  </span>
<span id="cb1-14">  fit_ols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(y_post <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> treatment)</span>
<span id="cb1-15">  fit_ancova <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(y_post <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> treatment <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y_pre)</span>
<span id="cb1-16">  models <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Diff in Means'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fit_ols, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ANCOVA'</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> fit_ancova)</span>
<span id="cb1-17">  </span>
<span id="cb1-18">  models <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-19">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">imap_dfr</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb1-20">      broom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(.x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conf.int=</span>T) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-21">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(term<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'treatment'</span>)} <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-22">        <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pre_experiment_z =</span> pre_experiment_z, </span>
<span id="cb1-23">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cover =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sign</span>(conf.low) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sign</span>(conf.high)), </span>
<span id="cb1-24">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model=</span>.y)</span>
<span id="cb1-25">      )</span>
<span id="cb1-26">  </span>
<span id="cb1-27">  </span>
<span id="cb1-28">})</span>
<span id="cb1-29"></span>
<span id="cb1-30">r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(</span>
<span id="cb1-32">    model, </span>
<span id="cb1-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">decile =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ntile</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(pre_experiment_z), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb1-34">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb1-36">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">coverage =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(cover),</span>
<span id="cb1-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span></span>
<span id="cb1-38">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> decile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> coverage, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> model)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray50"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-42">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb1-44">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Coverage by Pre-Experiment Score Decile"</span>,</span>
<span id="cb1-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Decile of Pre-Experiment Difference in Means (|Z score|)"</span>,</span>
<span id="cb1-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Coverage"</span>,</span>
<span id="cb1-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model"</span></span>
<span id="cb1-48">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-52">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(</span>
<span id="cb1-53">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"top"</span></span>
<span id="cb1-54">  )</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-08-16-pre/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>So, should pre experiment imbalance be adjusted for? Well yes. We’ve seen that coverage in this case can be quite small when imbalance is big and pre experiment outcomes are highly correlated with post experiment outcomes. If you know the imbalance is big then presumably you have the data to demonstrate that, so you can adjust for it with ANCOVA.</p>
<p>Could you use DiD? Yes, you could, but there is no need to do so since the pre experiment population means are the same in expectation.</p>
<p>Those who insist on DiD in the randomized case are right – that we should adjust for pre experiment imbalance – for the wrong reasons – because I presume they think there is a systematic difference between groups; there isn’t.</p>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2025-08-16-pre/</guid>
  <pubDate>Sat, 16 Aug 2025 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Let’s Take About 15% Of The Top There</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-08-10-shrinking/</link>
  <description><![CDATA[ 





<p>I keep coming back to <a href="https://evidence.nejm.org/doi/full/10.1056/EVIDoa2300003">A New Look at P Values for Randomized Clinical Trials</a> – an instant classic paper on RCTs, which could be extended to online experimentation as well. The authors, who include Gelman and Greenland, take an empirical Bayes approach to infer the joint distribution of z statistics and the Signal to Noise Ratio (SNR, the true effect divided by the standard error) from the Cochrane Database of Systematic Reviews, thereby being able to examine the relationship between, as an example, the exaggeration factor (the amount by which the estimate of the treatment effect over estimates the truth) and the p value. It is an incredibly well written paper and I highly recommend you read it.</p>
<p>Quoting from the paper directly</p>
<blockquote class="blockquote">
<p>Recall that the z statistic is the estimated effect divided by the standard error (SE) of the estimate. We also wish to consider the signal-to-noise ratio (SNR), which is the true effect divided by the SE of the effect estimate. The SNR cannot be observed directly, but there is a very simple relation between the SNR and the z statistic. Because the estimated effect is equal to the true effect plus an independent normal error term, the z statistic is equal to the SNR plus an independent, standard normal error term.1 Thus, the distribution of the z statistic is the “convolution” of the distribution of the SNR and the standard normal distribution. The crux of our approach is that we can estimate the distribution of the absolute z statistics across the Cochrane Database and then derive the distribution of the absolute SNRs by “deconvolution,” that is, by removing the standard normal component. This allows us to study a number of important statistical properties of the RCTs in the Cochrane Database.</p>
</blockquote>
<p>The authors give the weights and standard deviations for the elements of the mixture distribution, and from these we can simulate SNRs from the population of all trails that are exchangeable with those in the database (i.e.&nbsp;trials that could be in the Cochrane Database in the future). In R…</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2">rmix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(n,p,m,s){</span>
<span id="cb1-3">  d<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmultinom</span>(n,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,p)</span>
<span id="cb1-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n,m<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span>d,s<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span>d)</span>
<span id="cb1-5">}</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard deviation for the snr</span></span>
<span id="cb1-8">s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.61</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.42</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.16</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.64</span>)</span>
<span id="cb1-9">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.32</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.07</span>)</span>
<span id="cb1-10">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb1-11">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span></span>
<span id="cb1-12">snr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmix</span>(n, p, m, s)</span>
<span id="cb1-13">z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, snr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<p>Now that we have the simulated SNR and z statistics, it is very straight forward to replicate all results from the paper. As an example, here is how we can re-create figure 2 (the distribution of statistical power across the simulated SNR).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">power <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> snr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>snr)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">hist</span>(power, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Power'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probability =</span> T)</span></code></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-08-10-shrinking/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The paper goes on to make a number of conclusions, including that most RCTs which report a statistically significant treatment effect exaggerate the effect size, sometimes dramatically so (see Figure 3, top left). This exaggeration made me think “why not just shrink the damn thing then”, and given some of the information in the paper, I think we can come up with a nice little rule of thumb: most RCTs should shrink the treatment effect by about 15%. Let’s examine why.</p>
<p>The mixture distribution for the z statistics is comprised of 4 normal distributions with standard deviation 1.17, 1.74, 2.38, and 5.73, with mixture weights 0.32, 0.3, 0.3, and 0.07. This means that the standard deviation of the mixture is 2.32. Let’s make a not-too-wrong assumption that the distribution of z values is approximately normal. Granted, this is demonstrably false – the distribution has fatter tails, but doing so will allow us to treat this distribution as a prior for future RCTs. Now, suppose we run an RCT in the future which would be exchangeable with those in the Cochrane database. Since the prior distribution of z is assumed normal, and conditional on the RCT z is also a normal random variable, then we can shrink the estimates by leveraging a conjugate normal prior.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">s_z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.17</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.74</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.38</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.73</span>)</span>
<span id="cb3-2">s_weighted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">weighted.mean</span>(s_z<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, p))</span>
<span id="cb3-3"></span>
<span id="cb3-4">new_snr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rmix</span>(n, p, m, s)</span>
<span id="cb3-5">new_z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, new_snr, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-6">shrunken_z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> new_z <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>s_weighted<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-7"></span>
<span id="cb3-8">new_exag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(new_z<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>new_snr)</span>
<span id="cb3-9">shrunken_exag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(shrunken_z<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>new_snr)</span></code></pre></div>
</div>
<p>Note that the z are multiplied by a factor which is approximately 0.843 (round up to 0.85 for a nice number, which is equivalent to a 15% reduction). Now, let’s recreate figure 3 for the shurnken estimates and compare them to the unshrunken estimates</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">p_values <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(new_z))</span>
<span id="cb4-2">p_strata <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(p_values, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(.<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)))</span>
<span id="cb4-3"></span>
<span id="cb4-4"></span>
<span id="cb4-5">df_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb4-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_strata =</span> p_strata, </span>
<span id="cb4-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Orignal =</span> new_exag,</span>
<span id="cb4-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Shrunken =</span> shrunken_exag</span>
<span id="cb4-9">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p_strata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'estimate'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exag'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb4-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(p_strata, </span>
<span id="cb4-12">           estimate</span>
<span id="cb4-13">           ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb4-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q25 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(exag, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb4-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q50 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(exag, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb4-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q75 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(exag, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb4-18">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mn =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(exag)</span>
<span id="cb4-19">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb4-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata_num =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(p_strata))</span>
<span id="cb4-21"></span>
<span id="cb4-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb4-23">dodge_width <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb4-24"></span>
<span id="cb4-25"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df_sum, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> strata_num, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb4-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-28">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Orignal"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dodge_width, dodge_width),</span>
<span id="cb4-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-30">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Orignal"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dodge_width, dodge_width),</span>
<span id="cb4-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> q25, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> q75</span>
<span id="cb4-32">  ), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span></span>
<span id="cb4-33">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb4-35">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-36">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Orignal"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dodge_width, dodge_width),</span>
<span id="cb4-37">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-38">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(estimate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Orignal"</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>dodge_width, dodge_width),</span>
<span id="cb4-39">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> q50, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> q50</span>
<span id="cb4-40">  ),</span>
<span id="cb4-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-42">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_reverse</span>(</span>
<span id="cb4-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(df_sum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>strata_num),</span>
<span id="cb4-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(p_strata),</span>
<span id="cb4-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_axis</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n.dodge =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-48">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-49">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb4-50">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P Value Strata"</span>,</span>
<span id="cb4-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exaggeration Quartiles"</span>,</span>
<span id="cb4-52">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimate'</span></span>
<span id="cb4-53">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-54">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb4-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb4-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-08-10-shrinking/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Unsurprisingly, the estimates are shrunk towards an exaggeration factor of 0.0 and results from statistically significant trials have a smaller exaggeration factor. However, we can do better. van Zwet (also an author on the paper) published a shrinkage estimator based on these data in <a href="https://onlinelibrary.wiley.com/doi/10.1002/sim.9173">Statsitics in Medicine</a> in 2021. His approach was to use <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BE%7D(%5Cmbox%7BSNR%7D%20%5Cmid%20z)"> as the shrunken estimate, and provides some code in that paper from which to estimate the conditional distribution of the SNR given z from the mixture of normals (it is actually quite clever and doesn’t require any regression, only some algebra). I’ve plotted van Zwet’s exaggeration factors below, which are even better than the normal normal conjugate model’s! Unfortunately, the shrinkage van Zwet’s shrinkage estimator doesn’t have such a simple rule of thumb which could make for a snappy, Letterkenny referencing, blog post 🤷.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">z_hat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(new_z, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb5-2">  </span>
<span id="cb5-3">  s2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> s<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb5-4">  q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(.x,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(s2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb5-5">  q <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> q<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(q)</span>
<span id="cb5-6">  m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> .x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> s2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (s2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(q <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m)</span>
<span id="cb5-8">})</span>
<span id="cb5-9"></span>
<span id="cb5-10"></span>
<span id="cb5-11">zwet_shrunken_exag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(z_hat <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> new_snr)</span>
<span id="cb5-12"></span>
<span id="cb5-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assign a numeric index per estimate for dodging</span></span>
<span id="cb5-14">df_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb5-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p_strata =</span> p_strata, </span>
<span id="cb5-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Orignal =</span> new_exag,</span>
<span id="cb5-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Shrunken =</span> shrunken_exag,</span>
<span id="cb5-18">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">van Zwet Shrunken</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> zwet_shrunken_exag</span>
<span id="cb5-19">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p_strata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'estimate'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'exag'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb5-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(p_strata, </span>
<span id="cb5-22">           estimate</span>
<span id="cb5-23">           ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb5-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q25 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(exag, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb5-26">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q50 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(exag, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb5-27">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">q75 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(exag, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb5-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mn =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(exag)</span>
<span id="cb5-29">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata_num =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(p_strata)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(p_strata) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">est_index =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(estimate, </span>
<span id="cb5-33">                                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"van Zwet Shrunken"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shrunken"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Orignal"</span>)))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb5-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ungroup</span>()</span>
<span id="cb5-35"></span>
<span id="cb5-36">bar_width <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span></span>
<span id="cb5-37"></span>
<span id="cb5-38"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df_sum, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> strata_num, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> estimate)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-39">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># IQR rectangles</span></span>
<span id="cb5-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_rect</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb5-41">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmin =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (est_index <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bar_width,</span>
<span id="cb5-42">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xmax =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (est_index <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bar_width <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bar_width,</span>
<span id="cb5-43">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> q25, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> q75</span>
<span id="cb5-44">  ),</span>
<span id="cb5-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span></span>
<span id="cb5-46">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-47">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Median lines</span></span>
<span id="cb5-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_segment</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(</span>
<span id="cb5-49">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (est_index <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bar_width,</span>
<span id="cb5-50">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xend =</span> strata_num <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (est_index <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> bar_width <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bar_width,</span>
<span id="cb5-51">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> q50, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yend =</span> q50</span>
<span id="cb5-52">  ),</span>
<span id="cb5-53">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">colour =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span></span>
<span id="cb5-54">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-55">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_hline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yintercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey50"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-56">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_reverse</span>(</span>
<span id="cb5-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(df_sum<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>strata_num),</span>
<span id="cb5-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(p_strata),</span>
<span id="cb5-59">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">guide =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">guide_axis</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n.dodge =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb5-60">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-61">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(</span>
<span id="cb5-62">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P Value Strata"</span>,</span>
<span id="cb5-63">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Exaggeration Quartiles"</span>,</span>
<span id="cb5-64">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Estimate'</span></span>
<span id="cb5-65">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-66">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_classic</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">base_size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-67">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-68">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-08-10-shrinking/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>



 ]]></description>
  <guid>https://dpananos.github.io/posts/2025-08-10-shrinking/</guid>
  <pubDate>Sun, 10 Aug 2025 04:00:00 GMT</pubDate>
</item>
<item>
  <title>More on Bayesian Statistics</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-03-17-bayes-big-deal/</link>
  <description><![CDATA[ 





<p>I recently wrote a <a href="https://www.geteppo.com/blog/bayes-vs-frequentism-can-be-a-big-deal">blog post</a> for my employer in which I made some claims regarding Bayesian statistics.</p>
<section id="claim-1-flat-priors-in-heirarchal-models-can-lead-to-pulling-apart-and-implausible-estimates" class="level1">
<h1>Claim 1: Flat Priors in Heirarchal Models Can Lead to Pulling Apart and Implausible Estimates</h1>
<p>On flat priors in hierarchical models, Gelman says</p>
<blockquote class="blockquote">
<p>A noninformative uniform prior on the coefficients is equivalent to a hierarchical N(0,tau^2) model with tau set to a very large value. This is a very strong prior distribution pulling the estimates apart, and the resulting estimates of individual coefficients are implausible.</p>
</blockquote>
<p>By “pulling the estimates apart” I assume Gelman means “not pooling/regularizing estimates” as opposed to literally pulling the estimates apart. As for the line about “implausibility” of individual coefficients, that requires some unpacking.</p>
<p>Gelman is known for picking out poor methodological papers and commenting on them. Consider <a href="https://sites.stat.columbia.edu/gelman/research/unpublished/prior_context_2.pdf">“The prior can often only be understood in the context of the likelihood”</a> in which Gelman and authors discuss a study which ostensibly demonstrated that “beautiful” people are more likely to have a daughter.</p>
<p>You’re free to read what Gelman and authors wrote, I won’t summarize it here, but in short the authors to which Gelman refers report an unusually high differential in the probability of giving birth to a girl if you are a “beautiful” person. Given what we know about the sex ratio of births and how they vary across the globe, this seems fairly extreme. Reading between the lines, I would go so far as to say Gelman would consider this estimate as “implausible”. Hence, I interpret “implausible” to mean “no different than Frequentist estimates”. That is not to say that all frequentist estimates are implausible, just that when certain estimates should be shrunk/regularized, a hierarchical model with a flat prior would fail to do so.</p>
<p>This is fairly easily demonstrated. I’m going to simulate 16 A/B tests. Each test is powered to detect a lift of 5%. However, each of the lifts from the 16 tests is drawn from a normal distribution with mean 1 and standard deviation 0.02. This means that, while not impossible to see a 5% lift, it is highly improbable and often our tests are underpowered for the true effect. This, as I understand it, is the prevailing attitude in A/B testing.</p>
<p>Each A/B test will be fed to a hierarchical model (shown below in Stan). I place a flat prior on the population mean and parameterize the prior on the population variance so that I can study how estimates change when the prior is less/more variable.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb1-1"></span>
<span id="cb1-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">data</span>{</span>
<span id="cb1-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n;</span>
<span id="cb1-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] log_rr;</span>
<span id="cb1-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] stderr;</span>
<span id="cb1-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> beta;</span>
<span id="cb1-7">}</span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">parameters</span>{</span>
<span id="cb1-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu;</span>
<span id="cb1-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; tau;</span>
<span id="cb1-11">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] z;</span>
<span id="cb1-12">}</span>
<span id="cb1-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">transformed parameters</span> {</span>
<span id="cb1-14">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] theta = mu + tau * z;</span>
<span id="cb1-15">}</span>
<span id="cb1-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">model</span> {</span>
<span id="cb1-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// No mu in the model block means a uniform prior over the domain.</span></span>
<span id="cb1-18">  tau ~ inv_gamma(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, beta);</span>
<span id="cb1-19">  z ~ std_normal();</span>
<span id="cb1-20">  log_rr ~ normal(theta, stderr);</span>
<span id="cb1-21">}</span></code></pre></div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cmdstanr)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-6"></span>
<span id="cb2-7">control_conversion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb2-8">target_lift <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span></span>
<span id="cb2-9">target_conversion <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> control_conversion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> target_lift</span>
<span id="cb2-10">design <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">power.prop.test</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p1 =</span> control_conversion, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p2 =</span> target_conversion, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">power =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb2-11">n_per_group <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ceiling</span>(design<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>n)</span>
<span id="cb2-12">n_experiments <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span></span>
<span id="cb2-13"></span>
<span id="cb2-14">results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(n_experiments, {</span>
<span id="cb2-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># In reality, we generate smaller effects than we wish we did</span></span>
<span id="cb2-16">  actual_lift <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span>
<span id="cb2-17">  actual_log_rr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(actual_lift)</span>
<span id="cb2-18">  </span>
<span id="cb2-19">  control <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_per_group, control_conversion)</span>
<span id="cb2-20">  treatment <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_per_group, control_conversion <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> actual_lift)</span>
<span id="cb2-21">  </span>
<span id="cb2-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Since the groups are the same size the two factors of log(n_per_group) cancel</span></span>
<span id="cb2-23">  observed_log_rr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(treatment) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(control)</span>
<span id="cb2-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># A Standard result from the Delta method.</span></span>
<span id="cb2-25">  sampling_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> treatment <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> control <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n_per_group</span>
<span id="cb2-26">  stderr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(sampling_var)</span>
<span id="cb2-27">  </span>
<span id="cb2-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(observed_log_rr, stderr, actual_log_rr)</span>
<span id="cb2-29">  </span>
<span id="cb2-30">})</span>
<span id="cb2-31"></span>
<span id="cb2-32">log_rr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> results[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ]</span>
<span id="cb2-33">stderr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> results[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, ]</span>
<span id="cb2-34">actual_log_rr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> results[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, ]</span>
<span id="cb2-35"></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Keep track of the RMSE from our frequentist estimates.</span></span>
<span id="cb2-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hopefully, the Hierarchical model will do better than this.</span></span>
<span id="cb2-38">observed_rmse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((log_rr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> actual_log_rr) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb2-39"></span>
<span id="cb2-40">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdstan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model.stan'</span>)</span>
<span id="cb2-41"></span>
<span id="cb2-42">beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb2-43">sims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dfr</span>(beta, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> {</span>
<span id="cb2-44">  stan_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb2-45">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> n_experiments,</span>
<span id="cb2-46">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">log_rr =</span> log_rr,</span>
<span id="cb2-47">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stderr =</span> stderr,</span>
<span id="cb2-48">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> .x</span>
<span id="cb2-49">  )</span>
<span id="cb2-50">  </span>
<span id="cb2-51">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture.output</span>(</span>
<span id="cb2-52">  fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(</span>
<span id="cb2-53">    stan_data,</span>
<span id="cb2-54">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parallel_chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb2-55">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adapt_delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>,</span>
<span id="cb2-56">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,</span>
<span id="cb2-57">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb2-58">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-59">  )</span>
<span id="cb2-60">  )</span>
<span id="cb2-61">  </span>
<span id="cb2-62">  </span>
<span id="cb2-63">  estimated <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mean</span>
<span id="cb2-64">  error <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> actual_log_rr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> estimated</span>
<span id="cb2-65">  rmse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(error <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb2-66">  max_rhat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise_draws</span>(fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">draws</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'theta'</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rhat'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rhat)</span>
<span id="cb2-67">  divs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(fit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diagnostic_summary</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>num_divergent)</span>
<span id="cb2-68">  </span>
<span id="cb2-69">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(rmse, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">beta =</span> .x, max_rhat, divs)</span>
<span id="cb2-70">  </span>
<span id="cb2-71">})</span>
<span id="cb2-72"></span>
<span id="cb2-73"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(sims<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>divs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb2-74"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(sims<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>max_rhat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.01</span>))</span></code></pre></div>
</details>
</div>
<p>Below is a plot of the relative RMSE of the estimates from the Bayesian model. I’ve rescaled the y axis so that the black line (y=1) corresponds to the RMSE from the Frequentist estimates. As you can see, more informative priors do result in better RMSE – <strong>to a point</strong>. When the prior becomes too informative, then the RMSE increases. This is due to pooling all estimates to the grand mean. Conversely, when the prior on the variance is too large, no pooling happens and results are the same as Frequentist estimates (i.e.&nbsp;implausible if they are noisy a la Gelman).</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2025-03-17-bayes-big-deal/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>So, let’s take stock. From this little simulation – which adheres the best I can to what I know about A/B testing, and is still imperfect – we have seen:</p>
<ul>
<li>It is true that uninformative priors will give you equivalent estimates to Frequentist approaches (at least in terms of RMSE).</li>
<li>You probably don’t want to be similar to Frequentist results if you can help it, because you can do better (again in terms of RMSE) by applying a little prior information.</li>
<li>You don’t even need to be that accurate with your priors. Any reduction in RMSE is good, you don’t need to find the optimal prior to reduce the RMSE. In this case, anywhere between <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20=%200.05"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta%20=%203"> is probably sufficient to reduce RMSE.</li>
<li>Setting a good prior (in this case) isn’t even that hard. Think about how variable individual experiments vary in results. You aren’t likely to see many experiments 1 lift unit away from the mean. You know, intuitively, that lift estimates are probably somewhere between -10% and 10% on a good day. Even if you were REALLY uncertain and said -50% to 50% for any given experiment, that is still a standard deviation of ~25% and hence well within the range of reducing RMSE (again, in this example. I can’t say if this applies generally).</li>
</ul>
<p>Listen, Bayesian or Frequentist, I don’t care. However, it is absolutely clear that, when you pay careful attention to the nuance, the difference between Bayes and Frequentism is a big deal despite what some will say.</p>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2025-03-17-bayes-big-deal/</guid>
  <pubDate>Tue, 18 Mar 2025 04:00:00 GMT</pubDate>
</item>
<item>
  <title>A Brief Tour of CUPED and Related Methods (Pt. 1)</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2025-03-03-cuped/</link>
  <description><![CDATA[ 





<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Randomized experiments have a rich history, almost none of which is the concern of this post. Rather, I want to focus on a tiny slice of randomized experiment literature: CUPED (Controlled-experiment Using Pre-Experiment Data). The technique has been impactful in the online randomized experiment (a.k.a. A/B Testing) community, with many vendors – Eppo included – offering the technique. Despite the popularity and impact, customers and data scientists still seem to misunderstand why CUPED works, why different implementations of the procedure (a la regression adjustment) still provide the same benefit, and why different implementations are equivalent.</p>
<p>This sequence of posts seeks to answer popular questions regarding the CUPED, and in particular frames the technique as a regression procedure first as opposed to a “new” or different technique. I discuss papers that pre-date the CUPED as well as discuss how the literature has evolved since the publication of CUPED. This is not a systematic review, nor a scoping review; this is a story of regression erasure (I kid).</p>
<p>This post in particular will demonstrate the equivlence between CUPED and regression.</p>
</section>
<section id="set-up" class="level1">
<h1>Set Up</h1>
<p>Most of this blog post concerns online randomized experiments or “A/B tests” as they are known in industry. Generally, subjects will be exposed to treatment or control at some known probability (usually 50/50 since this is the most efficient design). Some outcome, <img src="https://latex.codecogs.com/png.latex?Y">, is then recorded and groups are compared statistically. Various estimands are used in industry, but for simplicity we will use the average treatment effect as our estimand of choice.</p>
</section>
<section id="cuped-for-those-who-dont-know" class="level1">
<h1>CUPED: For Those Who Don’t Know</h1>
<p>Deng and colleagues published CUPED in their 2013 paper <a href="https://exp-platform.com/Documents/2013-02-CUPED-ImprovingSensitivityOfControlledExperiments.pdf">“Improving the Sensitivity of Online Controlled Experiments by Utilizing Pre-Experiment Data”</a>. The main motivation for the paper is increasing sensitivity of experiments to detect smaller effects, detect effects faster, or both. Deng et. al motivate their approach through “control variates”. Briefly – and aside from experimentation for a moment – given pairs of random variables <img src="https://latex.codecogs.com/png.latex?(Y_i,%20X_i)"> in which <img src="https://latex.codecogs.com/png.latex?E%5BX%5D"> is known, define</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7BY%7D_%7Bc%20v%7D=%5Cbar%7BY%7D-%5Ctheta%20%5Cbar%7BX%7D+%5Ctheta%20E%5BX%5D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is an arbitrary constant. It can be shown that <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7BY%7D_%7Bc%20v%7D"> is an unbiased estimator of <img src="https://latex.codecogs.com/png.latex?E%5BY%5D">. Because <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is arbitrary, we can choose a <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> so that the variance of the estimator is minimized. The variance of <img src="https://latex.codecogs.com/png.latex?%5Cwidehat%7BY%7D_%7Bc%20v%7D"> is</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0A%5Coperatorname%7BVar%7D(%5Cwidehat%7BY%7D_%7Bc%20v%7D)%20&amp;=%20%5Coperatorname%7BVar%7D(%5Cbar%7BY%7D-%5Ctheta%20%5Cbar%7BX%7D+%5Ctheta%20E%5BX%5D)%5C%5C%0A&amp;=%5Cdfrac%7B1%7D%7Bn%7D%20%5Cleft(%20%5Coperatorname%7BVar%7D(Y)%20+%20%5Ctheta%5E2%20%5Coperatorname%7BVar%7D(X)%20-%202%5Ctheta%5Coperatorname%7BCov%7D(X,Y)%20%5Cright)%0A%5Cend%7Balign%7D"></p>
<p>and is notably quadratic in <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. Application of elementary calculus shows that the variance is then minimized when</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Ctheta%20=%20%5Cdfrac%7B%5Coperatorname%7BCov%7D(Y,%20X)%7D%7B%5Coperatorname%7BVar%7D(X)%7D%20"> and further algebraic manipulation shows</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Coperatorname%7Bvar%7D%5Cleft(%5Cwidehat%7BY%7D_%7Bc%20v%7D%5Cright)=%5Coperatorname%7Bvar%7D(%5Cbar%7BY%7D)%5Cleft(1-%5Crho%5E2%5Cright)%20"> where <img src="https://latex.codecogs.com/png.latex?%5Crho%20=%20%5Coperatorname%7BCor%7D(Y,%20X)">.</p>
<p>In short, the standard error of the mean can be reduced so long as there is some other variable, <img src="https://latex.codecogs.com/png.latex?X">, correlated with <img src="https://latex.codecogs.com/png.latex?Y">, where larger correlations lead to more variance reduction.</p>
<p>Back to experimentation, the insight in the CUPED paper was that while finding an <img src="https://latex.codecogs.com/png.latex?X"> with known expectation is hard, the <em>difference</em> in expectations for any random variable in the pre-treatment period is 0. Deng et. al then estimate the difference in means between treatment in control by computing the control variate versions of outcomes in each group and then estimating the difference in means using <sup>1</sup></p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5CDelta_%7Bc%20v%7D=%5Cwidehat%7BY%7D_%7Bc%20v%7D%5E%7B(t)%7D-%5Cwidehat%7BY%7D_%7Bc%20v%7D%5E%7B(c)%7D%20%5C%3E.%20"></p>
<p>In the remainder of the paper, Deng et. al provide some recommendations on choosing <img src="https://latex.codecogs.com/png.latex?X">, landing on the recommendation to “[…]to use the same variable from the pre-experiment period as the covariate” – i.e.&nbsp;to use the pre-experiment outcome as the control variable. Deng et. al write</p>
<blockquote class="blockquote">
<p>It is interesting to point out the connection with linear regression. The optimal <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> tunrs out to be the ordinary least squares (OLS) solution regressing (centered) <img src="https://latex.codecogs.com/png.latex?Y"> on (centered) <img src="https://latex.codecogs.com/png.latex?X"></p>
</blockquote>
<p>so the connection to regression was clearly made to readers. As we will see, the method is formally equivalent to regression, but in order to see this more clearly we will need the Frisch Waugh Lovell theorem.</p>
</section>
<section id="frisch-waugh-lovell-theorem-for-those-who-dont-know" class="level1">
<h1>Frisch Waugh Lovell Theorem: For Those Who Don’t Know</h1>
<p>Econometricians will know the Frisch Waugh Lovell (FWL) theorem well. Borrowing from wikipedia, the theorem states that the estimate for <img src="https://latex.codecogs.com/png.latex?%5Cbeta_2"> in the model (henceforth full model)</p>
<p><img src="https://latex.codecogs.com/png.latex?%20Y%20=%20X_1%20%5Cbeta_1%20+%20X_2%20%5Cbeta_2%20+u%20"> will be the same as the estimate of <img src="https://latex.codecogs.com/png.latex?%5Cbeta_2"> in the model (henceforth FWL model)</p>
<p><img src="https://latex.codecogs.com/png.latex?M_%7BX_1%7D%20Y=M_%7BX_1%7D%20X_2%20%5Cbeta_2+M_%7BX_1%7D%20u"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?M_%7BX_1%7D%20=%20I-X_1(X%5ET_1X_1)%5E%7B-1%7DX_1%5ET">. Squint hard enough and you will see that the projection, or hat, matrix appears in <img src="https://latex.codecogs.com/png.latex?M_%7BX_1%7D">. The FWL theorem then says, more or less,</p>
<blockquote class="blockquote">
<p>First regress <img src="https://latex.codecogs.com/png.latex?Y"> onto <img src="https://latex.codecogs.com/png.latex?X_1"> and compute the residuals. Then, regress <img src="https://latex.codecogs.com/png.latex?X_2"> onto <img src="https://latex.codecogs.com/png.latex?X_1"> and compute the residuals. The regression of the result from the first operation onto the result from the second operation will yield the same estimate of <img src="https://latex.codecogs.com/png.latex?%5Cbeta_2">.</p>
</blockquote>
<p>The proof can (probably) be found in most econometrics textbooks, but for now we will suffice for an example in R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(am <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> vs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mpg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>mtcars)</span>
<span id="cb1-2"></span>
<span id="cb1-3">(ols_estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(fit)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vs'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        vs 
-0.4072501 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">r1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resid</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(am <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> mpg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>mtcars))</span>
<span id="cb3-2">r2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">resid</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(vs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> mpg, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>mtcars))</span>
<span id="cb3-3"></span>
<span id="cb3-4">fwl_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(r1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>r2)</span>
<span id="cb3-5"></span>
<span id="cb3-6">(fwl_estimate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(fwl_fit)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r2'</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        r2 
-0.4072501 </code></pre>
</div>
</div>
<p>The procedure described above is sometimes called “partialling out” or “residualizing”. Point estimates and standard errors should be the same from both procedures (note that you have to adjust the partialled out estimate of the standard error so that it has the same degrees of freedom as the full estimate, see code below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">(se_vs_full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"vs"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Std. Error"</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1816192</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">se_vs_fwl_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fwl_fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>coefficients[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Std. Error"</span>]</span>
<span id="cb7-2"></span>
<span id="cb7-3">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(mtcars)</span>
<span id="cb7-4">p_full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(fit))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of parameters in full model</span></span>
<span id="cb7-5">p_fwl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(fwl_fit))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of parameters in FWL regression</span></span>
<span id="cb7-6"></span>
<span id="cb7-7">sigma2_full <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p_full)</span>
<span id="cb7-8">sigma2_fwl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">residuals</span>(fwl_fit)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p_fwl)</span>
<span id="cb7-9"></span>
<span id="cb7-10">(se_vs_fwl_corrected <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> se_vs_fwl_raw <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(sigma2_full <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sigma2_fwl))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1816192</code></pre>
</div>
</div>
<p>Note also that the standard error from either the FWL model or the full model is smaller than it would be had <img src="https://latex.codecogs.com/png.latex?X_2"> (or <code>vs</code> in my example) been the only variable in the regression. While I omit a proof of this claim, the intuition is straight forward. When including <img src="https://latex.codecogs.com/png.latex?X_1"> in the regression (either in the full or FWL model), some of the variation in <img src="https://latex.codecogs.com/png.latex?Y"> will be explained by variation in <img src="https://latex.codecogs.com/png.latex?X_1">. This leads to smaller residual variation, which in turn shrinks the sampling variability of the coefficient for <img src="https://latex.codecogs.com/png.latex?X_2">. Hence <em>variance is reduced by including <img src="https://latex.codecogs.com/png.latex?X_1"></em> in the regression. Furthermore, there is little risk of inflated standard errors due to collinearity since <img src="https://latex.codecogs.com/png.latex?X_2"> is independent of <img src="https://latex.codecogs.com/png.latex?X_1"> and hence uncorrelated in expectation. Hence, variance should only decrease when adjusting for pre-treatment variables correlated with <img src="https://latex.codecogs.com/png.latex?Y">.</p>
</section>
<section id="why-you-cant-spell-cuped-without-fwl" class="level1">
<h1>Why You Can’t Spell CUPED without FWL</h1>
<p>Let’s bring this all together.<sup>2</sup> I’m going to start with a regression model and apply the FWL theorem in order to prove that CUPED is equivalent to regression.</p>
<p>Let <img src="https://latex.codecogs.com/png.latex?(Y,%20X,%20D)"> be a triple of random variables such that</p>
<ol type="1">
<li><img src="https://latex.codecogs.com/png.latex?E%5BY%5D%20=%20E%5BX%5D%20=%20E%5BD%5D%20=%200"></li>
<li><img src="https://latex.codecogs.com/png.latex?D"> is a randomly assigned binary treatment indicator and takes on values <img src="https://latex.codecogs.com/png.latex?%5C%7B-0.5,%200.5%5C%7D">. This is mostly for convenience.</li>
<li><img src="https://latex.codecogs.com/png.latex?Y,%20X%20%5Cperp%20D"> due to randomization</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Coperatorname%7BCov%7D(Y,%20X)%20%20%5Cneq%200"></li>
<li>The true data generating mechanism is <img src="https://latex.codecogs.com/png.latex?Y%20=%20%5Ctheta%20X%20+%20%5CDelta%20D%20+%20%5Cepsilon"> with <img src="https://latex.codecogs.com/png.latex?E%5B%5Cepsilon%5D%20=%200"> and <img src="https://latex.codecogs.com/png.latex?E%5B%5Cepsilon%20D%5D%20=%200">.</li>
</ol>
<p>First, partial out the effect of <img src="https://latex.codecogs.com/png.latex?X"> on <img src="https://latex.codecogs.com/png.latex?Y"> by regression <img src="https://latex.codecogs.com/png.latex?Y"> on <img src="https://latex.codecogs.com/png.latex?X">. The residual <img src="https://latex.codecogs.com/png.latex?r_1"> is defined as</p>
<p><img src="https://latex.codecogs.com/png.latex?%20r_1%20=%20Y%20-%20%5Chat%7B%5Ctheta%7DX%20"></p>
<p>with <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Ctheta%7D%20=%20%5Coperatorname%7BCov%7D(Y,%20X)%20/%20%5Coperatorname%7BVar%7D(X)">. Note that this choice of <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> minimizes the variance of <img src="https://latex.codecogs.com/png.latex?r_1">.</p>
<p>Second, partial out the effect of <img src="https://latex.codecogs.com/png.latex?X"> on <img src="https://latex.codecogs.com/png.latex?D"> by computing</p>
<p><img src="https://latex.codecogs.com/png.latex?r_2%20=%20D-%5Chat%7B%5Cbeta%7D%20X%20"></p>
<p>Since <img src="https://latex.codecogs.com/png.latex?D"> is assumed independent of <img src="https://latex.codecogs.com/png.latex?X">, then <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bbeta%7D=0"> and therefore <img src="https://latex.codecogs.com/png.latex?r_2=D">.</p>
<p>By the FWL theorem, the coefficeint <img src="https://latex.codecogs.com/png.latex?%5CDelta"> can be estimated using the following regression</p>
<p><img src="https://latex.codecogs.com/png.latex?%20r_1%20=%20%5CDelta%20r_2%20+%20%5Cvarepsilon%20=%20%5CDelta%20D%20+%20%5Cvarepsilon%20"> Since <img src="https://latex.codecogs.com/png.latex?D"> is binary and treatment corresponds to a unit change in <img src="https://latex.codecogs.com/png.latex?D">, this model estimates the difference in means between the two groups. The difference in means is</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5CDelta%20=%20E%5BY%20-%20%5Chat%7B%5Ctheta%7D%20X%20%5Cmid%20D=0.5%5D%20-%20E%5BY%20-%20%5Chat%7B%5Ctheta%7D%20X%20%5Cmid%20D=-0.5%5D"></p>
<p>which is equivalent to the CUPED estimator.</p>
<p>Statistics, machine learning, and online experimentation are just different dialects of the same language. It can be useful to be proficient in all dialects because that means we can borrow ideas from one to apply to the other without the need to re-invent the wheel. Now that we know CUPED is just regression, we can just skip right to fitting a linear model and interpreting the coefficient knowing that we benefit from the variance reduction CUPED promises us.</p>
<p>I want to bring special attention to a quote from the CUPED paper regarding the choice of <img src="https://latex.codecogs.com/png.latex?%5Ctheta">.</p>
<blockquote class="blockquote">
<p>There is a slight subtlety that’s worth pointing out. The pair <img src="https://latex.codecogs.com/png.latex?(Y,%20X)"> may have different distributions in treatment and control when there is an experiment effect. For <img src="https://latex.codecogs.com/png.latex?%5CDelta_%7Bcv%7D"> to be unbiased, the same <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> has to be used for both control and treatment. The simplest way to estimate it is from the pooled population of control and treatment. The impact on variance reduction will likely be negligible.</p>
</blockquote>
<p>In the next post in this series, we’ll examine this statement more closely along with earler criticisms of the use of OLS for estimating the average treatment effect in randomized experiments.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The algebraic details are as follows. Let <img src="https://latex.codecogs.com/png.latex?Y_i%5E%7B(t)%7D"> be an outcome in the treatment group and let <img src="https://latex.codecogs.com/png.latex?Y_i%5E%7B(c)%7D"> be an outcome in the control group. Then <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%20%5CDelta_%7Bc%20v%7D&amp;=%5Cwidehat%7BY%7D_%7Bc%20v%7D%5E%7B(t)%7D-%5Cwidehat%7BY%7D_%7Bc%20v%7D%5E%7B(c)%7D%5C%5C%0A&amp;=%20%5Cbar%7BY%7D%5E%7B(t)%7D-%5Ctheta%20%5Cbar%7BX%7D%5E%7B(t)%7D+%5Ctheta%20E%5BX%5E%7B(t)%7D%5D%20-%20(%5Cbar%7BY%7D%5E%7B(c)%7D-%5Ctheta%20%5Cbar%7BX%7D%5E%7B(c)%7D+%5Ctheta%20E%5BX%5E%7B(c)%7D%5D%20)%0A%5Cend%7Balign%7D"> Note that prior to the treatment <img src="https://latex.codecogs.com/png.latex?E%5BX%5E%7B(t)%7D%5D%20=%20E%5BX%5E%7B(c)%7D%5D">. Deng et. al also recommend using the same <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> for both treatment and control groups, which we will see in a future post can be improved upon.↩︎</p></li>
<li id="fn2"><p>Hat tip Evan Miller, I saw this section’s title in an internal doc and had a good laugh.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://dpananos.github.io/posts/2025-03-03-cuped/</guid>
  <pubDate>Mon, 03 Mar 2025 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Calibration of Mind Changing for Bayesian AB Tests</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-09-01-ab-length/</link>
  <description><![CDATA[ 





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Bayesian decision making with loss functions was a very popular with stakeholders and data scientists when I was working in AB testing. In short, eschew p values instead ask “If I made this decision, and I was wrong, what do I stand to lose?” and then make the decision which minimizes your expected loss. In my opinion, and from what I’ve heard from others, this is an attractive method because it places the thing we care most about (usually revenue, or improvement to the metric) at the heart of the decision.</p>
<p>But while Bayes is nice for decision making, I would always get the same question from stakeholders: “How long do we run the experiment”? As a frequentist, you can answer this by appealing to statistical power, but Bayes has at least more options. Kruschke <sup>1</sup> argues for using posterior precision as a stopping criterion, others (e.g.&nbsp;David Robinson<sup>2</sup>) have mentioned setting some threshold for expected loss. These seem to be the most popular from what I’ve read, and I think both of these make a lot of sense – especially the stopping criterion based on precision. But that doesn’t really answer my question. I want to answer “how long do we have to run the experiment”, which should be answered in a unit of time and not “until your precision is <img src="https://latex.codecogs.com/png.latex?x">”. Answering in this way just results in another question, such as “how much precision do I need”. Additionally, these approaches have no time element – the experiment could go on for much longer than we might be willing to accept, and we may still not reach our stopping criterion. What do we do in those cases, and how do we understand the trade offs? How do I prevent stakeholders from using the stopping without the stopping criterion as precedence for running under powered experiments? I don’t have answers to those questions.</p>
<p>When I asked about this on twitter, a few people mentioned <a href="https://en.wikipedia.org/wiki/Expected_value_of_sample_information">The Expected Value of Sample Information</a> (EVSI) which I think is closer to what I want. In short, the EVSI helps us understand the change in expected loss the decision maker could obtain from getting access to an additional sample before making a decision. This is closer to what I want, because now I could say to a stakeholder “Don’t/Stop now, there is a <img src="https://latex.codecogs.com/png.latex?p%5C%25"> chance the results would change in a week”. It may not be a direct answer for how long, but its closer. Additionally, Carl Vogel (then of Babylist) seemed to be using this approach, as explained in his posit::conf 2023 talk<sup>3</sup>, so it seems like SOMEONE is doing this already and I’m not just crazy.</p>
<p>I think the EVSI approach is good, but I have lingering questions, mostly about calibration. So in this post, I want to run a few simulations to see how well calibrated this procedure can be in the case where we run an experiment with two variants and a binomial outcome. I’ll set up some math as a refresher, then we’ll dive into the simulations.</p>
</section>
<section id="refresher-on-decision-making" class="level2">
<h2 class="anchored" data-anchor-id="refresher-on-decision-making">Refresher on Decision Making</h2>
<p>Suppose I launch a test with two variants. I’m interested in estimating each variant’s mean outcome, <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> (which for all intents and purposes could a conversion rate for some process). I collect some data, <img src="https://latex.codecogs.com/png.latex?y">, and I get posterior distributions for each <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, <img src="https://latex.codecogs.com/png.latex?p(%5Ctheta%20%5Cmid%20y)">. I need to make a decision about which variant to launch, and I want to do that based on their mean outcomes, but I don’t know the mean outcomes perfectly. One way to make the decision is through minimizing expected loss. Let <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(%5Ctheta_A,%20%5Ctheta_B,%20x)"> be the loss I would incur were I to launch variant <img src="https://latex.codecogs.com/png.latex?x"> (e.g.&nbsp;A/B) when in truth <img src="https://latex.codecogs.com/png.latex?%5Cneg%20x"> (e.g.&nbsp;B/A) was the superior variant. The expected loss for shipping <img src="https://latex.codecogs.com/png.latex?x"> is provided by the following integral</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5B%5Cmathcal%7BL%7D%5D(x)%20=%20%5Cint_%7B%5Ctheta_A%7D%20%5Cint_%7B%5Ctheta_%7BB%7D%7D%20%5Cmathcal%7BL%7D(%5Ctheta_A,%20%5Ctheta_B,%20x)%20p(%5Ctheta_A,%20%5Ctheta_%7BB%7D%20%5Cmid%20y_B,%20y_B)%20%5C,%20d%5Ctheta_A%20%5C,%20d%5Ctheta_B%20%5C%3E,%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?p"> is the joint posterior distribution of <img src="https://latex.codecogs.com/png.latex?%5Ctheta_A,%20%5Ctheta_B">. The decision, <img src="https://latex.codecogs.com/png.latex?D">, we should make is to launch the variant which results in smallest expected loss</p>
<p><img src="https://latex.codecogs.com/png.latex?%20D%20=%20%20%5Cunderset%7B%7Bx%20%5Cin%20%5C%7BA,%20B%5C%7D%7D%7D%7B%5Coperatorname%7Barg%20min%7D%7D%20%5Cleft%5C%7B%20E%5B%5Cmathcal%7BL%7D%5D(x)%20%20%5Cright%5C%7D%20%5C%3E.%20"></p>
<p>For more on this sort of evaluation for AB testing, see <a href="https://www.chrisstucchio.com/pubs/VWO_SmartStats_technical_whitepaper.pdf">this report</a> by Chris Stucchio. In what follows, I’m going to use the following loss function</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmathcal%7BL%7D(%5Ctheta_A,%20%5Ctheta_b,%20x)%20=%20%5Cbegin%7Bcases%7D%20&amp;%20%5Cmax(%5Ctheta_B-%5Ctheta_A,%200)%20%5C%3E,%20&amp;%20x=A%20%5C%5C%5C%5C%20&amp;%20%5Cmax(%5Ctheta_A-%5Ctheta_B,%200)%20%5C%3E,%20&amp;%20x=B%5Cend%7Bcases%7D%20%5C%3E%20"></p>
<p>I interpret this loss function to be the improvement to the mean outcome we would has missed out on, had we shipped the wrong variant. As an example, if we ship A but B is truly better, then we lose out on a total of <img src="https://latex.codecogs.com/png.latex?%5Ctheta_B%20-%20%5Ctheta_A">. If we ship A and A is truly the superior variant, then we lose out on 0 improvement to the metric (because we chose right). Note that this works for revenue too! This decision can be written succinctly in code using draws from the posterior as follows</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">decision <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(draws_a, draws_b){</span>
<span id="cb1-2">  diff <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draws_b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> draws_a</span>
<span id="cb1-3">  loss_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(diff, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb1-4">  loss_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>diff, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb1-5">  </span>
<span id="cb1-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(loss_a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> loss_b){</span>
<span id="cb1-7">    winner <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span></span>
<span id="cb1-8">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb1-9">    winner <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span></span>
<span id="cb1-10">  }</span>
<span id="cb1-11">  </span>
<span id="cb1-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">winner=</span>winner, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss_a=</span>loss_a, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">loss_b=</span>loss_b)</span>
<span id="cb1-13">}</span></code></pre></div>
</div>
</section>
<section id="quick-primer-on-evsi" class="level2">
<h2 class="anchored" data-anchor-id="quick-primer-on-evsi">Quick Primer on EVSI</h2>
<p>The expected loss from the optimal decision given the data <img src="https://latex.codecogs.com/png.latex?y_A,%20y_B"> would be</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign*%7D%20E%5B%5Cmathcal%7BL%7D%5D(D)%20&amp;=%20%20%20%5Cunderset%7B%7Bx%20%5Cin%20%5C%7BA,%20B%5C%7D%7D%7D%7B%5Coperatorname%7Bmin%7D%7D%20%5Cleft%5C%7B%20E%5B%5Cmathcal%7BL%7D%5D(x)%20%20%5Cright%5C%7D%20%5C%5C%20&amp;=%20%5Cunderset%7B%7Bx%20%5Cin%20%5C%7BA,%20B%5C%7D%7D%7D%7B%5Coperatorname%7Bmin%7D%7D%20%20%5Cint_%7B%5Ctheta_A%7D%20%5Cint_%7B%5Ctheta_%7BB%7D%7D%20%5Cmathcal%7BL%7D(%5Ctheta_A,%20%5Ctheta_B,%20x)%20p(%5Ctheta_A,%20%5Ctheta_%7BB%7D%20%5Cmid%20y_A,%20y_B)%20%5C,%20d%5Ctheta_B%20%5C,%20d%5Ctheta_A%20%20%5Cend%7Balign*%7D%20"></p>
<p>Suppose I had the opportunity to gain additional samples. Were I to observe <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7By%7D_A,%20%5Ctilde%7By%7D_B">, the expected loss would be</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5B%5Cmathcal%7BL%7D%5D(%5Ctilde%7BD%7D)=%20%5Cunderset%7B%7Bx%20%5Cin%20%5C%7BA,%20B%5C%7D%7D%7D%7B%5Coperatorname%7Bmin%7D%7D%20%20%5Cint_%7B%5Ctheta_A%7D%20%5Cint_%7B%5Ctheta_%7BB%7D%7D%20%5Cmathcal%7BL%7D(%5Ctheta_A,%20%5Ctheta_B,%20x)%20p(%5Ctheta_A,%20%5Ctheta_%7BB%7D%20%5Cmid%20y_A%20+%20%5Ctilde%7By%7D_A,%20y_B%20+%20%5Ctilde%7By%7D_B)%20%5C,%20d%5Ctheta_B%20%5C,%20d%5Ctheta_A%20%20"> where <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7BD%7D"> is the optimal decision from the new data. Of course, we can’t say what this optimal decision would be since we don’t know the new data. But, having a model for these data, we could sample from that model and integrate over the uncertainty for <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7By%7D_A,%20%5Ctilde%7By%7D_B">. That means we would compute</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5B%5Cmathcal%7BL%7D%5D(%5Ctilde%7BD%7D)=%20%5Cint_%7B%5Ctheta_a%7D%20%5Cint_%7B%5Ctheta_b%7D%5Cunderset%7B%7Bx%20%5Cin%20%5C%7BA,%20B%5C%7D%7D%7D%7B%5Coperatorname%7Bmin%7D%7D%20%20%5Cint_%7B%5Ctilde%7B%5Ctheta%7D_A%7D%20%5Cint_%7B%5Ctilde%7B%5Ctheta%7D_%7BB%7D%7D%20%5Cmathcal%7BL%7D(%5Ctilde%7B%5Ctheta%7D_A,%20%5Ctilde%7B%5Ctheta%7D_B,%20x)%20p(%5Ctilde%7B%5Ctheta%7D_A,%20%5Ctilde%7B%5Ctheta%7D_%7BB%7D%20%5Cmid%20y_A%20+%20%5Ctilde%7By%7D_A,%20y_B%20+%20%5Ctilde%7By%7D_B)%20p(%5Ctilde%7By%7D_A,%20%5Ctilde%7By%7D_B%20%5Cmid%20%5Ctheta_A,%20%5Ctheta_B%20)%20p(%5Ctheta_A,%20%5Ctheta_B%20%5Cmid%20y_A,%20y_B)%20%5C,%20d%5Ctilde%7B%5Ctheta%7D_B%20%5C,%20d%5Ctilde%7B%5Ctheta%7D_A%20%20%5C,%20d%5Ctheta_B%20%5C,%20d%5Ctheta_A%20"></p>
<p>Now, this looks like a right hairy integral. However, its straightforward to understand. Consider the following process:</p>
<ul>
<li>Use the posterior predictive (<img src="https://latex.codecogs.com/png.latex?p(%5Ctilde%7By%7D_A,%20%5Ctilde%7By%7D_B%20%5Cmid%20%5Ctheta_A,%20%5Ctheta_B%20)%20p(%5Ctheta_A,%20%5Ctheta_B%20%5Cmid%20y_A,%20y_B)">) to sample data you would have seen were you to continue the experiment.</li>
<li>Act as if that data was the true data and condition your model on it to obtain your future updated posterior (<img src="https://latex.codecogs.com/png.latex?p(%5Ctilde%7B%5Ctheta%7D_A,%20%5Ctilde%7B%5Ctheta%7D_%7BB%7D%20%5Cmid%20y_A%20+%20%5Ctilde%7By%7D_A,%20y_B%20+%20%5Ctilde%7By%7D_B)">)</li>
<li>Compute the optimal loss for each decision having seen that data</li>
<li>Determine what decision you would make had that been the data you would have seen.</li>
<li>Repeat for as many draws from the posterior predictive as you like, and average over samples.</li>
</ul>
<p>The EVSI should then be</p>
<p><img src="https://latex.codecogs.com/png.latex?EVSI%20=%20E%5B%5Cmathcal%7BL%7D%5D(D)%20-%20%20E%5B%5Cmathcal%7BL%7D%5D(%5Ctilde%7BD%7D)%20"></p>
<p>which can be understood as the expected reduction in expected loss were you to continue sampling.</p>
</section>
<section id="evsi-changing-ones-mind-and-calibration" class="level2">
<h2 class="anchored" data-anchor-id="evsi-changing-ones-mind-and-calibration">EVSI, Changing One’s Mind, and Calibration</h2>
<p>While EVSI can be used to determine if one should continue to sample based on costs and expected benefits, I am interested in a slightly different question. Ostensibly, EVSI can be used to justify continued sampling in the event one variant looks like a winner because, as Carl Vogel says, “[each future] posterior may not change my mind at all based on what I was going to do under the prior. They may change my mind a lot based on what I was going to do under the prior”. This leads me to ask about calibration for changing my mind. If this procedure tells me there is a <img src="https://latex.codecogs.com/png.latex?p%5C%25"> I change my mind about which variant to ship, do I actually change my mind <img src="https://latex.codecogs.com/png.latex?p%5C%25"> of the time?</p>
<p>The answer is “Yea, kind of”! To see this, let’s do some simulation. I’ll simulate some data from a two variant AB test with a binary outcome. Then, I will compute the EVSI and determine if more data might change my mind as to what variant I might ship. Then, I’ll simulate additional data from the truth to see if my mind would have changed.</p>
<p>From there we can determine the calibration by looking at the proportion of simulations in which my mind actually changed, versus the proportion of simulations in which the EVSI computation forecasted I would have changed my mind. The code is in the cell below if you want to look at how I do this.</p>
<p>Here is a high level overview of the simulation:</p>
<ul>
<li>The true probability in group A is 10%.</li>
<li>The true probability in group B is 10.3% (a 3% lift).</li>
<li>We get 20, 000 subjects in the experiment per week, which is 10, 000 in each group per week.</li>
<li>We run the experiment for a single week and ask “If I ran for one more week, might I change my mind about what I ship”?</li>
<li>We use a beta binomial model for the analysis, and we have an effective prior sample size of 1000 (our priors are <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%20100"> and <img src="https://latex.codecogs.com/png.latex?%5Cbeta=900">).</li>
</ul>
<p>I realize there are a lot of hyperparameters we could tune here: More/fewer samples, higher/lower lift, day of week effects, etc etc. I’m going to keep it very simple for now and let you experiment as you see fit. This also means I can’t make sweeping statements about how well this performs or not.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-2"></span>
<span id="cb2-3">true_probability_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb2-4">true_lift <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.03</span></span>
<span id="cb2-5"></span>
<span id="cb2-6">true_probability_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> true_probability_a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> true_lift</span>
<span id="cb2-7">N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span></span>
<span id="cb2-8">nsims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb2-9"></span>
<span id="cb2-10">ALPHA <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb2-11">BETA <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">900</span></span>
<span id="cb2-12"></span>
<span id="cb2-13">future<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plan</span>(future<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>multisession, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">workers=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb2-14">results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> furrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">future_map_dfr</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nsims, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb2-15">  </span>
<span id="cb2-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Run the experiment and observe outcomes</span></span>
<span id="cb2-17">  ya <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, true_probability_a)</span>
<span id="cb2-18">  yb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, true_probability_b)</span>
<span id="cb2-19">  </span>
<span id="cb2-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the posterior</span></span>
<span id="cb2-21">  posterior_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, ALPHA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ya, BETA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ya)</span>
<span id="cb2-22">  posterior_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, ALPHA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> yb, BETA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yb)</span>
<span id="cb2-23">  </span>
<span id="cb2-24">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># What decision would we make RIGHT NOW if we had to?</span></span>
<span id="cb2-25">  out_now <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">decision</span>(posterior_a, posterior_b)</span>
<span id="cb2-26">  current_decision <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> out_now<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>winner</span>
<span id="cb2-27">  current_loss_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> out_now<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>loss_a</span>
<span id="cb2-28">  current_loss_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> out_now<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>loss_b</span>
<span id="cb2-29">  </span>
<span id="cb2-30">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># What might we see in the future, conditioned on what we know now?</span></span>
<span id="cb2-31">  forecasted_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>nsims, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>{</span>
<span id="cb2-32">    </span>
<span id="cb2-33"></span>
<span id="cb2-34">    theta_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(posterior_a, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-35">    theta_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(posterior_b, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-36">    </span>
<span id="cb2-37">    </span>
<span id="cb2-38">    future_y_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, theta_a)</span>
<span id="cb2-39">    future_y_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, theta_b)</span>
<span id="cb2-40">    </span>
<span id="cb2-41">    future_posterior_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, ALPHA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ya <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> future_y_a, BETA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ya <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> future_y_a)</span>
<span id="cb2-42">    future_posterior_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, ALPHA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> yb <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> future_y_b, BETA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yb <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> future_y_b)</span>
<span id="cb2-43">    </span>
<span id="cb2-44">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">decision</span>(future_posterior_a, future_posterior_b)</span>
<span id="cb2-45">    </span>
<span id="cb2-46">  })</span>
<span id="cb2-47">  </span>
<span id="cb2-48">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Laplace smoothing to make sure there is always a non-zero chance of something happening.</span></span>
<span id="cb2-49">  forecasted_winners<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"B"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_chr</span>(forecasted_out, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'winner'</span>))</span>
<span id="cb2-50">  forecasted_loss_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(forecasted_out, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'loss_a'</span>)</span>
<span id="cb2-51">  forecasted_loss_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">map_dbl</span>(forecasted_out, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'loss_b'</span>)</span>
<span id="cb2-52">  </span>
<span id="cb2-53">  prob_mind_change <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(forecasted_winners <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> current_decision)</span>
<span id="cb2-54">  </span>
<span id="cb2-55">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now, run the experiment into the future to see if we changed our minds</span></span>
<span id="cb2-56">  </span>
<span id="cb2-57">  ya <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ya <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, true_probability_a)</span>
<span id="cb2-58">  yb <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> yb <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, N, true_probability_b)</span>
<span id="cb2-59">  </span>
<span id="cb2-60">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the posterior</span></span>
<span id="cb2-61">  posterior_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, ALPHA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> ya, BETA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ya)</span>
<span id="cb2-62">  posterior_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbeta</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, ALPHA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> yb, BETA <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> yb)</span>
<span id="cb2-63">  </span>
<span id="cb2-64">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># What decision would we make RIGHT NOW if we had to?</span></span>
<span id="cb2-65">  future_decision <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">decision</span>(posterior_a, posterior_b)</span>
<span id="cb2-66">  </span>
<span id="cb2-67">  mind_changed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(future_decision<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>winner <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> current_decision)</span>
<span id="cb2-68">  </span>
<span id="cb2-69">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">current_winner =</span> current_decision, </span>
<span id="cb2-70">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">future_winner =</span> future_decision<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>winner,</span>
<span id="cb2-71">         mind_changed, </span>
<span id="cb2-72">         prob_mind_change, </span>
<span id="cb2-73">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">forecasted_evsi_a =</span> current_loss_a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(forecasted_loss_a), </span>
<span id="cb2-74">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">forecasted_evsi_b =</span> current_loss_b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(forecasted_loss_b), </span>
<span id="cb2-75">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">true_evsi_a =</span> current_loss_a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> future_decision<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>loss_a,</span>
<span id="cb2-76">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">true_evsi_b =</span> current_loss_b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> future_decision<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>loss_b)</span>
<span id="cb2-77">  </span>
<span id="cb2-78">  </span>
<span id="cb2-79">}, </span>
<span id="cb2-80"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.progress =</span> T, </span>
<span id="cb2-81"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.options =</span> furrr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">furrr_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span>T))</span></code></pre></div>
</details>
</div>
<p>Calibration results are shown below. Its…not bad, right? I suppose if this calibration really irked you then you could run this simulation assuming the true lift was <img src="https://latex.codecogs.com/png.latex?z%5C%25">, and recalibrate the estimates using whatever procedure you like!</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(results, CalibrationCurves<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">valProbggplot</span>(prob_mind_change, mind_changed))</span>
<span id="cb3-2"></span>
<span id="cb3-3">out<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ggPlot</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-09-01-ab-length/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusions" class="level2">
<h2 class="anchored" data-anchor-id="conclusions">Conclusions</h2>
<p>I really like EVSI, and generally this whole procedure for thinking about if we should continue to collect data or not. The results from this tiny little simulation are not intended to be generalizable, and they very likely depend on things like the prior, how much additional data you would collect, and the priors for the model. However, I’ve chosen these parameters to roughly reflect real world scenarios I came across working in AB testing, so this is really encouraging to me!</p>
<p>So how would I answer a stakeholder who wanted to know how long to run the test if they wanted to use a Bayesian method? Generally I might advise a minimum run length of 1 week (so we can integrate over day of week effects). Then, its all sequential from there! Use this procedure to determine the probability you change your mind, and how much the additional sample might change your mind in terms of revenue/improvement/whatever your criterion is. There may come a time at which no more data would change your mind (at least according to the data you’ve seen so far) and at that point the inference problem is kind of irrelevant.</p>
<p>Generally, there are no “right” procedures when it comes to decision making – only trade offs. I particularly like this approach because its good at triaging risk, which is what I think data science should be.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Doing Bayesian data analysis↩︎</p></li>
<li id="fn2"><p>http://varianceexplained.org/r/bayesian-ab-testing/↩︎</p></li>
<li id="fn3"><p>https://www.youtube.com/watch?v=GN5PJXajxKw↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://dpananos.github.io/posts/2024-09-01-ab-length/</guid>
  <pubDate>Sun, 01 Sep 2024 04:00:00 GMT</pubDate>
</item>
<item>
  <title>What Is Confounding?</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-06-23-confound/</link>
  <description><![CDATA[ 





<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Thinking back to my <em>Introduction to Epidemiology</em> class, confounding was one of the topics of central interest. However, it took the remainder of my PhD (and then some) to really get <em>what confounding was</em>. Confounding was introduced as exposure and outcome having common cause. You’ve probably seen the idea motivated with the following DAG:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-06-23-confound/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Here, S is a common cause of <img src="https://latex.codecogs.com/png.latex?D"> and <img src="https://latex.codecogs.com/png.latex?Y">, and we’re typically interested in estimating the effect of <img src="https://latex.codecogs.com/png.latex?D"> on <img src="https://latex.codecogs.com/png.latex?Y">. Granted, the effect of <img src="https://latex.codecogs.com/png.latex?D"> on <img src="https://latex.codecogs.com/png.latex?Y"> is confounded. But like…why? DAG’s aside, what is happening here? That much isn’t answered in introductory classes, and I think it would behoove most people to learn the answer. As a digression, I know the simple difference in means can be decomposed into ATE + Selection Bias + Heterogeneous treatment effect, but I don’t think that really anwers what I want since that decomposition is in terms of potential outcomes and I want an answer which involves the data we have in hand and how we choose to summarize it.</p>
<p>To provide such an answer we need a little but of math, but <em>only</em> a little. In particular, we need the <em>The Law of Total Expectation</em>, which writes an expected value, <img src="https://latex.codecogs.com/png.latex?E%5BX%5D">, as a weighted average of conditional expectations, namely</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5BX%5D%20=%20%5Csum_a%20E%5BX%20%5Cmid%20A=a%5D%20P(A=a)%20%5C%3E.%20"> In what follows, I motivate confounding with a fairly typical example involving how a binary exposure affects risk of a binary outcome. We’ll discuss the “Right Way” to estimate the effect of the exposure as well as “The Wrong Way”. We’ll find that the confounding of the relationship between exposure and outcome comes down to a single fact: <em>the wrong weights are applied to the right estimates</em>.</p>
</section>
<section id="an-example" class="level2">
<h2 class="anchored" data-anchor-id="an-example">An Example</h2>
<p>Suppose a new drug <img src="https://latex.codecogs.com/png.latex?D"> is introduced to prevent death. In truth, the drug decreases the risk of death in both men and women by 10 percentage points, but men are more likely to take the drug and men are more likely to die. Hence, the effect of the drug is confounded by sex. Let <img src="https://latex.codecogs.com/png.latex?D=1"> be exposure to the drug, <img src="https://latex.codecogs.com/png.latex?S=1"> indicate males, and <img src="https://latex.codecogs.com/png.latex?Y=1"> indicate death. I’m going to simulate this scenario using the following data generating process</p>
<p><img src="https://latex.codecogs.com/png.latex?%20S%20%5Csim%20%5Coperatorname%7BBernoulli%7D(0.5)%20%5C%3E,%20"> <img src="https://latex.codecogs.com/png.latex?%20D%20%5Cmid%20S%20%5Csim%20%5Coperatorname%7BBernoulli%7D(0.6%20+%200.3S)%20%5C%3E,"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20Y%20%5Cmid%20D,%20S%20%5Csim%20%5Coperatorname%7BBernoulli%7D(0.4%20-%200.1D%20+%200.4S)%20%5C%3E."></p>
<p>I’ll simulate a million observations so that our precision is big enough to not worry about sampling variability. In R, that can be done with</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">sim_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e6</span>){</span>
<span id="cb1-2">  withr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_seed</span>(x, {</span>
<span id="cb1-3">    s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb1-4">    d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>s)</span>
<span id="cb1-5">    y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>s)</span>
<span id="cb1-6">  })</span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(s, d, y)</span>
<span id="cb1-8">}</span></code></pre></div>
</div>
<p>We’ll use this data to explore the “Right Way” and teh “Wrong Way” of analyzing the causal effect of <img src="https://latex.codecogs.com/png.latex?D"> on <img src="https://latex.codecogs.com/png.latex?Y">.</p>
</section>
<section id="the-right-way" class="level2">
<h2 class="anchored" data-anchor-id="the-right-way">The “Right Way”</h2>
<p>Open up a book like <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">“<em>What If</em>”</a> and you’ll find that the way to correctly estimate the effect of <img src="https://latex.codecogs.com/png.latex?D"> on <img src="https://latex.codecogs.com/png.latex?Y"> would be to first estimate the risk of death within strata defined by sex and then weight the stratified estimates by the prevalence of the strata. This can be done in the following way</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(marginaleffects)</span>
<span id="cb2-2"></span>
<span id="cb2-3">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>s, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sim_data</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>())</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">crossing</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-6">  modelr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_predictions</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'response'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(pred), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.by =</span> d) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pull</span>(pred) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-9">  diff</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.09910701</code></pre>
</div>
</div>
<p>or, perhaps more elegantly, using <code>{marginaleffects}</code></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(marginaleffects)</span>
<span id="cb4-2"></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># If I didn't know P(S) maybe I wouldn't use datagrid in this way</span></span>
<span id="cb4-4">nd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> nd)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 Term Contrast Estimate Std. Error     z Pr(&gt;|z|)   S  2.5 %  97.5 %
    d    1 - 0  -0.0991    0.00119 -83.6   &lt;0.001 Inf -0.101 -0.0968

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
</div>
<p>Regardless of approach, the estimate is very close to the actual effect of the drug; a reduction in risk of death of 10 percentage points. Why exactly this procedure works relies on the consistency and ignorability assumptions, and the law of total expectation.</p>
<p>Briefly, if we have consistency and ignorability then <img src="https://latex.codecogs.com/png.latex?E%5BY(d)%20%5Cmid%20S=s%5D%20=%20E%5BY%5Cmid%20D=d,%20S=s%5D">, and by the law of total expectation</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5BY(d)%5D%20=%20%5Csum_%7Bs%7D%20E%5BY(d)%20%5Cmid%20S=s%5D%20P(S=s)%20=%5Csum_%7Bs%7D%20E%5BY%20%5Cmid%20D=d,%20S=s%5D%20P(S=s)%20"> which is a weighted average of within strata estimates. ’Nuff said, let’s take an extended look at the wrong way of doing things.</p>
</section>
<section id="the-wrong-way" class="level2">
<h2 class="anchored" data-anchor-id="the-wrong-way">The “Wrong Way”</h2>
<p>So we know the “Right Way” uses the law of total expectation to get the right weights for the within strata estimates. What does the “Wrong Way” estimate then if not the true causal contrast? Let’s use <code>avg_comparisons</code> to see</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>d, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sim_data</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>())</span>
<span id="cb6-2"></span>
<span id="cb6-3">nd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">datagrid</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">avg_comparisons</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">variables =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata =</span> nd)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
 Term Contrast Estimate Std. Error    z Pr(&gt;|z|)   S  2.5 % 97.5 %
    d    1 - 0   0.0599    0.00115 51.8   &lt;0.001 Inf 0.0576 0.0621

Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high 
Type:  response </code></pre>
</div>
</div>
<p>Interesting, the wrong answer is <em>really wrong</em>. Without adjusting for sex, we would conclude that the drug increases risk of death by 6%. Of course, this is a result of the fact that men are more likely to take the drug and more likely to die.</p>
<p>The “Wrong Way” is a simple difference in means between exposure groups. In doing so, we marginalize over the distribution of <img src="https://latex.codecogs.com/png.latex?S"> conditional on <img src="https://latex.codecogs.com/png.latex?D">. Since the law of total expectation is used to obtain the right answer, it might be beneficial to use it here as well. In the “Wrong Way” we compute</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5BY%20%5Cmid%20D=d%5D%20%5C%3E.%20"></p>
<p>which can be re-written using the law of total expectation as</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5BY%20%5Cmid%20D=d%5D%20=%20%5Csum_%7Bs%7D%20E%5BY%20%5Cmid%20D=d,%20S=s%5D%20P(S=s%5Cmid%20D=d)%20"></p>
<p>Aha! Now we see what confounding <em>really is</em>. Note that <img src="https://latex.codecogs.com/png.latex?E%5BY%20%5Cmid%20D=d,%20S=s%5D"> appears in both the “Right Way” and the “Wrong Way”, but in the “Wrong Way” the weights are wrong! They should be <img src="https://latex.codecogs.com/png.latex?P(S=s)"> but instead they are <img src="https://latex.codecogs.com/png.latex?P(S=s%5Cmid%20D=d)">! Confounding is (partially) an improper weighting of the correct estimates!</p>
<p>As an interesting digression, we can actually compute what the wrong approach would produce in the limit of infinite data if we just leverage Bayes rule to rewrite <img src="https://latex.codecogs.com/png.latex?P(S=s%5Cmid%20D=d)"> as</p>
<p><img src="https://latex.codecogs.com/png.latex?P(S=s%5Cmid%20D=d)%20=%20%5Cdfrac%7BP(D=d%20%5Cmid%20S=s)%20P(S=s)%7D%7BP(D=d)%7D%20%5C%3E.%20"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">Ey <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(d, s){</span>
<span id="cb8-2">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>s</span>
<span id="cb8-3">}</span>
<span id="cb8-4"></span>
<span id="cb8-5">Ed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(s){</span>
<span id="cb8-6">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>s  </span>
<span id="cb8-7">}</span>
<span id="cb8-8"></span>
<span id="cb8-9">Pd1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb8-10"></span>
<span id="cb8-11">Eyd1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ey</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Pd1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ey</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>Pd1</span>
<span id="cb8-12">Eyd0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ey</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Pd1) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ey</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Ed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Pd1)</span>
<span id="cb8-13"></span>
<span id="cb8-14">wrong_answer <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Eyd1 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Eyd0</span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#0.06</span></span></code></pre></div>
</div>
<p>This really drives the point home that confounding is not a matter of more data, rather its a matter of the right data.</p>
</section>
<section id="more-wrong" class="level2">
<h2 class="anchored" data-anchor-id="more-wrong">More Wrong</h2>
<p>So confounding is partially the wrong weights applied to the right estimates. Earlier, I mentioned that the simple difference in means can be decomposed into selection bias and heterogeneous treatment effects. Now, I’ve designed this example to have a homogeneous treatment effect, so we know that the error comes from selection bias. Let’s determine where exactly selection bias lives in the wrong weights applied to the right estimates, <img src="https://latex.codecogs.com/png.latex?P(S=s%5Cmid%20D=d)">.</p>
<p>According to <a href="https://mixtape.scunning.com/04-potential_outcomes#simple-difference-in-means-decomposition">Causal Inference: The Mixed Tape</a>, the selection bias in the simple difference in means is</p>
<p><img src="https://latex.codecogs.com/png.latex?%20E%5BY(0)%20%5Cmid%20D=1%5D%20-%20E%5BY(0)%20%5Cmid%20D=0%5D%20%5C%3E.%20"></p>
<p>Again, let’s use the law of total expectation to re-write <img src="https://latex.codecogs.com/png.latex?E%5BY(d%5E%5Cprime)%20%5Cmid%20D=d%5D"> as a marginalization over <img src="https://latex.codecogs.com/png.latex?S">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign*%7DE%5BY(d%5E%5Cprime)%20%5Cmid%20D=d%5D%20&amp;=%20%5Csum_%7Bs%7D%20E%5BY(d%5E%5Cprime)%20%5Cmid%20D=d,%20S=s%5DP(S=s%5Cmid%20D=d)%20%5C%5C%20&amp;=%20%5Csum_%7Bs%7DE%5BY(d%5E%5Cprime)%20%5Cmid%20D=d,%20S=s%5D%5Cfrac%7BP(D=d%20%5Cmid%20S=s)%20P(S=s)%7D%7BP(D=d)%7D%20%5Cend%7Balign*%7D"></p>
<p>Its easier to spot where the bias comes from (mathematically) if you consider what the implication would be were exposure to be independent of sex. If exposure were independent of sex, as would be the case in a randomized experiment, then <img src="https://latex.codecogs.com/png.latex?P(D=d%20%5Cmid%20S=s)%20=%20P(D=d)">. The weight in this sum then collapses to <img src="https://latex.codecogs.com/png.latex?P(S=s)">, which is the right weight. However, in this example, <img src="https://latex.codecogs.com/png.latex?D"> is not independent of <img src="https://latex.codecogs.com/png.latex?S"> and so <img src="https://latex.codecogs.com/png.latex?P(D=d%20%5Cmid%20S=s)%20%5Cneq%20P(D=d)">! This probability has a name, <em>the propensity score</em>, and that it is not the same between strata defined by sex is the reason that the selection bias is non zero in our example. If the propensity score was the same within strata, then strata defined by <img src="https://latex.codecogs.com/png.latex?D"> would be exchangeable and <img src="https://latex.codecogs.com/png.latex?E%5BY(d%5E%5Cprime)%20%5Cmid%20D=d%5D%20=%20E%5BY(d%5E%5Cprime)%5D">.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Confounding, at least exemplified by the DAG at the top of this post, can be seen as the improper weighting of the right estimates. When viewed through this lens, approaches like re-weighting (via inverse propensity scores or some other mechanism) make a lot more intuitive sense as possible remidies.</p>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2024-06-23-confound/</guid>
  <pubDate>Wed, 26 Jun 2024 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Interesting Interview Questions</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-05-21-interview/</link>
  <description><![CDATA[ 





<p>I’m about to do some interviews this week which got me reflecting on some of my favorite questions I’ve been asked. Usually, these are little toy problems you’d find in an intro to probability textbook, but they can be pretty fun and rewarding to solve.</p>
<section id="question-1" class="level2">
<h2 class="anchored" data-anchor-id="question-1">Question 1</h2>
<p>Person A has <img src="https://latex.codecogs.com/png.latex?n"> fair coins, and person B has <img src="https://latex.codecogs.com/png.latex?n+1"> fair coins. They each can flip all their coins simultaneously. What is the probability that person B gets more heads? Provide your answer as a function of <img src="https://latex.codecogs.com/png.latex?n">.</p>
</section>
<section id="answer" class="level2">
<h2 class="anchored" data-anchor-id="answer">Answer</h2>
<p>I actually took the liberty of editing this question (the function of <img src="https://latex.codecogs.com/png.latex?n"> was not included). Anyway, this is pretty simple. Suppose <img src="https://latex.codecogs.com/png.latex?n"> is large enough to justify using a normal approximation. Then</p>
<p><img src="https://latex.codecogs.com/png.latex?%20A%20%5Csim%20%5Coperatorname%7Bnormal%7D%5Cleft(%20%5Cdfrac%7Bn%7D%7B2%7D,%20%5Cdfrac%7Bn%7D%7B4%7D%20%5Cright)%20%5C%3E,"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20B%20%5Csim%20%5Coperatorname%7Bnormal%7D%5Cleft(%20%5Cdfrac%7Bn%7D%7B2%7D,%20%5Cdfrac%7Bn%7D%7B4%7D%20%5Cright)%20%5C%3E."></p>
<p>We’re interested in <img src="https://latex.codecogs.com/png.latex?%5CPr(B%20%5Cgt%20A)%20=%20%5CPr(B%20-%20A%20%5Cgt%200)">. So let <img src="https://latex.codecogs.com/png.latex?D=B-A">. Then <img src="https://latex.codecogs.com/png.latex?D"> has the following distribution</p>
<p><img src="https://latex.codecogs.com/png.latex?%20D%20%5Csim%20%5Coperatorname%7Bnormal%7D%5Cleft(%20%5Cdfrac%7B1%7D%7B2%7D,%20%5Cdfrac%7B2n+1%7D%7B4%7D%20%5Cright)%20%5C%3E."></p>
<p>Now, we just need to make a standardized normal random variable and pass it through the CDF of a gaussian. That turns out to be</p>
<p><img src="https://latex.codecogs.com/png.latex?%20Z%20=%20%5Cdfrac%7B0-%5Cfrac%7B1%7D%7B2%7D%7D%7B%5Csqrt%7B%5Cfrac%7B2n+1%7D%7B4%7D%7D%7D%20=%20%5Cdfrac%7B-1%7D%7B%5Csqrt%7B2n+1%7D%7D%20"></p>
<p>and so</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5CPr(B%20%5Cgt%20A)%20=%20Pr(D%20%5Cgt%200)%20=%201%20-%20%5CPhi(Z(n))%20%5C%3E."></p>
<p>I’m not sure what the interviewer expected, but we can see that the probability approaches 1/2 as <img src="https://latex.codecogs.com/png.latex?n%20%5Cto%20%5Cinfty">.</p>
<p>Now, this might be a “good ’nuff” answer, but it relies on an approximation that breaks down for small <img src="https://latex.codecogs.com/png.latex?n">. What is the REAL answer?</p>
<p>For that, we need to use convolution. If <img src="https://latex.codecogs.com/png.latex?D=B-A"> then <img src="https://latex.codecogs.com/png.latex?D"> can take on integer values between <img src="https://latex.codecogs.com/png.latex?-n"> (where B flips 0 heads and A flips <img src="https://latex.codecogs.com/png.latex?n">) and <img src="https://latex.codecogs.com/png.latex?n+1"> (where B flips <img src="https://latex.codecogs.com/png.latex?n+1"> heads and A flips 0).</p>
<p>The convolution is then the following sum</p>
<p><img src="https://latex.codecogs.com/png.latex?%5CPr(D%20=%20k)%20=%20%5Csum_%7Bi=1%7D%5E%7Bn+1%7D%20%5CPr(B=i)%20%5CPr(A%20=%20i-k)"></p>
<p>with the added stipulation that <img src="https://latex.codecogs.com/png.latex?%5CPr(A%3En)%20=%200">. Ok, not a fun sum to do by hand, let’s cook up a numpy function</p>
<div id="3ffbd261" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.stats <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> binom, norm</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.patches <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> patches</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> itertools</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(k:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>, n:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb1-9">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).reshape(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-10">    density <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> binom(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).pmf(i)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>binom(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n, p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).pmf(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>k)</span>
<span id="cb1-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> density.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> approx_f(n:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>):</span>
<span id="cb1-14">    z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) </span>
<span id="cb1-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> norm.cdf(z)</span>
<span id="cb1-16"></span>
<span id="cb1-17">max_coins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb1-18">coins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, max_coins<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-19">probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.zeros(coins.size)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, n <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(coins):</span>
<span id="cb1-22"></span>
<span id="cb1-23">    outcomes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-24">    probs[i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(outcomes, n)</span></code></pre></div>
</div>
<div id="76be825d" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-05-21-interview/index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>In fact, it looks like the probability is <em>always</em> 0.5, which is interesting. Let’s see why.</p>
<p>Credit to Misha Lavrov for showing me this very simple and elegant solution. Again, let <img src="https://latex.codecogs.com/png.latex?D%20=%20B-A">, but now instead focus on <img src="https://latex.codecogs.com/png.latex?D+n%20=%20B%20+%20(n-A)"> which is the number of heads from <img src="https://latex.codecogs.com/png.latex?B"> plus the number of tails from <img src="https://latex.codecogs.com/png.latex?A">. Since the coins are fair, this is the sum of two binomials with <img src="https://latex.codecogs.com/png.latex?2n+1"> trials. Hence, the probability mass function is</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5CPr(D+n%20=%20n+k)%20=%20%7B2n+1%20%5Cchoose%20n+k%7D%202%5E%7B-2n-1%7D%20%5C%3E,%20k%20%5Cin%20%5Cleft%5B%20-n%20%5C%3E,%20%5Ccdots%20%5C%3E,%20n+1%5Cright%5D%20"></p>
<p>This means <img src="https://latex.codecogs.com/png.latex?%5CPr(D+n)"> is symmetric about <img src="https://latex.codecogs.com/png.latex?n+0.5"> implying that <img src="https://latex.codecogs.com/png.latex?%5CPr(D%5Cleq%200)%20=%20%5CPr(D%5Cgt%200)%20=%200.5"> as desired.</p>


</section>

 ]]></description>
  <category>Probability</category>
  <guid>https://dpananos.github.io/posts/2024-05-21-interview/</guid>
  <pubDate>Tue, 21 May 2024 04:00:00 GMT</pubDate>
</item>
<item>
  <title>Peeking Sets You Up For Dissapointment</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-02-08-peek/</link>
  <description><![CDATA[ 





<p>Peeking (looking for significance in an AB test before the experiment has enough samples to reach desired power) is a “no no”. Rationales for not peeking typically mention inflated type 1 error rate.</p>
<p>Unless you’re just randomizing into two groups and not changing anything, the null is unlikely to be true. So inflated type one error rate is really not the primary concern. Rather, if we peek then we are setting ourselves up for disappointment. Detected effects from peeking will typically not generalize, and we will be overstating out impact. The reason why is <a href="https://dpananos.github.io/posts/2024-01-22-curse/">fairly clear when considering the Winner’s Curse</a>.</p>
<p>The long and the short of it is as follows:</p>
<ul>
<li>When you peak, your tests are under powered.</li>
<li>Statistically significant results from under powered tests generally over estimate the truth (see my post on the Winner’s curse for why).</li>
<li>So when you detect an effect from peeking, you are very likely over estimating your impact. When you roll out the change globally, you’re probably not going to see the impact you expected. This can lead to disappointment (and a lot of questions from everyone when they don’t see changes to the numbers on a dashboard).</li>
</ul>
<p>As a concrete example, say you design an experiment to detect a 3% lift in a binary outcome, and say your intervention truly does improve the outcome by 3%. The baseline is 10%, and you design your experiment to have 80% power with a 5% false positive rate. You’re going to need a total of 318,132 users in your experiment…which sounds like a lot. What if we instead checked for statistical significance each time the groups hit a multiple of 20, 000. Depending on how fast we can accrue users into the experiment, this could save time…right?</p>
<p>Shown below is a line plot of the relative error between what you would expect to detect at each peek and the true lift. The plot speaks for itself; conditional on finding an effect early, you’re likely over estimating the truth.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20000</span>, N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20000</span>), N)</span>
<span id="cb1-2">pwr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(n, \(x) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">power.prop.test</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span>x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p1=</span>pc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p2=</span>pt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sig.level =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>power)</span>
<span id="cb1-3">log_rr_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(pt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(pc)</span>
<span id="cb1-4">log_rr_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pt)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(pt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>pc)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(pc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>n)</span>
<span id="cb1-5">log_rr_sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(log_rr_var)</span>
<span id="cb1-6"></span>
<span id="cb1-7">z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> log_rr_mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_rr_sd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnorm</span>(pwr)</span>
<span id="cb1-8"></span>
<span id="cb1-9"></span>
<span id="cb1-10"></span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expectation from truncated normal</span></span>
<span id="cb1-13">trunc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> log_rr_mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> log_rr_sd <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>((z <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_rr_mean)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> log_rr_sd) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>((z <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_rr_mean)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> log_rr_sd))</span>
<span id="cb1-14">err <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>( log_rr_mean<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>trunc)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>log_rr_mean</span>
<span id="cb1-15"></span>
<span id="cb1-16">sims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(n, \(nn) {</span>
<span id="cb1-17">  </span>
<span id="cb1-18">  </span>
<span id="cb1-19">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">replicate</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>, {</span>
<span id="cb1-20">    </span>
<span id="cb1-21">  x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nn, pc)</span>
<span id="cb1-22">  y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nn, pt)</span>
<span id="cb1-23">  </span>
<span id="cb1-24">  test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prop.test</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(y, x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(nn, nn))</span>
<span id="cb1-25">  </span>
<span id="cb1-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(test<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>p.value <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(x), <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>)</span>
<span id="cb1-27">  })</span>
<span id="cb1-28">  </span>
<span id="cb1-29">  (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(r, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm=</span>T) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> log_rr_mean) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> log_rr_mean</span>
<span id="cb1-30">  </span>
<span id="cb1-31">  </span>
<span id="cb1-32">})</span></code></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-02-08-peek/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In the best case scenario, where you end the experiment on the first peek, you’re going to vastly over estimate the impact you had (almost by a factor of 2.3x!). The worst part is that these errors compound, so if you peek on every experiment you’re going to <em>grossly</em> over estimate the total impact you had. Maybe something to talk to your PMs about.</p>



 ]]></description>
  <guid>https://dpananos.github.io/posts/2024-02-08-peek/</guid>
  <pubDate>Thu, 08 Feb 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>You Just Said Something Wrong About Logistic Regression</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-02-06-logit/</link>
  <description><![CDATA[ 





<p>Congratulations, you just said something wrong about logistic regression. That’s OK, logistic regression is hard and we all have to learn/re-learn some things from time to time.</p>
<p>This is a living blog post intended to address some common misconceptions or flat out wrong statements I’ve seen people make about logistic regression.</p>
<section id="the-coefficients-of-logistic-regression-are-interpreted-as-youre-x-times-more-likely-to-see-y-given-factor-z." class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="the-coefficients-of-logistic-regression-are-interpreted-as-youre-x-times-more-likely-to-see-y-given-factor-z."><span class="header-section-number">1</span> The Coefficients of Logistic Regression are Interpreted as “You’re X Times More Likely to See Y Given Factor Z”.</h2>
<p>Wrong! The (exponentiated) coefficients of logistic regression are interpreted as “the odds you see Y given Factor Z are X times larger”.</p>
<p>Phrases like “X times <em>more likely</em>” allude to the the probability of the event. If the probability of getting some event is 10%, and the probability of getting some other event is 20%, then you are 2 times more likely to get the latter event than the former.</p>
<p>This kind of comparison between two probabilities is called “the relative risk” (or risk ratio, or lift, it really depends on where you work). The coefficients of a logistic regression are <em>not</em> risk ratios, nor are they log risk ratios; they are log odds ratios.</p>
<p>Now, it is actually fine to make this mistake under a few conditions. Namely, when a) the odds ratio is sufficiently small, and/or b) the baseline risk is sufficiently small. You can see this on the plot below which plots the odds ratios and corresponds risk ratios for various baseline risks. On the whole though, you shouldn’t interpret any output from logistic regression as a risk ratio unless you explicitly go out of our way to estimate that quantity.</p>
<div id="bd57bd8e" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.cm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> cm</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> mpl_toolkits.axes_grid1.inset_locator <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> inset_axes</span>
<span id="cb1-5"></span>
<span id="cb1-6">p1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>])</span>
<span id="cb1-7"></span>
<span id="cb1-8">rr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.9</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb1-9"></span>
<span id="cb1-10">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>)</span>
<span id="cb1-11">ax.set_aspect(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb1-12">ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-13">ax.set_ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set light gray background</span></span>
<span id="cb1-16">ax.set_facecolor(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f0f0f0'</span>)</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set white grid lines</span></span>
<span id="cb1-19">ax.grid(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb1-20"></span>
<span id="cb1-21">ax.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cm.get_cmap(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'magma'</span>)</span>
<span id="cb1-24">colors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cmap(np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(p1)))</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(p1):</span>
<span id="cb1-27">    p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p</span>
<span id="cb1-28">    odr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p)</span>
<span id="cb1-29">    ax.plot(rr, odr, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors[i])</span>
<span id="cb1-30"></span>
<span id="cb1-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Move legend outside the plot axis to the right</span></span>
<span id="cb1-32">ax.legend(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Baseline risk"</span>, loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center left'</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>))</span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set y ticks to [1, 2, 3, 4, 5]</span></span>
<span id="cb1-35">ax.set_yticks([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])</span>
<span id="cb1-36">ax.set_xticks([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])</span>
<span id="cb1-37">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Relative Risk'</span>)</span>
<span id="cb1-38">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Odds Ratio'</span>)</span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add zoom inset region axis on the bottom center</span></span>
<span id="cb1-41">axins <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.inset_axes(</span>
<span id="cb1-42">    [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.47</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.47</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>],  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjusted position</span></span>
<span id="cb1-43">    xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>), xticks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>], yticks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>])</span>
<span id="cb1-44">    </span>
<span id="cb1-45">axins.plot([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'k--'</span>)</span>
<span id="cb1-46">axins.set_facecolor(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'#f0f0f0'</span>)</span>
<span id="cb1-47">axins.grid(color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'white'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'-'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb1-48"></span>
<span id="cb1-49"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(p1):</span>
<span id="cb1-50">    p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p</span>
<span id="cb1-51">    odr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p)</span>
<span id="cb1-52">    axins.plot(rr, odr, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>colors[i])</span>
<span id="cb1-53"></span>
<span id="cb1-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use ax.indicate_inset_zoom to draw a rectangle around the zoomed-in region</span></span>
<span id="cb1-55">ax.indicate_inset_zoom(axins, edgecolor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>)</span>
<span id="cb1-56"></span>
<span id="cb1-57">plt.show()</span></code></pre></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>How the relative risk and odds ratio differ for various baseline risks. For each basline risk, we can compute the associated probabiltity given the relative risk. Given that probability, we can also compute the odds ratio.</figcaption>
<p><img src="https://dpananos.github.io/posts/2024-02-06-logit/index_files/figure-html/cell-2-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2024-02-06-logit/</guid>
  <pubDate>Tue, 06 Feb 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>The Winner’s Curse Is Easy To Understand From This Picture</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-01-22-curse/</link>
  <description><![CDATA[ 





<p>Take a look at the photo below, and it i should be easy to understand why The Winner’s Curse (the general tendency for detected effects to be an over estimate of the truth) is a thing.</p>
<p>The plot shows our typical setup for a hypothesis test. In black is the sampling distribution of the test statistic for a difference in means under the null, and in blue is the statistic’s sampling distribution under the alternative. The shaded blue region represents the statistical power, and those effect sizes in the shaded region would be considered “statistically significant”.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_f57febe84b86407f210dc36b318d860c">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb1-2">xs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Difference in means'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xaxt=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yaxt=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'n'</span>)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">polygon</span>(</span>
<span id="cb1-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(xs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(xs)),</span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(xs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(xs))),</span>
<span id="cb1-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>),</span>
<span id="cb1-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> F</span>
<span id="cb1-10">)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-01-22-curse/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The shaded blue region defines a lower truncated normal distribution. Were the alternative hypothesis true, and were we to run many experiments to estimate the difference in means, our detected effects would be samples from this distribution. Hence, using those samples to estimate the mean of the alternative distribution would result in a biased estimate of the mean.</p>
<p>The expectation for a lower truncated normal distribution truncated at <img src="https://latex.codecogs.com/png.latex?x=a"> is</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmu+%5Csigma%20%20%5Cdfrac%7B%5Cvarphi%5Cleft(%20%5Cdfrac%7Ba-%5Cmu%7D%7B%5Csigma%7D%20%5Cright)%7D%7B1%20-%20%5CPhi%5Cleft(%5Cdfrac%7Ba-%5Cmu%7D%7B%5Csigma%7D%5Cright)%7D%20%20%20%5C%3E."></p>
<p>Here <img src="https://latex.codecogs.com/png.latex?%5Cmu"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma"> are the mean and standard deviation of the distribution under the alternative, <img src="https://latex.codecogs.com/png.latex?%5Cvarphi"> is the standard normal density, <img src="https://latex.codecogs.com/png.latex?%5CPhi"> is the standard normal cumulative distribution. So our estimate of the mean would be biased upwards by <img src="https://latex.codecogs.com/png.latex?%5Csigma%20%20%5Cfrac%7B%5Cvarphi%5Cleft(%20%5Cfrac%7Ba-%5Cmu%7D%7B%5Csigma%7D%20%5Cright)%7D%7B1%20-%20%5CPhi%5Cleft(%5Cfrac%7Ba-%5Cmu%7D%7B%5Csigma%7D%5Cright)%7D">. That can be small or large depending on <img src="https://latex.codecogs.com/png.latex?%5Cmu"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma">.</p>
<p>Without doing any differentiation to understand where this bias is largest, it should be intutituve from the picture that the bias is small/large when statistical power is large/small.</p>
<p>Hence, estimates from underpowered studies should be met with &lt;fry_squint.jpg&gt;.</p>



 ]]></description>
  <guid>https://dpananos.github.io/posts/2024-01-22-curse/</guid>
  <pubDate>Sat, 20 Jan 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Survival Analysis With Logistic Regression</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2024-01-20-logistic-survival/</link>
  <description><![CDATA[ 





<p><a href="https://stats.stackexchange.com/questions/636963/logistic-regression-varying-exposure-variable/637018#637018">This</a> question came up on cross validated. In the course of responding to my answer, OP asks “why can’t I adjust for exposure length in a logistic regression” which kind of got me scratching my head. Seems like it <em>could</em> be done.</p>
<p>I brought the question to twitter, and Dr.&nbsp;Ellie Murray <a href="https://twitter.com/EpiEllie/status/1747987418152612085">responded</a> reminding me that time to death and death are different outcomes and should be treated differently. A logistic regression could be done, depending on what you’re trying to model.</p>
<p>Finally, Frank Harrell <a href="https://twitter.com/f2harrell/status/1748327687066652908">responded</a> to Dr.&nbsp;Murray, with a link to a paper by Brad Efron (because of course Efron wrote something on this) which showed how this can be done quite elegantly.</p>
<p>Let’s see how we can use logistic regression for survival analysis.</p>
<section id="the-gist" class="level2">
<h2 class="anchored" data-anchor-id="the-gist">The Gist</h2>
<p>Recall that the Kaplan-Meir product limit estimator looks like</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cwidehat%7BS%7D_%7BKM%7D%20(t)%20=%20%5Cprod_%7Bi:%20t_i%20%5Cleq%20t%7D%20%5Cleft(1-%5Cdfrac%7Bd_i%7D%7Bn_i%7D%20%5Cright)%20%5C%3E.%20"></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?d_i"> is the number of subjects who experience the outcome at time <img src="https://latex.codecogs.com/png.latex?t_i">, and <img src="https://latex.codecogs.com/png.latex?n_i"> is the number of individuals known to have survived up to time <img src="https://latex.codecogs.com/png.latex?t_i">. In essence, the product limit estimator is a product of a sequence of probabilities. What else do we use to model probabilities? Logistic regression.</p>
<p>Efron writes that the main assumption for using logistic regression to model these probabilities is that the number of events <img src="https://latex.codecogs.com/png.latex?d_i"> is binomial given <img src="https://latex.codecogs.com/png.latex?n_i"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20d_i%20%5Cmid%20n_i%20%5Csim%20%5Coperatorname%7BBinomial%7D(h_i;%20n_i)%20%5C%3E.%20"></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?h_i"> is the discrete hazard rate (i.e.&nbsp;the probability the subject experiences the outcome during the <img src="https://latex.codecogs.com/png.latex?i%5E%7Bth%7D"> interval given the subject has survived until the beginning of the <img src="https://latex.codecogs.com/png.latex?i%5E%7Bth%7D"> interval).</p>
<p>The main problem is that the hazard may not be linear in the exposure time. Efron uses splines to allow <img src="https://latex.codecogs.com/png.latex?h_i"> to be flexible in exposure time, and then computes the estimated survival function using</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Ctilde%7BS%7D(t)%20=%20%20%5Cprod_%7Bi:%20t_i%20%5Cleq%20t%7D%20%5Cleft(1-h_i%5Cright)"></p>
<p>As an algorithm, the steps might look like:</p>
<ul>
<li>Structure your data so that you have number at risk, number of events, and number of censoring events as columns</li>
<li>Fit a logistic regression on the event/at risk columns (in R this is done by making <code>cbind(y, n-y)</code> the outcome in the <code>glm</code> call). Ensure the time variable is modeled flexibly (either with splines or something more exotic).</li>
<li>Predict the risk of death (i.e.&nbsp;the discrete hazard) from the logistic regression on the observed event times.</li>
<li>Take the cumulative product of one minus the discrete hazards. These are the survival function estimates.</li>
</ul>
</section>
<section id="replicating-efrons-example" class="level2">
<h2 class="anchored" data-anchor-id="replicating-efrons-example">Replicating Efron’s Example</h2>
<p>Efron motivates this approach using survival data from a Head-and-Neck cancer study conducted by the Northern California Oncology Group. I’ve extracted this data to replicate the method.</p>
<p>First, let’s show the Kaplan-Meir estimates</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(survival)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(splines)</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">source</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"make_data.R"</span>)</span>
<span id="cb1-6"></span>
<span id="cb1-7">sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'survival'</span>)</span>
<span id="cb1-8">sfit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">survfit</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Surv</span>(month, event) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">strata</span>(arm), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weights =</span> wt)</span>
<span id="cb1-9"></span>
<span id="cb1-10">sfit_tidy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> broom<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tidy</span>(sfit) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-11">             <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strata =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">str_remove</span>(strata, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fixed</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'strata(arm)='</span>)))</span>
<span id="cb1-12"></span>
<span id="cb1-13"></span>
<span id="cb1-14">base_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sfit_tidy <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(time, estimate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>strata, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>strata)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Set1'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Month'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survival Probability'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Arm'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Arm'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Kaplan-Meier Estimated Survival Curves for Head-and-Neck Cancer Study'</span>)</span>
<span id="cb1-21"></span>
<span id="cb1-22"></span>
<span id="cb1-23">base_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb1-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_step</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'dashed'</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-01-20-logistic-survival/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The intial model presented expands time in the following basis functions</p>
<p><img src="https://latex.codecogs.com/png.latex?%20x_i%20=%20(1,%20t_i,%20(t_i-11)_-%5E%7B2%7D,%20(t_i-11)_-%5E%7B3%7D)%20"></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?t_i"> is the the midpoint between months. This is equivalent to estimating the risk of the outcome between the start of month <img src="https://latex.codecogs.com/png.latex?i"> and the start of month <img src="https://latex.codecogs.com/png.latex?i+1">. The function <img src="https://latex.codecogs.com/png.latex?(%20z%20)_-%20=%20%5Cmin(z,%200)">. This particular expansion allows <img src="https://latex.codecogs.com/png.latex?t_i"> to vary as a cubic function before <img src="https://latex.codecogs.com/png.latex?t_i=11">, and then as a linear function thereafter.</p>
<p>After fitting the model with an interaction by arm (so that the hazards can differ by arm), we can plot the hazards readily <sup>1</sup>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">make_data</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'logistic'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-2">     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tm =</span> month <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, </span>
<span id="cb2-3">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">txt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(arm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A'</span>))</span>
<span id="cb2-4"></span>
<span id="cb2-5"></span>
<span id="cb2-6">f <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, d) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>((x), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-7"></span>
<span id="cb2-8">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glm</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(s, n<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>s) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> arm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (tm <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(tm<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-11</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">I</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f</span>(tm<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-11</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)),</span>
<span id="cb2-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>d, </span>
<span id="cb2-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">binomial</span>())</span>
<span id="cb2-11"></span>
<span id="cb2-12">preds <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_cols</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newdata=</span>., <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">se.fit=</span>T)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb2-15">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(fit),</span>
<span id="cb2-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p.low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(fit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>se.fit),</span>
<span id="cb2-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p.high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(fit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>se.fit)</span>
<span id="cb2-18">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(arm) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(arm, month) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumprod</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p),</span>
<span id="cb2-22">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S.low =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumprod</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p.low),</span>
<span id="cb2-23">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">S.high =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cumprod</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>p.high))</span>
<span id="cb2-24"></span>
<span id="cb2-25"></span>
<span id="cb2-26">preds <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb2-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(tm, p, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>arm)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coord_cartesian</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Set1'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb2-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_y_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> scales<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span>percent) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb2-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Month'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hazard'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Arm'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Arm'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Hazard (Risk Estimate From Logistic Regression)'</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-01-20-logistic-survival/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>And we can also plot the estimated survival function against the Kaplan Meier to compare.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">base_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>preds, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(month, S, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>arm), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit.aes =</span> F) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Kaplan-Meier as Compared to Logistic Regression'</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2024-01-20-logistic-survival/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="final-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="final-thoughts">Final Thoughts</h2>
<p>Why would we want to parametrically model the hazard when Kaplan-Meir <em>can’t</em> misspecify the hazard? What do we gain from this? In a word: <em>efficiency</em> , at least according to Efron. Additionally, if we are willing to make assumptions about how the hazard evolves into the future (e.g.&nbsp;linearly) then we can use this approach to forecast survival beyond the last observed timepoint.</p>
<p>In his paper, Efron has some notes on computing standard errors for this estimator. Its fairly dense, and I haven’t included confidence intervals here lest I naively compute them. That’s a topic for a future blog post.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I Just can’t get the hazard’s to look the same as Figure 2. Might be an error copying over the data.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://dpananos.github.io/posts/2024-01-20-logistic-survival/</guid>
  <pubDate>Sat, 20 Jan 2024 05:00:00 GMT</pubDate>
</item>
<item>
  <title>The Generalized Gamma Distribution For Parametric Survival</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2023-12-02-gen-gamma/</link>
  <description><![CDATA[ 





<p>A couple weeks back, I posted a little something something on <a href="https://dpananos.github.io/posts/2023-11-02-shifted-beta-geometric/">the Shifted Beta Geometric distribution</a>. That distribution is used in estimating churn in contractual settings (think Netflix, or any other service whereby you renew your service monthly). Its a nice model, but I want something more flexible.</p>
<p>I’ve been aware of the generalized gamma distribution through Jordan Nafa (who likely uses it for some very interesting decision theory applications). Briefly, if <img src="https://latex.codecogs.com/png.latex?T"> is the event time, then let <img src="https://latex.codecogs.com/png.latex?Y=%5Clog(T)">, and <img src="https://latex.codecogs.com/png.latex?Z%20=%20(Y-%5Cmu)/%5Csigma">. Then <img src="https://latex.codecogs.com/png.latex?Z"> has the following density</p>
<p><img src="https://latex.codecogs.com/png.latex?%20f(z%20;%20k)=%5Cfrac%7Bk%5E%7Bk-1%20/%202%7D%7D%7B%5CGamma(k)%7D%20%5Cexp%20%5Cleft(k%5E%7B1%20/%202%7D%20z-k%20e%5E%7Bk%5E%7B-1%20/%202%7D%20z%7D%5Cright)"></p>
<p>and <img src="https://latex.codecogs.com/png.latex?T%20=%20%5Cexp(Y)"> is distributed according to the generalized gamma distribution . Here, <img src="https://latex.codecogs.com/png.latex?-%5Cinfty%20%5Clt%20z%20%5Clt%20%5Cinfty">, <img src="https://latex.codecogs.com/png.latex?-%5Cinfty%20%5Clt%20%5Cmu%20%5Clt%20%5Cinfty">, and <img src="https://latex.codecogs.com/png.latex?%5Csigma,%20k%3E0">. For more on the generalized gamma, especially for use in survival analysis, see <em>Statistical Models and Methods for Lifetime Data</em> by Jerry Lawless (1982).</p>
<p>The nice thing about the generalized gamma is that the exponential, gamma, and weibull distributions – all common parmetric survival likelihoods – are special cases (and the log normal is a limiting distribution) <sup>1</sup>.<br>
That is especially nice for me. I’m working on some life time value modelling and it would be great if I didn’t have to try several models. Instead I can just use the generalized gamma and hope it fits well enough if the data are best approximated via one of the aforementioned survival functions.</p>
<p>In this post, I want to implement some survival analyses using the generalized gamma. Let’s get started.</p>
<section id="data" class="level2">
<h2 class="anchored" data-anchor-id="data">Data</h2>
<p>We’ll need some data. Rather than simulate it myself, I’ll use the <code>veteran</code> data from <code>{survival}</code>. The survival function is roughly exponential, which is good because we know the generalized gamma can fit it in principle. There is a <code>trt</code> indicator in these data, so we’ll fit one survival curve to each strata. Shown below are the Kaplan-Meir non-parametric estimates for these data. Rather than plot the survival curve <img src="https://latex.codecogs.com/png.latex?S(t)">, I choose to plot <img src="https://latex.codecogs.com/png.latex?1-S(t)"> because my brain groks the plot easier as “the proportion of individuals in a cohort who would have experienced the outcome by time <img src="https://latex.codecogs.com/png.latex?t">”. The log of this quantity is the cumulative hazard, but I don’t know if <img src="https://latex.codecogs.com/png.latex?1-S(t)"> has a proper name. I mean … it is technically an estimate of the CDF of the event time distribution.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Non-parametric estimate of <img src="https://latex.codecogs.com/png.latex?1%20-%20S(t%7Ctrt)"> for each <code>trt</code> strata in the veteran dataset. The curves look roughly exponential meaning the generalized gamma should provide a good fit.</figcaption>
<p><img src="https://dpananos.github.io/posts/2023-12-02-gen-gamma/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Stan does not have an implementation for the generalized gamma, so we’ll have to write that ourselves in the <code>functions</code> block.</p>
</section>
<section id="lpdf-_lcdf-and-_lccdf-implementations-in-stan" class="level2">
<h2 class="anchored" data-anchor-id="lpdf-_lcdf-and-_lccdf-implementations-in-stan"><code>_lpdf</code>, <code>_lcdf</code>, and <code>_lccdf</code> Implementations in Stan</h2>
<p>To do parametric survival analysis in Stan, we need three functions:</p>
<ul>
<li>The log probability density as <code>generalized_gamma_lpdf</code> so we can increment the log posterior density when we observe an outcome,</li>
<li>The log complementary CDF as <code>generalized_gamma_lccdf</code> so we can increment the log posterior density when we observe a censoring event, and</li>
<li>The log CDF as <code>generalized_gamma_lcdf</code> so we can implement the <code>_lccdf</code>.</li>
</ul>
<p>The first and third functions are implemented already by Krzysztof Sakrejda in <a href="https://github.com/sakrejda/tooling/blob/master/models/stan-lang/functions/generalized-gamma.stan.part">this repo</a>. The <code>_lpdf</code> and <code>_lcdf</code> are given, so now we just need the complementary cdf function <code>_lccdf</code>. Since Stan works on the log probability scale, we need to return the the log of the complementary cdf. Since we have the log cdf we could just do</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb1-1"></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> generalized_gamma_lccdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> x, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> k, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sigma) {</span>
<span id="cb1-4"> </span>
<span id="cb1-5"> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> - exp(generalized_gamma_lcdf(x | k, mu sigma)));</span>
<span id="cb1-6"> </span>
<span id="cb1-7">}</span></code></pre></div>
</div>
</div>
<p>Stan has a nicer function to do this called <code>log_diff_exp</code> which can be used to take differences in exponential space and then take the log of the result.</p>
<p>Additionally, we can create a random number generator for the generalized gamma distribution by noting that <code>flexsurv</code>’s implementation of the generalized gamma is equivalent to ours if we let <img src="https://latex.codecogs.com/png.latex?Q=1/%5Csqrt%7Bk%7D">. Our <code>functions</code> block then looks like</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">functions</span> {</span>
<span id="cb2-2">  </span>
<span id="cb2-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> generalized_gamma_lpdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> x, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> k, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sigma) {</span>
<span id="cb2-4">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> w;</span>
<span id="cb2-5">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> d;</span>
<span id="cb2-6">    w = (log(x) - mu) / sigma;</span>
<span id="cb2-7">    d = (k - .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) * log(k) - log(sigma) - lgamma(k) + (sqrt(k) * w - k * exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> / sqrt(k) * w)) - log(x);</span>
<span id="cb2-8">    </span>
<span id="cb2-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d;</span>
<span id="cb2-10">  }</span>
<span id="cb2-11">  </span>
<span id="cb2-12">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> generalized_gamma_cdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> x, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> k, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sigma) {</span>
<span id="cb2-13">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> w;</span>
<span id="cb2-14">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> d;</span>
<span id="cb2-15">    w = (log(x) - mu) / sigma;</span>
<span id="cb2-16">    d = gamma_p(k, k * exp(w / sqrt(k)));</span>
<span id="cb2-17">    </span>
<span id="cb2-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d;</span>
<span id="cb2-19">  }</span>
<span id="cb2-20">  </span>
<span id="cb2-21">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> generalized_gamma_lcdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> x, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> k, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sigma) {</span>
<span id="cb2-22">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> w;</span>
<span id="cb2-23">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> d;</span>
<span id="cb2-24">    w = (log(x) - mu) / sigma;</span>
<span id="cb2-25">    d = log(gamma_p(k, k * exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> / sqrt(k) * w)));</span>
<span id="cb2-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> d;</span>
<span id="cb2-27">  }</span>
<span id="cb2-28">  </span>
<span id="cb2-29">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> generalized_gamma_lccdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> x, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> k, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sigma) {</span>
<span id="cb2-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> log_diff_exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, generalized_gamma_lcdf(x | k, mu, sigma));</span>
<span id="cb2-31">  }</span>
<span id="cb2-32">  </span>
<span id="cb2-33">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> generalized_gamma_rng(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> k, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> mu, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sigma) {</span>
<span id="cb2-34">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> Q = <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> / sqrt(k);</span>
<span id="cb2-35">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> gamma = gamma_rng(Q^-<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb2-36">    <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> w = log(Q^<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> * gamma) / Q;</span>
<span id="cb2-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> exp(mu + sigma * w);</span>
<span id="cb2-38">  }</span>
<span id="cb2-39">  </span></code></pre></div>
</div>
</div>
</section>
<section id="fitting-the-model" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-model">Fitting The Model</h2>
<p>The model fits fairly quickly (4 chains in parallel takes &lt;2 seconds on my M1 Pro macbook pro). We can easily plot the survival curve against the Kaplan-Meir estimate to compare, however a better comparison would be to draw samples from the event time distribution and compute the ecdf of those samples. That plot is shown below, and is equivalent to a posterior predictive check in the case where there is no censoring. You can see that the KM estimates look similar to the ecdfs, which is good enough for me.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 chains, at most 10 in parallel...

Chain 1 finished in 1.9 seconds.
Chain 2 finished in 1.9 seconds.
Chain 3 finished in 1.9 seconds.
Chain 4 finished in 1.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.9 seconds.
Total execution time: 2.0 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Kaplan-Meir estimates (black) with posterior survival functions.</figcaption>
<p><img src="https://dpananos.github.io/posts/2023-12-02-gen-gamma/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<figcaption>Kaplan-Meir estimates (black) with estimated ECDFs computed from draws of the posterior distribution. Each colored line corresponds to one sample of event times from the posterior distribution, conditional on <img src="https://latex.codecogs.com/png.latex?%5Cmu">, <img src="https://latex.codecogs.com/png.latex?%5Csigma">, and <img src="https://latex.codecogs.com/png.latex?k">.</figcaption>
<p><img src="https://dpananos.github.io/posts/2023-12-02-gen-gamma/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Left as an exercise to the reader.↩︎</p></li>
</ol>
</section></div> ]]></description>
  <guid>https://dpananos.github.io/posts/2023-12-02-gen-gamma/</guid>
  <pubDate>Sat, 02 Dec 2023 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Brain Teaser About Frequentist Statistics</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2023-12-01-ron/</link>
  <description><![CDATA[ 





<p>Ron Kohavi is somewhat of a prominent figure in the A/B testing community. Armed with having coauthored “Trustworthy Online Controlled Experiments”, experience at places like AirBNB and Microsoft, and what seems to be a $20/month subscription to ChatGPT, he will often post these kinds of questions on LinkedIn.</p>
<p>The post below really caught my attention (probably because of the AI generated accompanying picture, a fad everyone seems to be doing for some reason).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2023-12-01-ron/linkedin.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>This should be fairly simple to reason through. Below is a plot depicting the concept of statistical power. The black curve is the sampling distribution under the null, the blue curve is the sampling distribution under the alternative implied by the minimal detectable effect (MDE). The area under the blue curve is the statsitical power (its the probability we observe a test statistic greater than the critical value).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"></span>
<span id="cb1-3">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb1-4">xs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels=</span>F, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">polygon</span>(</span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(xs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(xs)),</span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(xs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(xs))),</span>
<span id="cb1-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>),</span>
<span id="cb1-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> F</span>
<span id="cb1-12">)</span>
<span id="cb1-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topleft'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(H[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(H[A])), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2023-12-01-ron/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>According to Ron, we run our experiment and observe the our (MDE) exactly. In our picture, that means we observe the mean of the sampling distribution under the alternative, so we just need to find how far out the MDE is with respect to the null distribution.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb2-2"></span>
<span id="cb2-3">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb2-4">xs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb2-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels=</span>F, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb2-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'l'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>)</span>
<span id="cb2-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">polygon</span>(</span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(xs, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rev</span>(xs)),</span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(xs, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(xs))),</span>
<span id="cb2-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">alpha</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>),</span>
<span id="cb2-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">border =</span> F</span>
<span id="cb2-12">)</span>
<span id="cb2-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'topleft'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(H[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(H[A])), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb2-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2023-12-01-ron/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Let’s do a little bit of math. Assuming the sampling distribution under the null is standard normal, the critical value would be <img src="https://latex.codecogs.com/png.latex?%5Cmu_0%20+%20%5Csigma_0z_%7B1-%5Calpha%7D">. The critical value under the alternative would then be <img src="https://latex.codecogs.com/png.latex?%5Cmu_1%20+%20z_%7B1-%5Cbeta%7D%5Csigma_1">. Plugging in some numbers, this means the mean under the alternative should have a z-zcore of <img src="https://latex.codecogs.com/png.latex?%5Cmu_0%20+%20%5Csigma_0z_%7B1-%5Calpha%7D%20-%20%5Csigma_1z_%7B1-%5Cbeta%7D">. Now, we just need to evaluate <img src="https://latex.codecogs.com/png.latex?1%20-%20%5Cmathbf%7B%5CPhi%7D(%5Cmu_0%20+%20%5Csigma_0z_%7B1-%5Calpha%7D%20-%20%5Csigma_1z_%7B1-%5Cbeta%7D)">.</p>
<p>Assume that these distributions are standardized so that <img src="https://latex.codecogs.com/png.latex?%5Cmu_0%20=%200"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma_0%20=%20%5Csigma_1=1">. This results in a p-value of</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.8</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lower.tail =</span> F)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.00255513</code></pre>
</div>
</div>
<p>and I bet because I’ve only focused on one tail I should multiply by 2, so a p value of ~ 0.005, <a href="https://www.linkedin.com/posts/ronnyk_test-your-intuition-on-p-values-you-design-activity-7136272639823663104-H7u8">which seems to be correct</a>.</p>



 ]]></description>
  <guid>https://dpananos.github.io/posts/2023-12-01-ron/</guid>
  <pubDate>Fri, 01 Dec 2023 05:00:00 GMT</pubDate>
</item>
<item>
  <title>Estimating the Shifted Beta Geometric Model in Stan</title>
  <dc:creator>Demetri Pananos</dc:creator>
  <link>https://dpananos.github.io/posts/2023-11-02-shifted-beta-geometric/</link>
  <description><![CDATA[ 





<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cmdstanr)</span></code></pre></div>
</details>
</div>
<p>The shifted beta geometric model (sBG) is a model that is used to forecast retention/survival of users in contractual settings (think netflix, disney plus, tinder gold, etc). The model is quite simple and posits:</p>
<ul>
<li>At the end of each period, a customer flips a coin: “heads” she cancels he contract, “tails” she renews it.</li>
<li>For each individual, the probability of a coin coming up “heads” does not change over time</li>
<li>The probabiliuty of heads varies across customers. Fader and Hardie motivate the model in their paper <em>How to Project Customer Retention</em> and even provide a way to fit the model in excel. Neat!</li>
</ul>
<p>Excel isn’t a great tool for fitting models, so Let’s write this in Stan.</p>
<section id="sbg-in-stan" class="level2">
<h2 class="anchored" data-anchor-id="sbg-in-stan">sBG in Stan</h2>
<p>The two things we need are the probability density function and the survival function. Fader and Hardie provide these in their paper. Mathematically, the probability density and survival function are</p>
<p><img src="https://latex.codecogs.com/png.latex?%20P(T=t%20%5Cmid%20%5Calpha,%20%5Cbeta)%20=%20%5Cdfrac%7BB(%5Calpha+1,%20%5Cbeta+t-1)%7D%7BB(%5Calpha,%20%5Cbeta)%7D%20%5C%3E,"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20S(T=t%20%5Cmid%20%5Calpha,%20%5Cbeta)%20=%20%5Cdfrac%7BB(%5Calpha,%20%5Cbeta+t)%7D%7BB(%5Calpha,%20%5Cbeta)%7D%20%5C%3E.%20"> Here, <img src="https://latex.codecogs.com/png.latex?B(%5Calpha,%20%5Cbeta)"> is the beta function <em>and not the beta distribution</em> (I made that mistake early). Stan operates on the log scale, and so we’ll have to take the log of these. Stan has a log beta function called <code>lbeta</code> so we’ll use that in our functions for the density and survival function.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb2-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">functions</span>{</span>
<span id="cb2-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sbg_lpdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> time, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> alpha, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> beta){</span>
<span id="cb2-3">    </span>
<span id="cb2-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> lbeta(alpha+<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, beta+time<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>) - lbeta(alpha, beta);</span>
<span id="cb2-5">  }</span>
<span id="cb2-6">  </span>
<span id="cb2-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sbg_lccdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> time, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> alpha, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> beta){</span>
<span id="cb2-8">    </span>
<span id="cb2-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> lbeta(alpha, beta + time) - lbeta(alpha, beta);</span>
<span id="cb2-10">  }</span>
<span id="cb2-11">  </span>
<span id="cb2-12">}</span></code></pre></div>
</div>
</div>
<p>The data we need to fit the model include:</p>
<ul>
<li>How many customers were lost at each time period,</li>
<li>The times at which customers were lost, and</li>
<li>The total number of customers under observation</li>
</ul>
<p>We’ll also include an array of times at which to estimate the survival curve</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">data</span>{</span>
<span id="cb3-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Fitting the model</span></span>
<span id="cb3-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> N;</span>
<span id="cb3-4">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n_total;</span>
<span id="cb3-5">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> lost;</span>
<span id="cb3-6">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> time;</span>
<span id="cb3-7">  </span>
<span id="cb3-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Making Predictions</span></span>
<span id="cb3-9">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> N_pred;</span>
<span id="cb3-10">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N_pred] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> pred_times;</span>
<span id="cb3-11">}</span></code></pre></div>
</div>
</div>
<p>Later, we’ll need the last time point we observed customers who haven’t churned. This is the truncation time</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">transformed data</span>{</span>
<span id="cb4-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> truncation_time = max(time);</span>
<span id="cb4-3">}</span></code></pre></div>
</div>
</div>
<p>All that is left to do is specify parameters, write the model block, and generate predictions for our survival curve. The likelihood computations are shown in the paper I referenced, so I’ll let you read that if you’re interested</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb5-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">parameters</span>{</span>
<span id="cb5-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; alpha;</span>
<span id="cb5-3">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt; beta;</span>
<span id="cb5-4">}</span>
<span id="cb5-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">model</span>{</span>
<span id="cb5-6">  alpha ~ cauchy(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb5-7">  beta ~ cauchy(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb5-8">  </span>
<span id="cb5-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:N){</span>
<span id="cb5-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">target +=</span> lost[i] * sbg_lpdf(time[i]| alpha, beta);</span>
<span id="cb5-11">  }</span>
<span id="cb5-12">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">target +=</span> (n_total - sum(lost)) * sbg_lccdf(truncation_time| alpha, beta);</span>
<span id="cb5-13">}</span>
<span id="cb5-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">generated quantities</span>{</span>
<span id="cb5-15">  </span>
<span id="cb5-16">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[N_pred] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> expected_surviving;</span>
<span id="cb5-17">  </span>
<span id="cb5-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:N_pred){</span>
<span id="cb5-19">    expected_surviving[i] = exp(sbg_lccdf(pred_times[i]| alpha, beta));</span>
<span id="cb5-20">  }</span>
<span id="cb5-21">  </span>
<span id="cb5-22">}</span></code></pre></div>
</div>
</div>
</section>
<section id="fitting-the-model" class="level1">
<h1>Fitting the Model</h1>
<p>Fader and Hardie provide an example in their appendix for fitting the model. We’ll use that data to check our fit. Let’s take a look at that data now</p>
<div class="cell" data-fig.asp="0.6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(cmdstanr)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb6-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidybayes)</span>
<span id="cb6-4"></span>
<span id="cb6-5">stan_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb6-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">active =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">863</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">743</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">653</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">593</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">551</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">517</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">491</span>),</span>
<span id="cb6-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lost =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">131</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">126</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">34</span> ,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">26</span>),</span>
<span id="cb6-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb6-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_total =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb6-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,</span>
<span id="cb6-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pred =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>,</span>
<span id="cb6-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred_times =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>)</span>
<span id="cb6-13">)</span>
<span id="cb6-14"></span>
<span id="cb6-15"></span>
<span id="cb6-16">surv_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> stan_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">active=</span>stan_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>active) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb6-17">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(time, active)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-18">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-19">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-20">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-21">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Customers Surviving'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb6-22">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-23">              see<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_modern</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb6-24">              <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">aspect.ratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.61</span>,</span>
<span id="cb6-25">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>())</span>
<span id="cb6-26"></span>
<span id="cb6-27">surv_plot</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2023-11-02-shifted-beta-geometric/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Now, let’s compare with the fit</p>
<div class="cell" data-fig.asp="0.6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cmdstanr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdstan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sbg.stan'</span>)</span>
<span id="cb7-2"></span>
<span id="cb7-3">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(stan_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 sequential chains...

Chain 1 finished in 0.0 seconds.
Chain 2 finished in 0.0 seconds.
Chain 3 finished in 0.0 seconds.
Chain 4 finished in 0.0 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.0 seconds.
Total execution time: 0.5 seconds.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">pred_times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred_times=</span>stan_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>pred_times, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(pred_times))</span>
<span id="cb9-2">fit_predict <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> fit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-3">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spread_draws</span>(expected_surviving[i]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-4">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">expected_surviving =</span> expected_surviving <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-5">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean_qi</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb9-6">               <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(pred_times)</span>
<span id="cb9-7"></span>
<span id="cb9-8"></span>
<span id="cb9-9"></span>
<span id="cb9-10">surv_plot <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>fit_predict, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(pred_times, expected_surviving), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit.aes =</span> F, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb9-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>fit_predict, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(pred_times, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> .lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>.upper), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inherit.aes =</span> F, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2023-11-02-shifted-beta-geometric/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Nice, not a bad fit.</p>
<p>Model extensions seem fairly straight forward. You could maybe model alpha and beta much in the same way you do for a beta regression.</p>
</section>
<section id="regression" class="level1">
<h1>Regression</h1>
<p>In that same paper are two examples of survival curves; one for “high end” customers and another for “regular” customers. It should be fairly straight forward to write this as a regression model. If you’ve written a beta regression before, you can do this fairly readily.</p>
<p>Now, be warned: My approach is pretty hacky, but its just meant to illustrate a point. Here is the regression model in full</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb10-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">functions</span>{</span>
<span id="cb10-2">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sbg_lpdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> time, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> alpha, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> beta){</span>
<span id="cb10-3">    </span>
<span id="cb10-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> lbeta(alpha+<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, beta+time<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>) - lbeta(alpha, beta);</span>
<span id="cb10-5">  }</span>
<span id="cb10-6">  </span>
<span id="cb10-7">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> sbg_lccdf(<span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> time, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> alpha, <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> beta){</span>
<span id="cb10-8">    </span>
<span id="cb10-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> lbeta(alpha, beta + time) - lbeta(alpha, beta);</span>
<span id="cb10-10">  }</span>
<span id="cb10-11">  </span>
<span id="cb10-12">}</span>
<span id="cb10-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">data</span>{</span>
<span id="cb10-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Observations</span></span>
<span id="cb10-15">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n;</span>
<span id="cb10-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Predictors (2 in this case)</span></span>
<span id="cb10-17">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> p;</span>
<span id="cb10-18">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> time;</span>
<span id="cb10-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Design matrix</span></span>
<span id="cb10-20">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">matrix</span>[n, p] X;</span>
<span id="cb10-21">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> lost;</span>
<span id="cb10-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// These are the hacky bits.  I just don't want to work hard to </span></span>
<span id="cb10-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Compute these in stan, so I do them in R.</span></span>
<span id="cb10-24">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> sum_lost;</span>
<span id="cb10-25">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">int</span> n_total;</span>
<span id="cb10-26">}</span>
<span id="cb10-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">transformed data</span>{</span>
<span id="cb10-28">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> truncation_time = max(time);</span>
<span id="cb10-29">}</span>
<span id="cb10-30"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">parameters</span>{</span>
<span id="cb10-31">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[p] zeta;</span>
<span id="cb10-32">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[p] gamma;</span>
<span id="cb10-33">}</span>
<span id="cb10-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">transformed parameters</span>{</span>
<span id="cb10-35">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">upper</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>&gt;[n] mu = inv_logit(X * zeta);</span>
<span id="cb10-36">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>&lt;<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lower</span>=<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>&gt;[n] kappa = exp(X * gamma);</span>
<span id="cb10-37">  </span>
<span id="cb10-38">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">// Kind of like beta regression.</span></span>
<span id="cb10-39">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] alpha = mu./kappa;</span>
<span id="cb10-40">  <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">vector</span>[n] beta = (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>-mu)./kappa;</span>
<span id="cb10-41">}</span>
<span id="cb10-42"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">model</span>{</span>
<span id="cb10-43">  zeta ~ student_t(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb10-44">  gamma ~ student_t(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">3.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>);</span>
<span id="cb10-45">  </span>
<span id="cb10-46">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n){</span>
<span id="cb10-47">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (time[i] == truncation_time){</span>
<span id="cb10-48">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">target +=</span> lost[i] * sbg_lpdf(time[i]| alpha[i], beta[i]);</span>
<span id="cb10-49">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">target +=</span> (n_total[i] - sum_lost[i]) * sbg_lccdf(truncation_time| alpha[i], beta[i]);</span>
<span id="cb10-50">    }</span>
<span id="cb10-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>{</span>
<span id="cb10-52">      <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">target +=</span> lost[i] * sbg_lpdf(time[i]| alpha[i], beta[i]);</span>
<span id="cb10-53">    }</span>
<span id="cb10-54">  }</span>
<span id="cb10-55">}</span>
<span id="cb10-56"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">generated quantities</span>{</span>
<span id="cb10-57">   <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">array</span>[n] <span class="dt" style="color: #AD0000;
background-color: null;
font-style: inherit;">real</span> expected_surviving;</span>
<span id="cb10-58">  </span>
<span id="cb10-59">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span>(i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:n){</span>
<span id="cb10-60">    expected_surviving[i] = exp(sbg_lccdf(time[i]| alpha[i], beta[i]));</span>
<span id="cb10-61">  }</span>
<span id="cb10-62">}</span></code></pre></div>
</div>
</div>
<div class="cell" data-fig.asp="0.6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sorry for the spaghetti</span></span>
<span id="cb11-2"></span>
<span id="cb11-3">regular_surv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>( <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">631</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">468</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">382</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">326</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">289</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">262</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">241</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">223</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">207</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">194</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">183</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">173</span>)</span>
<span id="cb11-4">highend_surv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>( <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">869</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">743</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">653</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">593</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">551</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">517</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">491</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">468</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">445</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">427</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">409</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">394</span>)</span>
<span id="cb11-5"></span>
<span id="cb11-6">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb11-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Regular =</span> regular_surv,</span>
<span id="cb11-8">  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">High End</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> highend_surv,</span>
<span id="cb11-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(regular_surv)</span>
<span id="cb11-10">) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(Regular<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">High End</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, </span>
<span id="cb11-12">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'customer'</span>, </span>
<span id="cb11-13">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'surviving'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(customer) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">arrange</span>(customer) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">high_end =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(customer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'High End'</span>),</span>
<span id="cb11-17">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lost =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">if_else</span>(time <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>surviving, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lag</span>(surviving, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> surviving),</span>
<span id="cb11-18">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_total=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>,</span>
<span id="cb11-19">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sum_lost =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(lost)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-20">  ungroup <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb11-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(time))</span>
<span id="cb11-22">  </span>
<span id="cb11-23">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">model.matrix</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>high_end, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>d)</span>
<span id="cb11-24"></span>
<span id="cb11-25">stan_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb11-26">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(X),</span>
<span id="cb11-27">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(X),</span>
<span id="cb11-28">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X=</span>X,</span>
<span id="cb11-29">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_total=</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>n_total,</span>
<span id="cb11-30">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lost=</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>lost,</span>
<span id="cb11-31">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">time=</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>time,</span>
<span id="cb11-32">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sum_lost =</span> d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sum_lost</span>
<span id="cb11-33">)</span>
<span id="cb11-34"></span>
<span id="cb11-35">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> cmdstanr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cmdstan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sbg_regression.stan'</span>)</span>
<span id="cb11-36"></span>
<span id="cb11-37">chains <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>()</span>
<span id="cb11-38">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> model<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(stan_data, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parallel_chains =</span> chains, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 chains, at most 10 in parallel...

Chain 1 finished in 0.2 seconds.
Chain 2 finished in 0.2 seconds.
Chain 3 finished in 0.2 seconds.
Chain 4 finished in 0.2 seconds.

All 4 chains finished successfully.
Mean chain execution time: 0.2 seconds.
Total execution time: 0.3 seconds.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">fit <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">spread_draws</span>(expected_surviving[i]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-3">  mean_qi <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(d) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb13-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(time, surviving, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>customer)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(time, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>expected_surviving, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span>customer)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(time, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>expected_surviving, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>.lower, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>.upper, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>customer), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-9">  see<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_modern</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Customers Surviving'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb13-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-13">  see<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_modern</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">aspect.ratio =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.61</span>,</span>
<span id="cb13-15">        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">panel.grid.major =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">element_line</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Set1'</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb13-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_brewer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">palette =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Set1'</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://dpananos.github.io/posts/2023-11-02-shifted-beta-geometric/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p>Fader, Peter S., and Bruce GS Hardie. “How to project customer retention.” Journal of Interactive Marketing 21.1 (2007): 76-90.</p>


</section>

 ]]></description>
  <guid>https://dpananos.github.io/posts/2023-11-02-shifted-beta-geometric/</guid>
  <pubDate>Mon, 20 Nov 2023 05:00:00 GMT</pubDate>
</item>
</channel>
</rss>
